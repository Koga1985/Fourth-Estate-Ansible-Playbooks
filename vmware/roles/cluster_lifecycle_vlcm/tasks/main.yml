---
# Configure vLCM Desired Image (PowerCLI) and produce a compliance report.

- name: Assert required inputs
  ansible.builtin.assert:
    that:
      - vcenter_hostname | length > 0
      - vcenter_username | length > 0
      - vcenter_password | length > 0
      - cluster_name | length > 0
    fail_msg: "Set vcenter_hostname/username/password and cluster_name."

- name: Defaults
  ansible.builtin.set_fact:
    vcenter_validate_certs: "{{ vcenter_validate_certs | default(false) }}"
    run_prechecks: "{{ run_prechecks | default(true) }}"
    remediate: "{{ remediate | default(false) }}"
    compliance_report_path: "{{ compliance_report_path | default('/tmp/%s-vlcm-compliance.json' | format(cluster_name)) }}"

- name: Configure vLCM desired image, scan & report (PowerCLI)
  ansible.builtin.command:
    cmd: >-
      pwsh -NoLogo -NoProfile -NonInteractive -Command
      "$ErrorActionPreference='Stop';
       Import-Module VMware.PowerCLI -ErrorAction Stop;
       Set-PowerCLIConfiguration -InvalidCertificateAction {{ vcenter_validate_certs | ternary('Ignore','Fail') }} -Confirm:$false | Out-Null;
       $null = Connect-VIServer -Server '{{ vcenter_hostname }}' -User '{{ vcenter_username }}' -Password '{{ vcenter_password }}';

       $cluster = Get-Cluster -Name '{{ cluster_name }}' -ErrorAction Stop;

       # --- Desired Image configuration ---
       if ('{{ vlcm_desired_state_file | default('') }}' -ne '') {
         Import-LcmClusterDesiredState -Cluster $cluster -Path '{{ vlcm_desired_state_file }}' | Out-Null
       }
       elseif ({{ vlcm_image is defined | ternary('$true','$false') }}) {
         $base = if ('{{ vlcm_image.base_image_version | default('') }}' -ne '') {
           Get-LcmImage -Type BaseImage -Version '{{ vlcm_image.base_image_version | default('') }}'
         } else { $null }

         $vendor = if ('{{ vlcm_image.vendor_addon_name | default('') }}' -ne '') {
           Get-LcmImage -Type VendorAddOn | Where-Object { $_.DisplayName -like '*{{ vlcm_image.vendor_addon_name | default('') }}*' } | Select-Object -First 1
         } else { $null }

         $components = @()
         {% for comp in (vlcm_image.components | default([])) %}
         $c = Get-LcmImage -Type Component | Where-Object { $_.DisplayName -like '*{{ comp }}*' -or $_.Version -like '*{{ comp }}*' } | Select-Object -First 1;
         if ($c) { $components += $c }
         {% endfor %}

         if ($base -or $vendor -or $components.Count > 0) {
           Set-Cluster -Cluster $cluster `
             {{ vlcm_image.base_image_version is defined and vlcm_image.base_image_version|length>0 | ternary('-BaseImage $base','') }} `
             {{ vlcm_image.vendor_addon_name is defined and vlcm_image.vendor_addon_name|length>0 | ternary('-VendorAddOn $vendor','') }} `
             {{ (vlcm_image.components | default([])) | length > 0 | ternary('-Component $components','') }} `
             -Confirm:$false | Out-Null
         }
       }

       # --- Pre-checks (optional) ---
       $health = $null
       if ({{ run_prechecks | ternary('$true','$false') }}) {
         $health = Test-LcmClusterHealth -Cluster $cluster
       }

       # --- Compliance scan ---
       $comp = Test-LcmClusterCompliance -Cluster $cluster

       # --- Optional remediation ---
       $remediateResult = $null
       if ({{ remediate | ternary('$true','$false') }}) {
         $remediateResult = ($cluster | Set-Cluster -Remediate -AcceptEULA -Confirm:$false)
       }

       $report = [pscustomobject]@{
         vcenter    = '{{ vcenter_hostname }}';
         cluster    = '{{ cluster_name }}';
         precheck   = if ($health) { ($health | Select-Object -Property *) } else { $null };
         compliance = ($comp | Select-Object -Property *);
         remediated = {{ remediate | ternary('$true','$false') }};
         timestamp  = (Get-Date).ToString('s');
       };

       $json = $report | ConvertTo-Json -Depth 6;
       Set-Content -Path '{{ compliance_report_path }}' -Value $json -Encoding UTF8;
       $json"
  register: vlcm_cmd
  changed_when: true
  delegate_to: localhost

- name: Show compliance summary
  ansible.builtin.debug:
    var: vlcm_cmd.stdout

- name: Report path
  ansible.builtin.debug:
    msg: "Compliance report saved to {{ compliance_report_path }}"
