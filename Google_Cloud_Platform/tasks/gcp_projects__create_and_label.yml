---
- vars:
    artifacts_dir: "/tmp/gcp-artifacts"
    apply_changes: false
    gcloud_bin: "gcloud"
    org_id: ""
    folder_id: ""
    billing_account: ""
    labels_common: {}
  block:
  - name: Ensure artifacts directory
    ansible.builtin.file:
      path: "{{ artifacts_dir }}"
      state: directory
      mode: "0755"

- name: Plan projects create/label/budget
  ansible.builtin.copy:
    dest: "{{ artifacts_dir }}/projects_plan.json"
    mode: "0644"
    content: "{{ {'projects': projects | default([]), 'labels_common': labels_common, 'billing': billing_account} | to_nice_json }}"
- name: Apply create/link/label
  when: apply_changes | bool
  ansible.builtin.shell: |
    set -euo pipefail
    jq -c '.projects[]?' "{{ artifacts_dir }}/projects_plan.json" | while read -r p; do
      id=$(jq -r '.project_id' <<<"$p"); name=$(jq -r '.name' <<<"$p")
      fold="{{ folder_id }}"; bill="{{ billing_account }}"
      {{ gcloud_bin }} projects create "$id" --name="$name" ${fold:+--folder=$fold} || true
      {{ gcloud_bin }} beta billing projects link "$id" --billing-account "$bill"
      labels=$(jq -r '.labels // {}' <<<"$p")
      all=$(jq -n --argjson a "{{ labels_common | to_json | replace('"', '\"') }}" --argjson b "$labels" '$a + $b')
      {{ gcloud_bin }} alpha projects update "$id" --update-labels "$(jq -r 'to_entries|map("\(.key)=\(.value)")|join(",")' <<<"$all")"
    done
  args: { executable: /bin/bash }
