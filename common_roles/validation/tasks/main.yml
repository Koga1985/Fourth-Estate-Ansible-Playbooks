---
# Validation Framework - Pre-flight checks for all deployments
# Fourth Estate Infrastructure Team

- name: Display validation banner
  debug:
    msg: |
      ================================================
      Fourth Estate Infrastructure Validation
      ================================================
      Organization: {{ organization_name | default('NOT SET') }}
      Network Zone: {{ network_zone | default('NOT SET') }}
      Compliance Mode: {{ compliance_mode | default('NOT SET') }}
      ================================================

- name: Validate required variables are defined
  assert:
    that:
      - organization_name is defined
      - organization_name | length > 0
      - network_zone is defined
      - network_zone in ['trusted', 'dmz', 'isolated', 'public']
      - compliance_mode is defined
      - compliance_mode in ['nist_800_53', 'nist_800_171', 'fedramp_moderate', 'fedramp_high', 'disa_stig']
    fail_msg: |
      VALIDATION FAILED: Required variables not properly configured.

      Please check your group_vars/{{ inventory_hostname }}.yml file:
      - organization_name: Your agency/organization name
      - network_zone: Must be 'trusted', 'dmz', 'isolated', or 'public'
      - compliance_mode: Must be 'nist_800_53', 'nist_800_171', 'fedramp_moderate', 'fedramp_high', or 'disa_stig'

      See group_vars/CUSTOMER_TEMPLATE.yml for examples.
    success_msg: "✓ Required variables validated"

- name: Validate network connectivity
  wait_for:
    host: "{{ item }}"
    port: 22
    timeout: 10
  loop: "{{ groups['all'] }}"
  when:
    - validate_connectivity | default(true)
    - inventory_hostname != item
  ignore_errors: true
  register: connectivity_check

- name: Validate Ansible version
  assert:
    that:
      - ansible_version.full is version('2.10', '>=')
    fail_msg: "Ansible version {{ ansible_version.full }} is too old. Please upgrade to 2.10 or newer."
    success_msg: "✓ Ansible version {{ ansible_version.full }} is supported"

- name: Check for required Python modules
  command: python3 -c "import {{ item }}"
  loop:
    - yaml
    - jinja2
    - netaddr
  changed_when: false
  failed_when: false
  register: python_modules

- name: Validate encryption settings
  assert:
    that:
      - enable_encryption | default(true) | bool
      - tls_min_version | default('1.2') is version('1.2', '>=')
    fail_msg: "Encryption must be enabled for Fourth Estate deployments"
    success_msg: "✓ Encryption requirements validated"

- name: Validate audit logging configuration
  assert:
    that:
      - enable_audit_logging | default(true) | bool
      - audit_log_retention_days | default(365) | int >= 365
    fail_msg: "Audit logging must be enabled with minimum 365 day retention"
    success_msg: "✓ Audit logging configuration validated"

- name: Check if running in check mode
  debug:
    msg: "Running in CHECK MODE - no changes will be made"
  when: ansible_check_mode

- name: Validate vault credentials (if using Ansible Vault)
  command: ansible-vault view {{ inventory_dir }}/group_vars/vault.yml
  delegate_to: localhost
  changed_when: false
  failed_when: false
  register: vault_check
  when:
    - use_ansible_vault | default(false)
    - not ansible_check_mode

- name: Display validation summary
  debug:
    msg: |
      ================================================
      VALIDATION COMPLETE
      ================================================
      Organization: {{ organization_name }}
      Network Zone: {{ network_zone }}
      Compliance: {{ compliance_mode }}
      Encryption: {{ 'ENABLED' if enable_encryption | default(true) else 'DISABLED' }}
      Audit Logging: {{ 'ENABLED' if enable_audit_logging | default(true) else 'DISABLED' }}
      Check Mode: {{ 'YES' if ansible_check_mode else 'NO' }}
      ================================================
      Ready to proceed with deployment.
      ================================================
