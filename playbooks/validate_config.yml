---
# ==============================================================================
# CONFIGURATION VALIDATION PLAYBOOK
# ==============================================================================
#
# Purpose: Validate customer configuration before deployment
# Usage: ansible-playbook playbooks/validate_config.yml -i inventory/
#
# This playbook performs pre-flight checks to ensure:
# - All required variables are defined
# - Network connectivity is functional
# - Credentials are valid
# - Compliance requirements are met
# - No conflicts exist in configuration
#
# ==============================================================================

- name: Fourth Estate Infrastructure - Configuration Validation
  hosts: localhost
  gather_facts: false
  connection: local

  tasks:
    - name: Display validation start banner
      debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════╗
          ║                                                              ║
          ║        FOURTH ESTATE INFRASTRUCTURE AUTOMATION               ║
          ║            Configuration Validation                          ║
          ║                                                              ║
          ╚══════════════════════════════════════════════════════════════╝

    - name: Load customer variables
      include_vars:
        dir: "{{ playbook_dir }}/../group_vars"
        files_matching: "^(?!vault).*\\.yml$"
      failed_when: false

    - name: Run validation framework
      include_role:
        name: common_roles/validation

    - name: Validate Fourth Estate specific requirements
      assert:
        that:
          - organization_name is defined
          - organization_name != "CHANGE_THIS"
          - organization_domain is defined
          - organization_domain != "CHANGE_THIS.com"
          - network_zone in ['trusted', 'dmz', 'isolated', 'public']
          - compliance_mode in ['nist_800_53', 'nist_800_171', 'fedramp_moderate', 'fedramp_high', 'disa_stig']
        fail_msg: |
          ╔══════════════════════════════════════════════════════════════╗
          ║                     VALIDATION FAILED                        ║
          ╚══════════════════════════════════════════════════════════════╝

          Please update your group_vars/<organization>.yml file:

          1. Set organization_name to your actual organization name
          2. Set organization_domain to your actual domain
          3. Ensure network_zone is set correctly
          4. Ensure compliance_mode matches your requirements

          See group_vars/CUSTOMER_TEMPLATE.yml for guidance.
        success_msg: "✓ Fourth Estate requirements validated"

    - name: Validate encryption settings
      assert:
        that:
          - enable_encryption | default(true) | bool
          - tls_min_version | default('1.2') is version('1.2', '>=')
          - enable_audit_logging | default(true) | bool
          - audit_log_retention_days | default(365) | int >= 365
        fail_msg: |
          SECURITY REQUIREMENT FAILURE:
          Fourth Estate deployments must have:
          - Encryption enabled (enable_encryption: true)
          - TLS 1.2 or higher (tls_min_version: "1.2" or "1.3")
          - Audit logging enabled (enable_audit_logging: true)
          - Minimum 365-day log retention (audit_log_retention_days: 365)
        success_msg: "✓ Security requirements validated"

    - name: Check for CHANGE_THIS placeholders
      shell: |
        grep -r "CHANGE_THIS" {{ playbook_dir }}/../group_vars/ --exclude="*TEMPLATE*" --exclude="vault.yml" || true
      register: placeholder_check
      changed_when: false
      failed_when: false

    - name: Warn about remaining placeholders
      debug:
        msg: |
          ⚠️  WARNING: Found CHANGE_THIS placeholders in configuration files:
          {{ placeholder_check.stdout_lines | default([]) | join('\n') }}

          Please review your configuration files and replace all CHANGE_THIS values.
      when: placeholder_check.stdout != ""

    - name: Display validation success
      debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════╗
          ║                                                              ║
          ║              ✓ VALIDATION SUCCESSFUL                         ║
          ║                                                              ║
          ║  Your configuration is valid and ready for deployment.       ║
          ║                                                              ║
          ║  Organization: {{ organization_name }}
          ║  Network Zone: {{ network_zone }}
          ║  Compliance: {{ compliance_mode }}
          ║                                                              ║
          ║  Next steps:                                                 ║
          ║  1. Review the configuration one final time                  ║
          ║  2. Test in development/staging first                        ║
          ║  3. Run: ansible-playbook playbooks/deploy_infrastructure.yml║
          ║                                                              ║
          ╚══════════════════════════════════════════════════════════════╝
      when: placeholder_check.stdout == ""

- name: Validate Target Hosts
  hosts: all
  gather_facts: true

  tasks:
    - name: Check SSH connectivity
      ping:

    - name: Check sufficient disk space
      assert:
        that:
          - ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_available') | first > (50 * 1024 * 1024 * 1024)
        fail_msg: "Insufficient disk space. Minimum 50GB required on root filesystem."
        success_msg: "✓ Sufficient disk space available"
      when: ansible_mounts is defined

    - name: Check supported OS
      assert:
        that:
          - ansible_os_family in ['RedHat', 'Debian', 'Windows']
        fail_msg: "Unsupported operating system: {{ ansible_os_family }}"
        success_msg: "✓ Operating system supported: {{ ansible_distribution }} {{ ansible_distribution_version }}"

    - name: Summary of validated hosts
      debug:
        msg: "✓ {{ inventory_hostname }}: {{ ansible_distribution }} {{ ansible_distribution_version }} ({{ ansible_architecture }})"
