---
# ==============================================================================
# FULL INFRASTRUCTURE DEPLOYMENT PLAYBOOK
# ==============================================================================
#
# Purpose: Deploy complete Fourth Estate infrastructure
# Usage: ansible-playbook playbooks/deploy_full_infrastructure.yml -i inventory/
#
# WARNING: This playbook deploys ALL enabled components. For production:
# 1. Run validation first: ansible-playbook playbooks/validate_config.yml
# 2. Test in development: -e "environment=development"
# 3. Use check mode first: --check
# 4. Deploy incrementally in maintenance windows
#
# ==============================================================================

- name: Pre-Deployment Validation
  import_playbook: validate_config.yml

- name: Fourth Estate Infrastructure - Full Deployment
  hosts: all
  become: true
  serial: "{{ serial_batch_size | default(5) }}"

  pre_tasks:
    - name: Display deployment banner
      debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════╗
          ║        FOURTH ESTATE INFRASTRUCTURE DEPLOYMENT               ║
          ║        Organization: {{ organization_name }}                 ║
          ║        Environment: {{ environment }}                        ║
          ║        Check Mode: {{ ansible_check_mode }}                  ║
          ╚══════════════════════════════════════════════════════════════╝
      run_once: true

    - name: Create deployment tracking file
      copy:
        content: |
          Deployment Started: {{ ansible_date_time.iso8601 }}
          Organization: {{ organization_name }}
          Environment: {{ environment }}
          Ansible User: {{ ansible_user_id }}
        dest: "/var/log/fourth_estate_deployment_{{ ansible_date_time.epoch }}.log"
      delegate_to: localhost
      run_once: true

  roles:
    # Phase 1: Operating System Hardening
    - role: rhel/rhel_hardening
      when: ansible_os_family == "RedHat"
      tags: [os, hardening, rhel]

    - role: windows/windows_hardening
      when: ansible_os_family == "Windows"
      tags: [os, hardening, windows]

    # Phase 2: Security Infrastructure
    - role: hashicorp_vault/roles/vault_install
      when: vault_enabled | default(false)
      tags: [security, vault]

    # Phase 3: Database Platform
    - role: databases/postgresql/roles/postgresql_install
      when: postgresql_enabled | default(false)
      tags: [database, postgresql]

    # Phase 4: Monitoring
    - role: elk_stack/roles/elasticsearch_install
      when: elk_enabled | default(false)
      tags: [monitoring, elk]

    # Phase 5: Backup
    - role: veeam/roles/veeam_server_install
      when: veeam_enabled | default(false)
      tags: [backup, veeam]

  post_tasks:
    - name: Run compliance validation
      include_role:
        name: policy_as_code/roles/compliance_check
      when: validate_compliance | default(true)
      tags: [compliance]

    - name: Generate deployment report
      template:
        src: templates/deployment_report.j2
        dest: "/var/log/deployment_report_{{ ansible_date_time.epoch }}.html"
      delegate_to: localhost
      run_once: true

    - name: Display completion message
      debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════╗
          ║              DEPLOYMENT COMPLETE                             ║
          ║                                                              ║
          ║  Organization: {{ organization_name }}                       ║
          ║  Hosts Deployed: {{ ansible_play_hosts | length }}          ║
          ║  Deployment Time: {{ ansible_date_time.iso8601 }}           ║
          ║                                                              ║
          ║  Next Steps:                                                 ║
          ║  1. Review deployment report                                 ║
          ║  2. Run security scan                                        ║
          ║  3. Validate compliance                                      ║
          ║  4. Update documentation                                     ║
          ╚══════════════════════════════════════════════════════════════╝
      run_once: true
