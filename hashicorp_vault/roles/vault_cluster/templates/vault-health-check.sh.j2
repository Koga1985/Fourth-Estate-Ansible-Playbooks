#!/bin/bash
# Vault Cluster Health Check Script
# Generated by Ansible - DO NOT EDIT MANUALLY

set -euo pipefail

VAULT_ADDR="{{ vault_api_addr }}"
VAULT_CACERT="{{ vault_tls_ca_file }}"
LOG_FILE="{{ vault_log_path }}/health-check.log"

# Check Vault health
HEALTH_STATUS=$(curl -s -k --cacert "${VAULT_CACERT}" "${VAULT_ADDR}/v1/sys/health" || echo "FAILED")

if echo "${HEALTH_STATUS}" | grep -q "initialized"; then
    INITIALIZED=$(echo "${HEALTH_STATUS}" | jq -r '.initialized')
    SEALED=$(echo "${HEALTH_STATUS}" | jq -r '.sealed')
    STANDBY=$(echo "${HEALTH_STATUS}" | jq -r '.standby')

    echo "$(date '+%Y-%m-%d %H:%M:%S') - Vault Health: Initialized=${INITIALIZED}, Sealed=${SEALED}, Standby=${STANDBY}"

    if [ "${SEALED}" == "true" ]; then
        echo "$(date '+%Y-%m-%d %H:%M:%S') - WARNING: Vault is SEALED!"
        exit 1
    fi

    if [ "${INITIALIZED}" == "false" ]; then
        echo "$(date '+%Y-%m-%d %H:%M:%S') - WARNING: Vault is NOT initialized!"
        exit 1
    fi
else
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ERROR: Unable to reach Vault or parse health status"
    exit 1
fi

exit 0
