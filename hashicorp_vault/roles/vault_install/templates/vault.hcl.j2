# HashiCorp Vault Configuration
# Fourth Estate Production Configuration
# Generated by Ansible - DO NOT EDIT MANUALLY

# UI
ui = {{ vault_ui | lower }}

# API listener
listener "tcp" {
  address       = "{{ vault_address }}:{{ vault_port }}"
  cluster_address = "{{ vault_address }}:{{ vault_cluster_port }}"
{% if not vault_tls_disable %}
  tls_cert_file = "{{ vault_tls_cert_file }}"
  tls_key_file  = "{{ vault_tls_key_file }}"
  tls_client_ca_file = "{{ vault_tls_ca_file }}"
  tls_min_version = "{{ vault_tls_min_version }}"
{% if vault_tls_cipher_suites %}
  tls_cipher_suites = "{{ vault_tls_cipher_suites }}"
{% endif %}
  tls_require_and_verify_client_cert = {{ vault_tls_require_and_verify_client_cert | lower }}
  tls_disable_client_certs = {{ vault_tls_disable_client_certs | lower }}
{% else %}
  tls_disable = true
{% endif %}

  # Telemetry
  telemetry {
    unauthenticated_metrics_access = false
  }
}

# Storage backend
{% if vault_storage_type == 'raft' %}
storage "raft" {
  path    = "{{ vault_raft_path }}"
  node_id = "{{ vault_raft_node_id }}"

  performance_multiplier = {{ vault_raft_performance_multiplier }}
  trailing_logs = {{ vault_raft_trailing_logs }}
  snapshot_threshold = {{ vault_raft_snapshot_threshold }}
  max_entry_size = {{ vault_raft_max_entry_size }}

  autopilot_reconcile_interval = "10s"
  autopilot_update_interval = "2s"
}
{% elif vault_storage_type == 'consul' %}
storage "consul" {
  address = "{{ vault_consul_address | default('127.0.0.1:8500') }}"
  path    = "{{ vault_consul_path | default('vault/') }}"
  token   = "{{ vault_consul_token | default('') }}"
{% if vault_consul_tls_enabled | default(false) %}
  scheme  = "https"
  tls_ca_file = "{{ vault_consul_tls_ca_file }}"
  tls_cert_file = "{{ vault_consul_tls_cert_file }}"
  tls_key_file = "{{ vault_consul_tls_key_file }}"
{% endif %}
}
{% elif vault_storage_type == 'file' %}
storage "file" {
  path = "{{ vault_data_path }}/file"
}
{% endif %}

# Seal configuration
{% if vault_seal_type == 'awskms' %}
seal "awskms" {
  region     = "{{ vault_awskms_region }}"
  kms_key_id = "{{ vault_awskms_kms_key_id }}"
{% if vault_awskms_endpoint %}
  endpoint   = "{{ vault_awskms_endpoint }}"
{% endif %}
}
{% elif vault_seal_type == 'azurekeyvault' %}
seal "azurekeyvault" {
  tenant_id      = "{{ vault_azure_tenant_id }}"
  client_id      = "{{ vault_azure_client_id }}"
  client_secret  = "{{ vault_azure_client_secret }}"
  vault_name     = "{{ vault_azure_vault_name }}"
  key_name       = "{{ vault_azure_key_name }}"
}
{% elif vault_seal_type == 'gcpckms' %}
seal "gcpckms" {
  project     = "{{ vault_gcp_project }}"
  region      = "{{ vault_gcp_region }}"
  key_ring    = "{{ vault_gcp_key_ring }}"
  crypto_key  = "{{ vault_gcp_crypto_key }}"
}
{% endif %}

# Cluster configuration
api_addr      = "{{ vault_api_addr }}"
cluster_addr  = "{{ vault_cluster_addr }}"
{% if not vault_disable_clustering %}
disable_clustering = false
cluster_name = "{{ vault_cluster_name | default('vault-cluster') }}"
{% else %}
disable_clustering = true
{% endif %}

# Performance tuning
disable_mlock = {{ vault_disable_mlock | lower }}
disable_cache = {{ vault_disable_cache | lower }}
max_lease_ttl = "{{ vault_max_lease_ttl }}"
default_lease_ttl = "{{ vault_default_lease_ttl }}"

# Plugin directory
plugin_directory = "{{ vault_plugin_path }}"

# Logging
log_level = "{{ vault_log_level }}"
log_format = "{{ vault_log_format }}"

# Telemetry
telemetry {
  disable_hostname = {{ vault_telemetry_disable_hostname | lower }}
{% if vault_telemetry_enabled %}
  statsd_address = "{{ vault_telemetry_statsd_address }}"
  prometheus_retention_time = "{{ vault_prometheus_retention_time }}"
{% endif %}
}

{% if vault_enterprise and vault_enable_namespaces %}
# Namespaces (Enterprise)
enable_response_header_namespace = true
{% endif %}

{% if vault_enable_fips %}
# FIPS 140-2 mode
disable_sealwrap = false
{% endif %}

{% if vault_extra_config %}
# Additional configuration
{{ vault_extra_config | to_nice_json }}
{% endif %}
