#!/bin/bash
# HashiCorp Vault Snapshot Backup Script
# Generated by Ansible - DO NOT EDIT MANUALLY

set -euo pipefail

VAULT_ADDR="{{ vault_api_addr }}"
VAULT_CACERT="{{ vault_tls_ca_file }}"
BACKUP_DIR="{{ vault_backup_path }}"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
SNAPSHOT_FILE="${BACKUP_DIR}/vault-snapshot-${TIMESTAMP}.snap"
RETENTION_DAYS=30

# Create backup directory if it doesn't exist
mkdir -p "${BACKUP_DIR}"

# Check if Vault is initialized and unsealed
if ! {{ vault_bin_path }}/vault status > /dev/null 2>&1; then
    echo "ERROR: Vault is sealed or unreachable"
    exit 1
fi

# Create snapshot (requires Vault token)
if {{ vault_bin_path }}/vault operator raft snapshot save "${SNAPSHOT_FILE}"; then
    echo "Snapshot created successfully: ${SNAPSHOT_FILE}"

    # Compress snapshot
    gzip "${SNAPSHOT_FILE}"
    echo "Snapshot compressed: ${SNAPSHOT_FILE}.gz"

    # Set permissions
    chmod 600 "${SNAPSHOT_FILE}.gz"
    chown {{ vault_user }}:{{ vault_group }} "${SNAPSHOT_FILE}.gz"

    # Remove old snapshots
    find "${BACKUP_DIR}" -name "vault-snapshot-*.snap.gz" -mtime +${RETENTION_DAYS} -delete
    echo "Old snapshots cleaned up (retention: ${RETENTION_DAYS} days)"
else
    echo "ERROR: Failed to create snapshot"
    exit 1
fi

exit 0
