#!/bin/bash
# Vault HA Backup Script
# Generated by Ansible - DO NOT EDIT MANUALLY

set -euo pipefail

BACKUP_DIR="{{ vault_backup_path }}/ha"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)

mkdir -p "${BACKUP_DIR}"

# Backup Raft cluster configuration
{{ vault_bin_path }}/vault operator raft list-peers > "${BACKUP_DIR}/raft-peers-${TIMESTAMP}.txt"

# Backup system configuration
curl -s -k --cacert "{{ vault_tls_ca_file }}" \
    -H "X-Vault-Token: ${VAULT_TOKEN}" \
    "{{ vault_api_addr }}/v1/sys/config/state/sanitized" > "${BACKUP_DIR}/config-${TIMESTAMP}.json"

echo "$(date '+%Y-%m-%d %H:%M:%S') - HA backup completed: ${BACKUP_DIR}"

exit 0
