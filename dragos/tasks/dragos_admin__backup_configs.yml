---
- name: Ensure artifacts directory exists
  ansible.builtin.file:
    path: "{{ artifacts_dir | default('/tmp/dragos-artifacts') }}"
    state: directory
    mode: "0755"

- name: Export config snapshot
  ansible.builtin.uri:
    url: "{{ dragos_base_url }}/api/config/export"
    method: GET
    headers: { Authorization: "Bearer {{ dragos_token }}" }
    return_content: true
    status_code: 200
    validate_certs: "{{ dragos_verify_ssl | default(true) }}"
  register: _cfg

- name: Save config
  ansible.builtin.copy:
    dest: "{{ artifacts_dir | default('/tmp/dragos-artifacts') }}/config_export.json"
    mode: "0600"
    content: "{{ _cfg.content }}"
