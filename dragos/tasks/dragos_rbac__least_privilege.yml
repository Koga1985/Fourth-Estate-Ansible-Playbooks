---
- name: Ensure artifacts directory exists
  ansible.builtin.file:
    path: "{{ artifacts_dir | default('/tmp/dragos-artifacts') }}"
    state: directory
    mode: "0755"

- name: Export users/roles
  ansible.builtin.uri:
    url: "{{ dragos_base_url }}/api/admin/users"
    method: GET
    headers: { Authorization: "Bearer {{ dragos_token }}" }
    return_content: true
    status_code: 200
    validate_certs: "{{ dragos_verify_ssl | default(true) }}"
  register: _users

- name: Save violations CSV (best-effort)
  ansible.builtin.copy:
    dest: "{{ artifacts_dir | default('/tmp/dragos-artifacts') }}/rbac_violations.csv"
    mode: "0644"
    content: |
      username,roles,violation
      {% set items = (_users.json.items if _users.json.items is defined else _users.json.data | default([])) %}
      {% for u in items %}
      {% set over = (u.roles | default([])) | select('match','admin|superuser') | list %}
      {% if over | length > 0 %}
      {{ u.username | default('') }},{{ (u.roles | default([])) | join('|') }},excessive_privilege
      {% endif %}
      {% endfor %}
