---

- name: Ensure artifacts directory exists
  ansible.builtin.file:
    path: "{{ artifacts_dir | default('/tmp/dragos-artifacts') }}"
    state: directory
    mode: "0755"

- name: Pull vulnerability findings
  ansible.builtin.uri:
    url: "{{ dragos_base_url }}/api/vuln/findings?limit={{ page_size | default(500) }}"
    method: GET
    headers: { Authorization: "Bearer {{ dragos_token }}" }
    return_content: true
    status_code: 200
    validate_certs: "{{ dragos_verify_ssl | default(true) }}"
  register: _vf

- name: Save findings JSON
  ansible.builtin.copy:
    dest: "{{ artifacts_dir | default('/tmp/dragos-artifacts') }}/vuln_findings.json"
    mode: "0644"
    content: "{{ _vf.content }}"

- name: Save findings CSV
  ansible.builtin.copy:
    dest: "{{ artifacts_dir | default('/tmp/dragos-artifacts') }}/vuln_findings.csv"
    mode: "0644"
    content: |
      id,asset,cvss,risk,exploitability,status,title
      {% set items = (_vf.json.items if _vf.json.items is defined else _vf.json.data | default([])) %}
      {% for v in items %}
      {{ v.id | default('') }},{{ (v.asset.hostname or v.asset.ip) | default('') }},{{ v.cvss | default('') }},{{ v.risk | default('') }},{{ v.exploitability | default('') }},{{ v.status | default('') }},{{ v.title | default('') | replace(',', ';') }}
      {% endfor %}
