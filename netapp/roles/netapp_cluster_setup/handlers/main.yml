---
# handlers file for netapp_cluster_setup

- name: validate aggregate status
  netapp.ontap.na_ontap_info:
    hostname: "{{ netapp_cluster_hostname }}"
    username: "{{ netapp_cluster_username }}"
    password: "{{ netapp_cluster_password }}"
    https: true
    validate_certs: "{{ netapp_cluster_validate_certs }}"
    gather_subset:
      - aggregate_info
  delegate_to: localhost
  register: aggregate_status

- name: verify cluster configuration
  netapp.ontap.na_ontap_info:
    hostname: "{{ netapp_cluster_hostname }}"
    username: "{{ netapp_cluster_username }}"
    password: "{{ netapp_cluster_password }}"
    https: true
    validate_certs: "{{ netapp_cluster_validate_certs }}"
    gather_subset:
      - cluster_identity_info
      - cluster_node_info
  delegate_to: localhost

- name: restart autosupport
  netapp.ontap.na_ontap_command:
    hostname: "{{ netapp_cluster_hostname }}"
    username: "{{ netapp_cluster_username }}"
    password: "{{ netapp_cluster_password }}"
    https: true
    validate_certs: "{{ netapp_cluster_validate_certs }}"
    command: ['system', 'node', 'autosupport', 'invoke', '-node', '*', '-type', 'test']
  delegate_to: localhost
  changed_when: true
