---
# Infoblox Enterprise Deployment Playbook
# Entry point for comprehensive Infoblox DDI automation
#
# Usage:
#   ansible-galaxy collection install -r requirements.yml
#   ansible-playbook -i inventory site.yml --ask-vault-pass

- name: Infoblox Enterprise Configuration
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    deploy_grid: true
    deploy_dns: true
    deploy_dnssec: true
    deploy_dhcp: true
    deploy_rpz: true
    deploy_upgrade: false
    deploy_compliance: true
    deploy_capacity: true

  tasks:
    # =========================================
    # Phase 1: Grid Configuration
    # =========================================
    - name: Phase 1 - Grid Bootstrap
      ansible.builtin.include_role:
        name: infoblox_grid_bootstrap
      when: deploy_grid | bool
      tags: ['grid', 'phase1']

    - name: Phase 1 - Inventory Model
      ansible.builtin.include_role:
        name: infoblox_inventory_model
      when: deploy_grid | bool
      tags: ['grid', 'inventory', 'phase1']

    # =========================================
    # Phase 2: DNS Configuration
    # =========================================
    - name: Phase 2 - DNS Views & Zones
      ansible.builtin.include_role:
        name: infoblox_dns_views_zones
      when: deploy_dns | bool
      tags: ['dns', 'phase2']

    - name: Phase 2 - DNS Records
      ansible.builtin.include_role:
        name: infoblox_dns_records
      when: deploy_dns | bool
      tags: ['dns', 'phase2']

    - name: Phase 2 - DNSSEC
      ansible.builtin.include_role:
        name: infoblox_dnssec
      when: deploy_dnssec | bool
      tags: ['dns', 'dnssec', 'phase2']

    # =========================================
    # Phase 3: DHCP Configuration
    # =========================================
    - name: Phase 3 - DHCP Failover
      ansible.builtin.include_role:
        name: infoblox_dhcp_failover
      when: deploy_dhcp | bool
      tags: ['dhcp', 'phase3']

    # =========================================
    # Phase 4: Security
    # =========================================
    - name: Phase 4 - RPZ Policies
      ansible.builtin.include_role:
        name: infoblox_rpz_policies
      when: deploy_rpz | bool
      tags: ['security', 'rpz', 'phase4']

    # =========================================
    # Phase 5: Operations
    # =========================================
    - name: Phase 5 - Grid Upgrade
      ansible.builtin.include_role:
        name: infoblox_grid_upgrade
      when: deploy_upgrade | bool
      tags: ['upgrade', 'phase5']

    - name: Phase 5 - Capacity Reports
      ansible.builtin.include_role:
        name: infoblox_capacity_reports
      when: deploy_capacity | bool
      tags: ['capacity', 'phase5']

    # =========================================
    # Phase 6: Compliance
    # =========================================
    - name: Phase 6 - Audit Compliance
      ansible.builtin.include_role:
        name: infoblox_audit_compliance
      when: deploy_compliance | bool
      tags: ['compliance', 'phase6']

    - name: Display summary
      ansible.builtin.debug:
        msg:
          - "=== Infoblox Enterprise Deployment Complete ==="
          - "Grid: {{ nios_grid_name | default('Production-Grid') }}"
          - "DNSSEC: {{ 'Enabled' if deploy_dnssec else 'Disabled' }}"
          - "RPZ: {{ 'Enabled' if deploy_rpz else 'Disabled' }}"
      tags: ['always']
