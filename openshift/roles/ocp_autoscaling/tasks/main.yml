---

- name: Ensure artifacts directory exists
  ansible.builtin.file:
    path: "{{ artifacts_dir }}"
    state: directory
    mode: "0755"


- name: Ensure ClusterAutoscaler
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: autoscaling.openshift.io/v1
      kind: ClusterAutoscaler
      metadata: { name: default }
      spec: "{{ cluster_autoscaler | default({}) }}"

- name: Ensure MachineAutoscalers
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition: "{{ item if item.apiVersion is defined else ({'apiVersion':'autoscaling.openshift.io/v1','kind':'MachineAutoscaler','metadata':{'name': item.name, 'namespace': item.namespace | default('openshift-machine-api')},'spec': item.spec}) }}"
  loop: "{{ machine_autoscalers }}"
  loop_control: { label: "{{ (item.metadata.name if item.metadata is defined else item.name) | default('ma') }}" }

