---

- name: Ensure artifacts directory exists
  ansible.builtin.file:
    path: "{{ artifacts_dir }}"
    state: directory
    mode: "0755"


- name: Ensure SCC RoleBindings
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: RoleBinding
      metadata:
        name: "use-{{ item.scc }}"
        namespace: "{{ item.namespace }}"
      subjects:
        - kind: ServiceAccount
          name: "{{ item.sa }}"
          namespace: "{{ item.namespace }}"
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: "system:openshift:scc:{{ item.scc }}"
  loop: "{{ scc_bindings }}"
  loop_control: { label: "{{ item.namespace }}:{{ item.sa }}" }

- name: Write SCC drift CSV (placeholder)
  ansible.builtin.copy:
    dest: "{{ report_path }}"
    mode: "0644"
    content: "namespace,serviceaccount,scc,compliant\n"

