---
# Publish and install the Access policy package so HTTPS layer is active.
# Vars:
#   policy_package: "Standard"
#   install_targets: ["gw1","gw2"]
#   parallel_batches: 1

- name: Publish session
  check_point.mgmt.cp_mgmt_publish:

- name: Defaults
  ansible.builtin.set_fact:
    _pkg: "{{ policy_package | default('Standard') }}"
    _targets: "{{ install_targets | default([]) }}"
    _batch: "{{ parallel_batches | default(1) | int }}"

- name: Require install targets
  ansible.builtin.assert:
    that: [ _targets | length > 0 ]

- name: Compute batches
  ansible.builtin.set_fact:
    _target_batches: >-
      {% set out = [] %}
      {% for i in range(0, (_targets | length), _batch) %}
      {% set _ = out.append(_targets[i:(i+_batch)]) %}
      {% endfor %}
      {{ out }}

- name: Install policy (includes HTTPS layer)
  check_point.mgmt.cp_mgmt_install_policy:
    policy_package: "{{ _pkg }}"
    targets: "{{ item }}"
    access: true
    threat_prevention: false
    install_on_all_cluster_members_or_fail: true
    evaluate_policy: true
  loop: "{{ _target_batches }}"
  loop_control: { label: "{{ item | join(',') }}" }
