
- name: Ensure groups (metadata)
  check_point.mgmt.cp_mgmt_group:
    state: present
    name: "{{ item.name }}"
    color: "{{ item.color | default(omit) }}"
    comments: "{{ item.comment | default(omit) }}"
  loop: "{{ cp_groups | default([]) }}"
- name: Fetch members
  check_point.mgmt.cp_mgmt_show_group:
    name: "{{ item.name }}"
  register: _grp_show
  loop: "{{ cp_groups | default([]) }}"
- name: Build map
  ansible.builtin.set_fact:
    _grp_current_map: "{{ dict(_grp_show.results | map(attribute='item.name') | list
                              | zip(_grp_show.results | map(attribute='object.members') | list)) }}"
- name: Set members
  vars:
    desired: "{{ item.members | default([]) }}"
    current: "{{ _grp_current_map[item.name] | default([]) }}"
    new_members: "{{ desired }}"
  check_point.mgmt.cp_mgmt_group:
    state: present
    name: "{{ item.name }}"
    members: "{{ new_members }}"
  loop: "{{ cp_groups | default([]) }}"
