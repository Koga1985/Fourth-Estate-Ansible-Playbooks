---
# Create/Update L4 services (TCP/UDP).
# Fourth Estate: All custom services must be documented and justified
# Vars:
#   cp_services_tcp:
#     - name: http-8080
#       port: 8080
#       session_timeout: 3600   # optional (seconds)
#       match_for_any: false    # optional
#       color: blue
#       comment: "HTTP-alt"
#   cp_services_udp:
#     - name: syslog-514
#       port: 514
#       session_timeout: 600
#       color: yellow
#       comment: "Syslog"

- name: Fourth Estate - validate TCP service definitions
  ansible.builtin.assert:
    that:
      - item.name is defined
      - item.port is defined
      - item.port | int >= 1
      - item.port | int <= 65535
    fail_msg: "TCP service '{{ item.name | default('UNDEFINED') }}' has invalid port definition"
    success_msg: "TCP service '{{ item.name }}' validated"
  loop: "{{ cp_services_tcp | default([]) }}"
  loop_control:
    label: "{{ item.name | default('UNNAMED') }}"
  when: cp_services_tcp is defined and cp_services_tcp | length > 0

- name: Fourth Estate - validate UDP service definitions
  ansible.builtin.assert:
    that:
      - item.name is defined
      - item.port is defined
      - item.port | int >= 1
      - item.port | int <= 65535
    fail_msg: "UDP service '{{ item.name | default('UNDEFINED') }}' has invalid port definition"
    success_msg: "UDP service '{{ item.name }}' validated"
  loop: "{{ cp_services_udp | default([]) }}"
  loop_control:
    label: "{{ item.name | default('UNNAMED') }}"
  when: cp_services_udp is defined and cp_services_udp | length > 0

- name: Create/Update TCP services
  when: (cp_services_tcp | default([])) | length > 0
  check_point.mgmt.cp_mgmt_service_tcp:
    state: present
    name: "{{ item.name }}"
    port: "{{ item.port }}"
    session_timeout: "{{ item.session_timeout | default(omit) }}"
    match_for_any: "{{ item.match_for_any | default(omit) }}"
    color: "{{ item.color | default('black') }}"
    comments: "{{ item.comment | default('Fourth Estate Service Catalog - Managed by Ansible') }}"
  loop: "{{ cp_services_tcp | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  register: tcp_creation

- name: Create/Update UDP services
  when: (cp_services_udp | default([])) | length > 0
  check_point.mgmt.cp_mgmt_service_udp:
    state: present
    name: "{{ item.name }}"
    port: "{{ item.port }}"
    session_timeout: "{{ item.session_timeout | default(omit) }}"
    match_for_any: "{{ item.match_for_any | default(omit) }}"
    color: "{{ item.color | default('black') }}"
    comments: "{{ item.comment | default('Fourth Estate Service Catalog - Managed by Ansible') }}"
  loop: "{{ cp_services_udp | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  register: udp_creation

- name: Log service creation summary
  ansible.builtin.debug:
    msg:
      - "Created/updated {{ cp_services_tcp | default([]) | length }} TCP services"
      - "Created/updated {{ cp_services_udp | default([]) | length }} UDP services"
      - "Total custom services: {{ (cp_services_tcp | default([]) | length) + (cp_services_udp | default([]) | length) }}"
