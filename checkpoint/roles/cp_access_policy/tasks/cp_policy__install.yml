---
# Install policy package to targets. Supports serial/parallel batches.
# Fourth Estate: Policy installation must be verified and logged
# Vars:
#   policy_package: "Standard"
#   install_targets: ["gw1","gw2","gw3"]
#   parallel_batches: 2         # install N gateways at a time (default 1 = serial)
#   access: true|false          # install Network layer (default: true)
#   threat_prevention: true|false   # install TP layer (default: true)

- name: Defaults
  ansible.builtin.set_fact:
    _pkg: "{{ policy_package | default('Standard') }}"
    _targets: "{{ install_targets | default([]) }}"
    _batch: "{{ parallel_batches | default(1) | int }}"
    _access: "{{ access | default(true) | bool }}"
    _tp: "{{ threat_prevention | default(true) | bool }}"
    _art_dir: "{{ artifacts_dir | default('/tmp/checkpoint-artifacts') }}"

- name: Fail if no targets
  ansible.builtin.assert:
    that: [ _targets | length > 0 ]
    fail_msg: "No install_targets provided."

- name: Fourth Estate - verify policy package exists
  check_point.mgmt.cp_mgmt_show_package:
    name: "{{ _pkg }}"
  register: package_verify

- name: Compute batches
  ansible.builtin.set_fact:
    _target_batches: >-
      {% set out = [] %}
      {% for i in range(0, (_targets | length), _batch) %}
      {% set _ = out.append(_targets[i:(i+_batch)]) %}
      {% endfor %}
      {{ out }}

- name: Pre-installation notification
  ansible.builtin.debug:
    msg:
      - "Installing policy package: {{ _pkg }}"
      - "Target gateways: {{ _targets | join(', ') }}"
      - "Access policy: {{ _access }}"
      - "Threat Prevention policy: {{ _tp }}"
      - "Installation batches: {{ _target_batches | length }}"
      - "Batch size: {{ _batch }}"

- name: Install policy (batch loop)
  check_point.mgmt.cp_mgmt_install_policy:
    policy_package: "{{ _pkg }}"
    targets: "{{ item }}"
    access: "{{ _access }}"
    threat_prevention: "{{ _tp }}"
    install_on_all_cluster_members_or_fail: true
    evaluate_policy: true
  loop: "{{ _target_batches }}"
  loop_control: { label: "{{ item | join(',') }}" }
  register: install_results

- name: Wait for policy installation to complete
  ansible.builtin.pause:
    seconds: 10
    prompt: "Waiting for policy installation to settle on all gateways..."

- name: Verify policy installation status
  check_point.mgmt.cp_mgmt_show_gateways_and_servers:
    filter: "{{ target_item }}"
  loop: "{{ _targets }}"
  loop_control:
    loop_var: target_item
    label: "{{ target_item }}"
  register: gateway_status

- name: Generate policy installation audit log
  ansible.builtin.copy:
    dest: "{{ _art_dir }}/policy_installation_{{ ansible_date_time.epoch }}.log"
    mode: "0640"
    content: |
      ==========================================================================
                    CHECK POINT POLICY INSTALLATION LOG
                         Fourth Estate Compliance Record
      ==========================================================================

      Installation Date: {{ ansible_date_time.iso8601 }}
      Operator: {{ ansible_user_id }}
      Policy Package: {{ _pkg }}
      Access Policy: {{ 'Installed' if _access else 'Not Installed' }}
      Threat Prevention Policy: {{ 'Installed' if _tp else 'Not Installed' }}

      TARGET GATEWAYS
      ---------------
      {% for target in _targets %}
      - {{ target }}
      {% endfor %}

      INSTALLATION RESULTS
      --------------------
      {% for result in install_results.results %}
      Batch: {{ result.item | join(', ') }}
      Status: {{ 'SUCCESS' if not result.failed else 'FAILED' }}
      {% if result.task_details is defined %}
      Task ID: {{ result.task_details.task_id | default('N/A') }}
      {% endif %}

      {% endfor %}

      VERIFICATION
      ------------
      {% for gw in gateway_status.results %}
      Gateway: {{ gw.target_item }}
      Status: {{ 'Verified' if not gw.failed else 'Check Required' }}
      {% endfor %}

      COMPLIANCE VERIFICATION
      -----------------------
      [X] Policy package verified before installation
      [X] All cluster members included in installation
      [X] Policy evaluation completed
      [X] Installation status verified
      [X] Audit log generated

      APPROVALS
      ---------
      Change Control Number: _______________
      Security Team Approval: _____________________________ Date: _______
      Network Team Approval: ______________________________ Date: _______

      ==========================================================================
  delegate_to: localhost

- name: Display installation summary
  ansible.builtin.debug:
    msg:
      - "Policy installation completed"
      - "Package: {{ _pkg }}"
      - "Targets: {{ _targets | join(', ') }}"
      - "Audit log: {{ _art_dir }}/policy_installation_{{ ansible_date_time.epoch }}.log"
