
- name: Ensure artifacts dir
  ansible.builtin.file: { path: "{{ artifacts_dir | default('/tmp/pure-artifacts') }}", state: directory, mode: "0755" }
- name: Request support bundle generation
  ansible.builtin.uri:
    url: "{{ fb_url }}/api/1.12/support/bundle"
    method: POST
    headers: { api-token: "{{ fb_token }}", Content-Type: "application/json" }
    body_format: json
    body: { level: "full" }
    status_code: [200,202]
    validate_certs: "{{ fb_validate_certs | default(false) }}"
  register: _bundle_req
- name: Download support bundle (poll until available)
  ansible.builtin.get_url:
    url: "{{ fb_url }}/api/1.12/support/bundle/{{ _bundle_req.json.id | default('latest') }}"
    headers: { api-token: "{{ fb_token }}" }
    dest: "{{ artifacts_dir | default('/tmp/pure-artifacts') }}/fb_support_bundle.tgz"
    validate_certs: "{{ fb_validate_certs | default(false) }}"
  register: _bundle_dl
  until: _bundle_dl is succeeded
  retries: 10
  delay: 15
