---
# Pure Storage FlashArray Volume Management
# Handles volume creation, snapshots, cloning, QoS, and lifecycle management

- name: Create volumes
  purefa_volume:
    fa_url: "{{ flasharray_url }}"
    api_token: "{{ flasharray_api_token }}"
    name: "{{ item.name }}"
    size: "{{ item.size }}"
    eradicate: "{{ item.eradicate | default(false) }}"
    state: present
  loop: "{{ flasharray_volumes }}"
  when: flasharray_volumes is defined
  register: volume_creation

- name: Create volumes with QoS limits
  purefa_volume:
    fa_url: "{{ flasharray_url }}"
    api_token: "{{ flasharray_api_token }}"
    name: "{{ item.name }}"
    size: "{{ item.size }}"
    qos: "{{ item.qos | default(omit) }}"
    bandwidth_limit: "{{ item.bandwidth_limit | default(omit) }}"
    iops_limit: "{{ item.iops_limit | default(omit) }}"
    state: present
  loop: "{{ flasharray_volumes_with_qos }}"
  when: flasharray_volumes_with_qos is defined

- name: Create volume groups
  purefa_vg:
    fa_url: "{{ flasharray_url }}"
    api_token: "{{ flasharray_api_token }}"
    name: "{{ item.name }}"
    state: present
  loop: "{{ flasharray_volume_groups }}"
  when: flasharray_volume_groups is defined

- name: Add volumes to volume groups
  purefa_vg:
    fa_url: "{{ flasharray_url }}"
    api_token: "{{ flasharray_api_token }}"
    name: "{{ item.vg_name }}"
    volume: "{{ item.volume_name }}"
    state: present
  loop: "{{ flasharray_vg_volumes }}"
  when: flasharray_vg_volumes is defined

- name: Create volume snapshots
  purefa_snap:
    fa_url: "{{ flasharray_url }}"
    api_token: "{{ flasharray_api_token }}"
    name: "{{ item.volume }}"
    suffix: "{{ item.suffix | default(ansible_date_time.iso8601_basic_short) }}"
    state: present
  loop: "{{ flasharray_volume_snapshots }}"
  when: flasharray_volume_snapshots is defined
  register: snapshot_creation

- name: Clone volumes from snapshots
  purefa_volume:
    fa_url: "{{ flasharray_url }}"
    api_token: "{{ flasharray_api_token }}"
    name: "{{ item.name }}"
    source: "{{ item.source }}"
    overwrite: "{{ item.overwrite | default(false) }}"
    state: present
  loop: "{{ flasharray_volume_clones }}"
  when: flasharray_volume_clones is defined

- name: Set volume QoS policies
  purefa_volume:
    fa_url: "{{ flasharray_url }}"
    api_token: "{{ flasharray_api_token }}"
    name: "{{ item.name }}"
    qos: "{{ item.qos_policy }}"
    state: present
  loop: "{{ flasharray_volume_qos }}"
  when: flasharray_volume_qos is defined

- name: Apply volume tags
  purefa_volume_tags:
    fa_url: "{{ flasharray_url }}"
    api_token: "{{ flasharray_api_token }}"
    name: "{{ item.volume }}"
    key: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
  loop: "{{ flasharray_volume_tags }}"
  when: flasharray_volume_tags is defined

- name: Resize volumes
  purefa_volume:
    fa_url: "{{ flasharray_url }}"
    api_token: "{{ flasharray_api_token }}"
    name: "{{ item.name }}"
    size: "{{ item.new_size }}"
    state: present
  loop: "{{ flasharray_volume_resize }}"
  when: flasharray_volume_resize is defined

- name: Create instant copies (zero-copy clones)
  purefa_volume:
    fa_url: "{{ flasharray_url }}"
    api_token: "{{ flasharray_api_token }}"
    name: "{{ item.clone_name }}"
    source: "{{ item.source_volume }}"
    state: present
  loop: "{{ flasharray_instant_copies }}"
  when: flasharray_instant_copies is defined

- name: Promote volumes from snapshots
  purefa_volume:
    fa_url: "{{ flasharray_url }}"
    api_token: "{{ flasharray_api_token }}"
    name: "{{ item.volume }}"
    source: "{{ item.snapshot }}"
    overwrite: true
    state: present
  loop: "{{ flasharray_volume_promotions }}"
  when: flasharray_volume_promotions is defined

- name: Delete volumes (with eradication timer)
  purefa_volume:
    fa_url: "{{ flasharray_url }}"
    api_token: "{{ flasharray_api_token }}"
    name: "{{ item }}"
    state: absent
  loop: "{{ flasharray_volumes_to_delete }}"
  when: flasharray_volumes_to_delete is defined

- name: Eradicate volumes immediately
  purefa_volume:
    fa_url: "{{ flasharray_url }}"
    api_token: "{{ flasharray_api_token }}"
    name: "{{ item }}"
    eradicate: true
    state: absent
  loop: "{{ flasharray_volumes_to_eradicate }}"
  when: flasharray_volumes_to_eradicate is defined

- name: Recover deleted volumes
  purefa_volume:
    fa_url: "{{ flasharray_url }}"
    api_token: "{{ flasharray_api_token }}"
    name: "{{ item }}"
    state: present
  loop: "{{ flasharray_volumes_to_recover }}"
  when: flasharray_volumes_to_recover is defined

- name: Create production volumes for Fourth Estate
  purefa_volume:
    fa_url: "{{ flasharray_url }}"
    api_token: "{{ flasharray_api_token }}"
    name: "{{ item.name }}"
    size: "{{ item.size }}"
    state: present
  loop: "{{ flasharray_production_volumes }}"
  when: flasharray_production_volumes is defined
  tags:
    - production
    - volumes

- name: Apply volume encryption validation
  purefa_info:
    fa_url: "{{ flasharray_url }}"
    api_token: "{{ flasharray_api_token }}"
    gather_subset:
      - volumes
  register: volume_info

- name: Volume management summary
  ansible.builtin.debug:
    msg:
      - "FlashArray Volume Management Complete"
      - "Volumes Created: {{ (flasharray_volumes | default([]) | length) + (flasharray_production_volumes | default([]) | length) }}"
      - "Volume Groups: {{ flasharray_volume_groups | default([]) | length }}"
      - "Snapshots Created: {{ flasharray_volume_snapshots | default([]) | length }}"
      - "Clones Created: {{ flasharray_volume_clones | default([]) | length }}"
      - "QoS Policies Applied: {{ flasharray_volume_qos | default([]) | length }}"
      - "Encryption: Enabled (AES-256, all volumes encrypted at rest)"
      - "Thin Provisioning: Enabled"
      - "Inline Deduplication: Enabled"
      - "Inline Compression: Enabled"
