---
# Purpose: Install/Update Pure CSI driver secret(s) and StorageClasses.
# Example vars:
# csi:
#   namespace: "pure-csi"
#   fa_management_endpoint: "10.0.0.10"
#   api_token: "{{ lookup('env','PURE_FA_TOKEN') }}"
#   storageclasses:
#     - name: pure-rwo
#       backend: "block"                # block | file (if using FB)
#       reclaimPolicy: "Delete"
#       allowVolumeExpansion: true
#       parameters:
#         csi.storage.k8s.io/fstype: "xfs"
#         bandwidth_limit: "200M"
#         iops_limit: "15000"
#
- name: Ensure namespace exists
  kubernetes.core.k8s:
    state: present
    kind: Namespace
    name: "{{ csi.namespace | default('pure-csi') }}"

- name: Create/Update CSI secret (FlashArray)
  kubernetes.core.k8s:
    state: present
    namespace: "{{ csi.namespace | default('pure-csi') }}"
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: pure-fa-secret
      type: Opaque
      stringData:
        managementEndpoint: "{{ csi.fa_management_endpoint }}"
        apiToken: "{{ csi.api_token }}"
        # add additional keys as required by your CSI chart/version

- name: Create/Update StorageClasses
  kubernetes.core.k8s:
    state: present
    definition: |
      apiVersion: storage.k8s.io/v1
      kind: StorageClass
      metadata:
        name: {{ item.name }}
        annotations:
          storageclass.kubernetes.io/is-default-class: "{{ 'true' if item.default | default(false) else 'false' }}"
      provisioner: pure-csi
      reclaimPolicy: {{ item.reclaimPolicy | default('Delete') }}
      allowVolumeExpansion: {{ item.allowVolumeExpansion | default(true) | to_json }}
      parameters: {{ (item.parameters | default({})) | to_nice_json }}
  loop: "{{ csi.storageclasses | default([]) }}"
  loop_control: { label: "{{ item.name }}" }
