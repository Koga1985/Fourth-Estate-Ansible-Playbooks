---
# Functional test playbook for Splunk installation
# Usage: ansible-playbook -i inventory splunk/playbooks/tests/test_installation.yml

- name: Test Splunk Installation
  hosts: splunk_servers
  become: yes
  vars:
    splunk_home: "/opt/splunk"
    splunk_user: "splunk"

  tasks:
    - name: Test - Verify Splunk binary exists
      ansible.builtin.stat:
        path: "{{ splunk_home }}/bin/splunk"
      register: splunk_binary
      failed_when: not splunk_binary.stat.exists

    - name: Test - Verify Splunk user exists
      ansible.builtin.user:
        name: "{{ splunk_user }}"
        state: present
      check_mode: yes
      register: user_check
      failed_when: user_check.changed

    - name: Test - Verify Splunk service is running
      ansible.builtin.systemd:
        name: Splunkd
        state: started
      check_mode: yes
      register: service_check

    - name: Test - Verify web port is listening
      ansible.builtin.wait_for:
        port: 8000
        timeout: 10
      register: web_port_check

    - name: Test - Verify management port is listening
      ansible.builtin.wait_for:
        port: 8089
        timeout: 10
      register: mgmt_port_check

    - name: Test - Verify Splunk responds to API
      ansible.builtin.uri:
        url: "https://localhost:8089/services/server/info"
        method: GET
        user: admin
        password: "{{ splunk_admin_password }}"
        force_basic_auth: yes
        validate_certs: no
        status_code: 200
      register: api_check
      no_log: true

    - name: Test - Verify FIPS mode configuration
      ansible.builtin.shell: "{{ splunk_home }}/bin/splunk btool server list fips | grep 'fipsMode = strict'"
      become_user: "{{ splunk_user }}"
      register: fips_check
      changed_when: false
      failed_when: fips_check.rc != 0

    - name: Test - Verify TLS configuration
      ansible.builtin.shell: "{{ splunk_home }}/bin/splunk btool server list sslConfig | grep 'sslVersions.*tls1.2'"
      become_user: "{{ splunk_user }}"
      register: tls_check
      changed_when: false
      failed_when: tls_check.rc != 0

    - name: Test - Verify audit logging is enabled
      ansible.builtin.shell: "{{ splunk_home }}/bin/splunk btool audit list | grep 'enableAuditTrail = true'"
      become_user: "{{ splunk_user }}"
      register: audit_check
      changed_when: false
      failed_when: audit_check.rc != 0

    - name: Test - Verify file permissions are secure
      ansible.builtin.shell: |
        ls -la {{ splunk_home }}/etc/system/local/*.conf | awk '{print $1}' | grep -v '^-rw-------'
      register: perms_check
      changed_when: false
      failed_when: perms_check.stdout != ""

    - name: Test Results Summary
      ansible.builtin.debug:
        msg:
          - "=== Splunk Installation Test Results ==="
          - "Host: {{ inventory_hostname }}"
          - "Binary: {{ 'PASS' if splunk_binary.stat.exists else 'FAIL' }}"
          - "User: {{ 'PASS' if not user_check.changed else 'FAIL' }}"
          - "Service: {{ 'PASS' if service_check.status.ActiveState == 'active' else 'FAIL' }}"
          - "Web Port: {{ 'PASS' if web_port_check is success else 'FAIL' }}"
          - "API: {{ 'PASS' if api_check.status == 200 else 'FAIL' }}"
          - "FIPS: {{ 'PASS' if fips_check.rc == 0 else 'FAIL' }}"
          - "TLS: {{ 'PASS' if tls_check.rc == 0 else 'FAIL' }}"
          - "Audit: {{ 'PASS' if audit_check.rc == 0 else 'FAIL' }}"
          - "Permissions: {{ 'PASS' if perms_check.stdout == '' else 'FAIL' }}"
          - "========================================"
          - "Overall: ALL TESTS PASSED"
