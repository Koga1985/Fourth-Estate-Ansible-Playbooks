---
# Cluster configuration tasks for VAST

- name: Configure cluster name
  ansible.builtin.uri:
    url: "https://{{ vast_mgmt_host }}:{{ vast_mgmt_port }}/api/{{ vast_api_version }}/clusters/{{ vast_cluster_id }}"
    method: PATCH
    user: "{{ vast_mgmt_user }}"
    password: "{{ vast_mgmt_password }}"
    force_basic_auth: true
    validate_certs: "{{ vast_verify_ssl }}"
    body_format: json
    body:
      name: "{{ vast_cluster_name }}"
    status_code: [200, 204]
  delegate_to: localhost
  when: vast_cluster_id is defined and vast_cluster_id != ''
  tags:
    - cluster_name

- name: Configure cluster timezone
  ansible.builtin.uri:
    url: "https://{{ vast_mgmt_host }}:{{ vast_mgmt_port }}/api/{{ vast_api_version }}/clusters/{{ vast_cluster_id }}"
    method: PATCH
    user: "{{ vast_mgmt_user }}"
    password: "{{ vast_mgmt_password }}"
    force_basic_auth: true
    validate_certs: "{{ vast_verify_ssl }}"
    body_format: json
    body:
      timezone: "{{ vast_cluster_timezone }}"
    status_code: [200, 204]
  delegate_to: localhost
  when: vast_cluster_id is defined and vast_cluster_id != ''
  tags:
    - cluster_timezone

- name: Enable FIPS mode (DoD Requirement)
  ansible.builtin.uri:
    url: "https://{{ vast_mgmt_host }}:{{ vast_mgmt_port }}/api/{{ vast_api_version }}/clusters/{{ vast_cluster_id }}/security"
    method: PATCH
    user: "{{ vast_mgmt_user }}"
    password: "{{ vast_mgmt_password }}"
    force_basic_auth: true
    validate_certs: "{{ vast_verify_ssl }}"
    body_format: json
    body:
      fips_mode: "{{ vast_fips_mode_enabled }}"
    status_code: [200, 204]
  delegate_to: localhost
  when:
    - vast_cluster_id is defined and vast_cluster_id != ''
    - vast_fips_mode_enabled | bool
  tags:
    - fips
    - security

- name: Configure minimum TLS version (NIST 800-52r2)
  ansible.builtin.uri:
    url: "https://{{ vast_mgmt_host }}:{{ vast_mgmt_port }}/api/{{ vast_api_version }}/clusters/{{ vast_cluster_id }}/security"
    method: PATCH
    user: "{{ vast_mgmt_user }}"
    password: "{{ vast_mgmt_password }}"
    force_basic_auth: true
    validate_certs: "{{ vast_verify_ssl }}"
    body_format: json
    body:
      min_tls_version: "{{ vast_tls_min_version }}"
    status_code: [200, 204]
  delegate_to: localhost
  when: vast_cluster_id is defined and vast_cluster_id != ''
  tags:
    - tls
    - security

- name: Enable high availability
  ansible.builtin.uri:
    url: "https://{{ vast_mgmt_host }}:{{ vast_mgmt_port }}/api/{{ vast_api_version }}/clusters/{{ vast_cluster_id }}"
    method: PATCH
    user: "{{ vast_mgmt_user }}"
    password: "{{ vast_mgmt_password }}"
    force_basic_auth: true
    validate_certs: "{{ vast_verify_ssl }}"
    body_format: json
    body:
      ha_enabled: "{{ vast_enable_ha }}"
    status_code: [200, 204]
  delegate_to: localhost
  when:
    - vast_cluster_id is defined and vast_cluster_id != ''
    - vast_enable_ha | bool
  tags:
    - ha
