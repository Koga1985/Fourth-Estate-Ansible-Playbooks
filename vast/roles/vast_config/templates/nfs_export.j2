#!/bin/bash
# NFS Export Configuration Template for VAST Data
# Generated by Ansible for Fourth Estate

# Export: {{ item.path }}
# Client Rules:
{% for rule in item.client_rules %}
# - Clients: {{ rule.clients }}
# - Access: {{ rule.access }}
# - Squash: {{ rule.squash }}
# - Security: {{ rule.security }}
{% endfor %}

cat <<'EOF' | curl -X POST \
  -H "Content-Type: application/json" \
  -u "{{ vast_mgmt_user }}:{{ vast_mgmt_password }}" \
  "https://{{ vast_mgmt_host }}:{{ vast_mgmt_port }}/api/{{ vast_api_version }}/nfs/exports" \
  -d @-
{
  "path": "{{ item.path }}",
  "enabled": {{ item.enabled | lower }},
  "client_rules": [
    {% for rule in item.client_rules %}
    {
      "clients": "{{ rule.clients }}",
      "access": "{{ rule.access }}",
      "squash": "{{ rule.squash }}",
      "security": "{{ rule.security }}"
    }{{ "," if not loop.last else "" }}
    {% endfor %}
  ]
}
EOF
