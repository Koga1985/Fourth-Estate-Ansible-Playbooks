---
# Replication configuration tasks

- name: Verify DR cluster connectivity
  ansible.builtin.uri:
    url: "https://{{ vast_replication_target_cluster }}:{{ vast_mgmt_port }}/api/{{ vast_api_version }}/system"
    method: GET
    user: "{{ vast_replication_target_user }}"
    password: "{{ vast_replication_target_password }}"
    force_basic_auth: true
    validate_certs: "{{ vast_verify_ssl }}"
    status_code: [200, 401, 403]
  register: vast_dr_connectivity
  delegate_to: localhost
  changed_when: false
  when: vast_replication_target_cluster != ''
  tags:
    - replication
    - connectivity

- name: Configure replication partnership
  ansible.builtin.uri:
    url: "https://{{ vast_mgmt_host }}:{{ vast_mgmt_port }}/api/{{ vast_api_version }}/replication/partners"
    method: POST
    user: "{{ vast_mgmt_user }}"
    password: "{{ vast_mgmt_password }}"
    force_basic_auth: true
    validate_certs: "{{ vast_verify_ssl }}"
    body_format: json
    body:
      name: "dr-cluster"
      target_host: "{{ vast_replication_target_cluster }}"
      target_user: "{{ vast_replication_target_user }}"
      target_password: "{{ vast_replication_target_password }}"
    status_code: [200, 201, 409]
  delegate_to: localhost
  no_log: true
  when: vast_replication_target_cluster != ''
  tags:
    - replication

- name: Configure replication policy
  ansible.builtin.uri:
    url: "https://{{ vast_mgmt_host }}:{{ vast_mgmt_port }}/api/{{ vast_api_version }}/replication/policies"
    method: POST
    user: "{{ vast_mgmt_user }}"
    password: "{{ vast_mgmt_password }}"
    force_basic_auth: true
    validate_certs: "{{ vast_verify_ssl }}"
    body_format: json
    body:
      name: "default-replication-policy"
      type: "{{ vast_replication_type }}"
      schedule: "{{ vast_replication_schedule }}"
      bandwidth_limit_mbps: "{{ vast_replication_bandwidth_limit_mbps }}"
      enabled: true
    status_code: [200, 201, 409]
  delegate_to: localhost
  tags:
    - replication

- name: Get replication status
  ansible.builtin.uri:
    url: "https://{{ vast_mgmt_host }}:{{ vast_mgmt_port }}/api/{{ vast_api_version }}/replication/status"
    method: GET
    user: "{{ vast_mgmt_user }}"
    password: "{{ vast_mgmt_password }}"
    force_basic_auth: true
    validate_certs: "{{ vast_verify_ssl }}"
    return_content: true
  register: vast_replication_status
  delegate_to: localhost
  changed_when: false
  tags:
    - replication

- name: Display replication status
  ansible.builtin.debug:
    msg:
      - "Replication Status: {{ vast_replication_status.json.status | default('unknown') }}"
      - "Last Sync: {{ vast_replication_status.json.last_sync | default('N/A') }}"
  when: vast_replication_status.json is defined
  tags:
    - replication
