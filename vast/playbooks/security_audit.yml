---
# Security audit playbook for VAST Data Storage
# Performs comprehensive security and compliance checks

- name: VAST Security Audit - DoD STIG and NIST Compliance
  hosts: localhost
  connection: local
  gather_facts: true

  vars_files:
    - ../vars/production.yml
    - ../vars/vault.yml

  tasks:
    - name: Run security hardening checks (read-only)
      ansible.builtin.include_role:
        name: ../roles/vast_security_hardening
        tasks_from: compliance_check.yml
      tags: ['audit', 'compliance']

    - name: Check encryption status
      ansible.builtin.uri:
        url: "https://{{ vast_mgmt_host }}:{{ vast_mgmt_port }}/api/{{ vast_api_version }}/security/encryption/status"
        method: GET
        user: "{{ vast_mgmt_user }}"
        password: "{{ vast_mgmt_password }}"
        force_basic_auth: true
        validate_certs: "{{ vast_verify_ssl }}"
        return_content: true
      register: encryption_status
      delegate_to: localhost
      no_log: true

    - name: Check FIPS mode status
      ansible.builtin.uri:
        url: "https://{{ vast_mgmt_host }}:{{ vast_mgmt_port }}/api/{{ vast_api_version }}/security/fips/status"
        method: GET
        user: "{{ vast_mgmt_user }}"
        password: "{{ vast_mgmt_password }}"
        force_basic_auth: true
        validate_certs: "{{ vast_verify_ssl }}"
        return_content: true
      register: fips_status
      delegate_to: localhost
      no_log: true

    - name: Check audit logging status
      ansible.builtin.uri:
        url: "https://{{ vast_mgmt_host }}:{{ vast_mgmt_port }}/api/{{ vast_api_version }}/audit/config"
        method: GET
        user: "{{ vast_mgmt_user }}"
        password: "{{ vast_mgmt_password }}"
        force_basic_auth: true
        validate_certs: "{{ vast_verify_ssl }}"
        return_content: true
      register: audit_status
      delegate_to: localhost
      no_log: true

    - name: Generate security audit report
      ansible.builtin.template:
        src: ../templates/security_report.j2
        dest: "/tmp/vast_security_audit_{{ ansible_date_time.date }}.txt"
      vars:
        report_date: "{{ ansible_date_time.iso8601 }}"
        cluster_name: "{{ vast_cluster_name }}"
      delegate_to: localhost

    - name: Display audit summary
      ansible.builtin.debug:
        msg:
          - "Security Audit Completed"
          - "FIPS Mode: {{ fips_status.json.enabled | default('unknown') }}"
          - "Encryption at Rest: {{ encryption_status.json.at_rest_enabled | default('unknown') }}"
          - "Audit Logging: {{ audit_status.json.enabled | default('unknown') }}"
          - "Report saved to: /tmp/vast_security_audit_{{ ansible_date_time.date }}.txt"
