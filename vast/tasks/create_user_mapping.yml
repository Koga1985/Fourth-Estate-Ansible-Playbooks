---
# Reusable task: Create user/group mapping for VAST
# Usage: include this task with required variables

- name: Validate required variables for user mapping
  ansible.builtin.assert:
    that:
      - vast_mgmt_host is defined
      - mapping_type is defined
      - source_identity is defined
    fail_msg: "Required variables for user mapping are missing"

- name: Create user/group mapping
  ansible.builtin.uri:
    url: "https://{{ vast_mgmt_host }}:{{ vast_mgmt_port | default(443) }}/api/{{ vast_api_version | default('v1') }}/identity/mappings"
    method: POST
    user: "{{ vast_mgmt_user }}"
    password: "{{ vast_mgmt_password }}"
    force_basic_auth: true
    validate_certs: "{{ vast_verify_ssl | default(true) }}"
    body_format: json
    body:
      type: "{{ mapping_type }}"
      source: "{{ source_identity }}"
      target: "{{ target_identity | default(source_identity) }}"
    status_code: [200, 201, 409]
  delegate_to: localhost
  register: mapping_result

- name: Display mapping creation result
  ansible.builtin.debug:
    msg: "Identity mapping created: {{ source_identity }} -> {{ target_identity | default(source_identity) }}"
  when: mapping_result.status in [200, 201]
