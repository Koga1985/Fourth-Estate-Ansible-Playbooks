---
name: Security Scan

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday
  workflow_dispatch:

jobs:
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for gitleaks

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  dependency-scan:
    name: Dependency Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install safety
        run: pip install safety

      - name: Scan Python dependencies
        run: |
          find . -name "requirements.txt" | while read req; do
            echo "Scanning: $req"
            safety check -r "$req" || true
          done

  ansible-security:
    name: Ansible Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible and ansible-lint
        run: pip install ansible ansible-lint

      - name: Check for hardcoded credentials
        run: |
          echo "Checking for potential hardcoded credentials..."
          grep -r -i -E "(password|secret|api_key|token).*[:=].*['\"][^{]" \
            --include="*.yml" --include="*.yaml" . || true

      - name: Check for insecure configurations
        run: |
          echo "Checking for insecure configurations..."
          grep -r -i "validate_certs.*false" --include="*.yml" --include="*.yaml" . || true
          grep -r -i "no_log.*false" --include="*.yml" --include="*.yaml" . || true

  compliance-check:
    name: Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for STIG references
        run: |
          echo "ðŸ“‹ Checking STIG compliance coverage..."
          find . -name "*.yml" -type f | \
          xargs grep -l "stig" | wc -l | \
          xargs -I {} echo "Files with STIG references: {}"

      - name: Check for NIST 800-53 references
        run: |
          echo "ðŸ“‹ Checking NIST 800-53 compliance coverage..."
          find . -name "*.yml" -type f | \
          xargs grep -l "nist" | wc -l | \
          xargs -I {} echo "Files with NIST references: {}"

      - name: Check for encryption usage
        run: |
          echo "ðŸ”’ Checking encryption configuration..."
          grep -r -i "encrypt" --include="*.yml" --include="*.yaml" . | \
          grep -i "true\|aes\|kms" | wc -l | \
          xargs -I {} echo "Encryption configurations found: {}"

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [secret-scan, dependency-scan, ansible-security, compliance-check]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "ðŸ”’ Security scan workflow completed"
          echo "Review all security checks above"
          echo ""
          echo "Key security checks performed:"
          echo "  âœ… Secret scanning (Gitleaks)"
          echo "  âœ… Dependency vulnerability scanning"
          echo "  âœ… Ansible security best practices"
          echo "  âœ… Compliance reference checks (STIG/NIST)"
