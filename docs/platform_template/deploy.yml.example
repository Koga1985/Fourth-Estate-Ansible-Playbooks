---
# ============================================================================
# [PLATFORM_NAME] - Main Deployment Playbook
# ============================================================================
# Purpose: Deploy and configure [platform] with Fourth Estate security controls
# Idempotent: Yes - safe to run multiple times
# Runtime: [Estimated time - e.g., 15-30 minutes]
#
# Usage:
#   ansible-playbook [platform]/playbooks/deploy.yml \
#     -i inventory/production \
#     -e "@group_vars/[your_org].yml" \
#     --vault-password-file ~/.ansible_vault_password
#
# Tags:
#   prereq    - Prerequisites check only
#   install   - Installation tasks only
#   configure - Configuration tasks only
#   harden    - Security hardening only
#   validate  - Validation tasks only
# ============================================================================

- name: Deploy [Platform Name]
  hosts: platform_servers  # CHANGE_THIS: Update with your inventory group name
  gather_facts: true
  become: true  # Use sudo/root privileges

  vars_files:
    # Load environment-specific variables
    - ../vars/{{ environment | default('production') }}.yml

  vars:
    # Default variables (override in vars files or command line)
    fourth_estate_enabled: true
    compliance_mode: "nist_800_53"
    deployment_mode: "production"  # Options: development, staging, production

  pre_tasks:
    - name: Display deployment information
      ansible.builtin.debug:
        msg:
          - "Platform: [Platform Name]"
          - "Environment: {{ environment | default('production') }}"
          - "Target Hosts: {{ ansible_play_hosts | length }}"
          - "Fourth Estate Mode: {{ fourth_estate_enabled }}"
          - "Compliance: {{ compliance_mode }}"
      tags: [always]

    - name: Validate prerequisites
      ansible.builtin.include_tasks: ../tasks/prereq.yml
      tags: [prereq, always]

  roles:
    # ========================================================================
    # Role 1: Installation
    # ========================================================================
    - role: ../roles/platform_install
      tags: [install]
      vars:
        install_type: "full"  # Options: minimal, standard, full
        install_path: "/opt/platform"

    # ========================================================================
    # Role 2: Configuration
    # ========================================================================
    - role: ../roles/platform_configure
      tags: [configure]
      vars:
        config_template: "production"

    # ========================================================================
    # Role 3: Security Hardening (Fourth Estate)
    # ========================================================================
    - role: ../roles/platform_harden
      tags: [harden]
      when: fourth_estate_enabled | default(true)
      vars:
        hardening_level: "high"  # Options: basic, moderate, high
        audit_logging: true
        encryption_enabled: true

    # ========================================================================
    # Role 4: Integration (Optional)
    # ========================================================================
    - role: ../roles/platform_integration
      tags: [integration]
      when: integration_enabled | default(false)

  post_tasks:
    - name: Validate deployment
      ansible.builtin.include_tasks: ../tasks/validate.yml
      tags: [validate, always]

    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Deployment Complete!"
          - "=========================================="
          - "Platform: [Platform Name]"
          - "Status: {{ deployment_status | default('Success') }}"
          - "Next Steps:"
          - "  1. Review logs in /var/log/platform/"
          - "  2. Verify service status: systemctl status platform"
          - "  3. Run validation: ansible-playbook playbooks/validate.yml"
          - "=========================================="
      tags: [always]

  handlers:
    - name: restart platform service
      ansible.builtin.service:
        name: platform-service  # CHANGE_THIS: Actual service name
        state: restarted
      become: true

    - name: reload platform configuration
      ansible.builtin.command:
        cmd: /opt/platform/bin/reload-config  # CHANGE_THIS: Actual reload command
      become: true
