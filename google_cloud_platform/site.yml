---
# Google Cloud Platform Enterprise Deployment Playbook
# Entry point for comprehensive GCP automation
#
# Usage:
#   ansible-galaxy collection install -r requirements.yml
#   ansible-playbook -i inventory site.yml --ask-vault-pass

- name: GCP Enterprise Configuration
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    deploy_landing_zone: true
    deploy_iam: true
    deploy_network: true
    deploy_security: true
    deploy_gke: true
    deploy_logging: true
    deploy_monitoring: true
    deploy_storage: true
    deploy_databases: true
    deploy_compliance: true
    deploy_finops: true

  tasks:
    # =========================================
    # Phase 1: Landing Zone & Foundation
    # =========================================
    - name: Phase 1 - Landing Zone (DoD)
      ansible.builtin.include_role:
        name: gcp_landing_zone_dod
      when: deploy_landing_zone | bool
      tags: ['landing_zone', 'phase1']

    - name: Phase 1 - Assured Workloads
      ansible.builtin.include_role:
        name: gcp_assured_workloads_operations
      when: deploy_landing_zone | bool
      tags: ['landing_zone', 'assured', 'phase1']

    # =========================================
    # Phase 2: IAM & Identity
    # =========================================
    - name: Phase 2 - IAM Foundations
      ansible.builtin.include_role:
        name: gcp_iam_foundations
      when: deploy_iam | bool
      tags: ['iam', 'phase2']

    - name: Phase 2 - Service Accounts Broker
      ansible.builtin.include_role:
        name: gcp_service_accounts_broker
      when: deploy_iam | bool
      tags: ['iam', 'phase2']

    - name: Phase 2 - SSO Directory Sync
      ansible.builtin.include_role:
        name: gcp_sso_directory_sync
      when: deploy_iam | bool
      tags: ['iam', 'sso', 'phase2']

    # =========================================
    # Phase 3: Networking
    # =========================================
    - name: Phase 3 - Inventory Baseline
      ansible.builtin.include_role:
        name: gcp_inventory_baseline
      when: deploy_network | bool
      tags: ['network', 'phase3']

    - name: Phase 3 - Private Service Connect
      ansible.builtin.include_role:
        name: gcp_private_service_connect_fabric
      when: deploy_network | bool
      tags: ['network', 'phase3']

    - name: Phase 3 - DNS Enterprise
      ansible.builtin.include_role:
        name: gcp_dns_enterprise
      when: deploy_network | bool
      tags: ['network', 'dns', 'phase3']

    - name: Phase 3 - Ingress/Egress Controls
      ansible.builtin.include_role:
        name: gcp_ingress_egress_controls
      when: deploy_network | bool
      tags: ['network', 'security', 'phase3']

    - name: Phase 3 - Perimeter Protection
      ansible.builtin.include_role:
        name: gcp_perimeter_protection
      when: deploy_network | bool
      tags: ['network', 'security', 'phase3']

    # =========================================
    # Phase 4: Security
    # =========================================
    - name: Phase 4 - CMEK Everywhere
      ansible.builtin.include_role:
        name: gcp_cmek_everywhere
      when: deploy_security | bool
      tags: ['security', 'cmek', 'phase4']

    - name: Phase 4 - SCC SecOps Pipeline
      ansible.builtin.include_role:
        name: gcp_scc_secops_pipeline
      when: deploy_security | bool
      tags: ['security', 'scc', 'phase4']

    - name: Phase 4 - SCC Response Playbooks
      ansible.builtin.include_role:
        name: gcp_scc_response_playbooks
      when: deploy_security | bool
      tags: ['security', 'scc', 'phase4']

    - name: Phase 4 - Supply Chain Attestations
      ansible.builtin.include_role:
        name: gcp_supply_chain_attestations
      when: deploy_security | bool
      tags: ['security', 'supply_chain', 'phase4']

    # =========================================
    # Phase 5: GKE
    # =========================================
    - name: Phase 5 - GKE Workload Identity
      ansible.builtin.include_role:
        name: gcp_gke_workload_identity_rollout
      when: deploy_gke | bool
      tags: ['gke', 'phase5']

    - name: Phase 5 - GKE Runtime Policy
      ansible.builtin.include_role:
        name: gcp_gke_runtime_policy
      when: deploy_gke | bool
      tags: ['gke', 'phase5']

    - name: Phase 5 - GKE Secure Supply Chain
      ansible.builtin.include_role:
        name: gcp_gke_secure_supplychain
      when: deploy_gke | bool
      tags: ['gke', 'phase5']

    # =========================================
    # Phase 6: Logging & Monitoring
    # =========================================
    - name: Phase 6 - Logging Routing
      ansible.builtin.include_role:
        name: gcp_logging_routing_tiers
      when: deploy_logging | bool
      tags: ['logging', 'phase6']

    - name: Phase 6 - Monitoring SRE Baseline
      ansible.builtin.include_role:
        name: gcp_monitoring_sre_baseline
      when: deploy_monitoring | bool
      tags: ['monitoring', 'phase6']

    - name: Phase 6 - Audit Governance
      ansible.builtin.include_role:
        name: gcp_audit_governance_pack
      when: deploy_logging | bool
      tags: ['logging', 'audit', 'phase6']

    # =========================================
    # Phase 7: Data Services
    # =========================================
    - name: Phase 7 - Storage Governance
      ansible.builtin.include_role:
        name: gcp_storage_governance
      when: deploy_storage | bool
      tags: ['storage', 'phase7']

    - name: Phase 7 - BigQuery Governance
      ansible.builtin.include_role:
        name: gcp_bigquery_governance
      when: deploy_storage | bool
      tags: ['bigquery', 'phase7']

    - name: Phase 7 - Cloud SQL Baseline
      ansible.builtin.include_role:
        name: gcp_sql_baseline
      when: deploy_databases | bool
      tags: ['database', 'phase7']

    - name: Phase 7 - Pub/Sub Guardrails
      ansible.builtin.include_role:
        name: gcp_pubsub_guardrails
      when: deploy_storage | bool
      tags: ['pubsub', 'phase7']

    # =========================================
    # Phase 8: Serverless
    # =========================================
    - name: Phase 8 - Cloud Run Locked Down
      ansible.builtin.include_role:
        name: gcp_cloudrun_locked_down
      tags: ['serverless', 'phase8']

    # =========================================
    # Phase 9: Compliance
    # =========================================
    - name: Phase 9 - NIST 800-53 Controls
      ansible.builtin.include_role:
        name: gcp_nist80053_controls_map
      when: deploy_compliance | bool
      tags: ['compliance', 'nist', 'phase9']

    - name: Phase 9 - Quota Safeguards
      ansible.builtin.include_role:
        name: gcp_quota_safeguards
      when: deploy_compliance | bool
      tags: ['compliance', 'phase9']

    # =========================================
    # Phase 10: FinOps
    # =========================================
    - name: Phase 10 - FinOps Budgets
      ansible.builtin.include_role:
        name: gcp_finops_budgets
      when: deploy_finops | bool
      tags: ['finops', 'phase10']

    # =========================================
    # Deployment Summary
    # =========================================
    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "=== GCP Enterprise Deployment Complete ==="
          - "Project: {{ gcp_project }}"
          - "Organization: {{ gcp_organization_id }}"
          - "Region: {{ gcp_region }}"
          - "Landing Zone: {{ 'Configured' if deploy_landing_zone else 'Skipped' }}"
          - "IAM: {{ 'Configured' if deploy_iam else 'Skipped' }}"
          - "Network: {{ 'Configured' if deploy_network else 'Skipped' }}"
          - "Security: {{ 'Configured' if deploy_security else 'Skipped' }}"
          - "GKE: {{ 'Configured' if deploy_gke else 'Skipped' }}"
          - "Compliance: {{ 'Configured' if deploy_compliance else 'Skipped' }}"
      tags: ['always']
