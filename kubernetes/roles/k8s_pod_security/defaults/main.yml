---
# Default variables for k8s_pod_security role

# Kubernetes Version
k8s_version: "1.28"

# Pod Security Admission
k8s_pod_security_admission_enabled: true

# Default Pod Security Standards
# Options: privileged, baseline, restricted
k8s_pod_security_default_enforce: restricted
k8s_pod_security_default_audit: restricted
k8s_pod_security_default_warn: restricted

# Namespace Pod Security Configuration
k8s_pod_security_namespaces:
  - namespace: default
    enforce: restricted
    audit: restricted
    warn: restricted
  - namespace: news-production
    enforce: restricted
    audit: restricted
    warn: restricted
  - namespace: source-protection
    enforce: restricted
    audit: restricted
    warn: restricted
    enforce_version: latest
  - namespace: journalist-workspace
    enforce: baseline
    audit: restricted
    warn: restricted
  - namespace: kube-system
    enforce: privileged
    audit: baseline
    warn: baseline

# Pod Security Policy (deprecated in K8s 1.25, removed in 1.26)
k8s_pod_security_psp_enabled: false

# Security Context Defaults
k8s_pod_security_context_defaults:
  run_as_non_root: true
  run_as_user: 1000
  run_as_group: 3000
  fs_group: 2000
  fs_group_change_policy: OnRootMismatch
  allow_privilege_escalation: false
  read_only_root_filesystem: true
  seccomp_profile:
    type: RuntimeDefault

# Capabilities Management
k8s_pod_security_drop_all_capabilities: true
k8s_pod_security_allowed_capabilities: []
k8s_pod_security_required_drop_capabilities:
  - ALL

# Additional capabilities that can be dropped
k8s_pod_security_drop_capabilities:
  - NET_RAW
  - SYS_ADMIN
  - SYS_BOOT
  - SYS_MODULE
  - SYS_PTRACE
  - SYS_RAWIO
  - SYS_TIME
  - AUDIT_CONTROL
  - AUDIT_READ
  - AUDIT_WRITE
  - BLOCK_SUSPEND
  - CHOWN
  - DAC_OVERRIDE
  - DAC_READ_SEARCH
  - FOWNER
  - FSETID
  - IPC_LOCK
  - IPC_OWNER
  - KILL
  - LEASE
  - LINUX_IMMUTABLE
  - MAC_ADMIN
  - MAC_OVERRIDE
  - MKNOD
  - NET_ADMIN
  - NET_BIND_SERVICE
  - NET_BROADCAST
  - SETFCAP
  - SETGID
  - SETPCAP
  - SETUID
  - SYS_CHROOT
  - SYS_NICE
  - SYS_PACCT
  - SYS_RESOURCE
  - SYS_TTY_CONFIG
  - SYSLOG
  - WAKE_ALARM

# Non-root User Enforcement
k8s_pod_security_enforce_non_root: true
k8s_pod_security_min_user_id: 1000

# Read-only Root Filesystem
k8s_pod_security_readonly_rootfs: true

# AppArmor Configuration
k8s_pod_security_apparmor_enabled: true
k8s_pod_security_apparmor_default_profile: runtime/default
k8s_pod_security_apparmor_profiles:
  - name: restricted-profile
    profile: |
      #include <tunables/global>
      profile k8s-restricted flags=(attach_disconnected,mediate_deleted) {
        #include <abstractions/base>
        deny @{PROC}/* w,
        deny /sys/[^f]** wklx,
        deny /sys/f[^s]** wklx,
        deny /sys/fs/[^c]** wklx,
        deny /sys/fs/c[^g]** wklx,
        deny /sys/fs/cg[^r]** wklx,
        deny /sys/firmware/** rwklx,
        deny /sys/kernel/security/** rwklx,
      }

# SELinux Configuration
k8s_pod_security_selinux_enabled: true
k8s_pod_security_selinux_options:
  level: s0:c123,c456
  role: object_r
  type: svirt_sandbox_file_t
  user: system_u

# Seccomp Configuration
k8s_pod_security_seccomp_enabled: true
k8s_pod_security_seccomp_default_profile: RuntimeDefault
k8s_pod_security_seccomp_profiles:
  - name: restricted-seccomp
    profile:
      defaultAction: SCMP_ACT_ERRNO
      architectures:
        - SCMP_ARCH_X86_64
        - SCMP_ARCH_X86
        - SCMP_ARCH_X32
      syscalls:
        - names:
            - accept
            - accept4
            - access
            - arch_prctl
            - bind
            - brk
            - capget
            - capset
            - chdir
            - chmod
            - chown
            - close
            - connect
            - dup
            - dup2
            - dup3
            - epoll_create
            - epoll_create1
            - epoll_ctl
            - epoll_wait
            - exit
            - exit_group
            - fchdir
            - fchmod
            - fchown
            - fcntl
            - fstat
            - fstatfs
            - futex
            - getcwd
            - getdents
            - getdents64
            - getegid
            - geteuid
            - getgid
            - getgroups
            - getpeername
            - getpgrp
            - getpid
            - getppid
            - getsockname
            - getsockopt
            - gettid
            - getuid
            - listen
            - lseek
            - mmap
            - mprotect
            - munmap
            - nanosleep
            - open
            - openat
            - pipe
            - pipe2
            - poll
            - pread64
            - prlimit64
            - pwrite64
            - read
            - readlink
            - recvfrom
            - recvmsg
            - rt_sigaction
            - rt_sigprocmask
            - rt_sigreturn
            - select
            - sendmsg
            - sendto
            - set_robust_list
            - setgid
            - setsockopt
            - setuid
            - shutdown
            - sigaltstack
            - socket
            - stat
            - statfs
            - uname
            - unlink
            - wait4
            - write
          action: SCMP_ACT_ALLOW

# RuntimeClass Configuration
k8s_pod_security_runtime_classes:
  - name: gvisor
    handler: runsc
    scheduling:
      nodeSelector:
        runtime: gvisor
  - name: kata-containers
    handler: kata
    scheduling:
      nodeSelector:
        runtime: kata

# Webhook Configuration
k8s_pod_security_webhook_enabled: false
k8s_pod_security_webhook_url: ""

# Volume Restrictions
k8s_pod_security_allowed_volume_types:
  - configMap
  - emptyDir
  - ephemeral
  - persistentVolumeClaim
  - projected
  - secret
  - downwardAPI

k8s_pod_security_forbidden_volume_types:
  - hostPath
  - gcePersistentDisk
  - awsElasticBlockStore
  - azureDisk
  - azureFile
  - csi
  - flexVolume

# Host Namespace Restrictions
k8s_pod_security_allow_host_network: false
k8s_pod_security_allow_host_pid: false
k8s_pod_security_allow_host_ipc: false

# Privilege Escalation
k8s_pod_security_allow_privilege_escalation: false
k8s_pod_security_default_allow_privilege_escalation: false

# Privileged Containers
k8s_pod_security_allow_privileged: false

# Host Ports
k8s_pod_security_allow_host_ports: false
k8s_pod_security_allowed_host_port_ranges: []

# Proc Mount
k8s_pod_security_allowed_proc_mount_types:
  - Default

# Fourth Estate Specific
k8s_pod_security_fourth_estate_enabled: true
k8s_pod_security_source_protection_strict: true

# Compliance
k8s_pod_security_compliance_level: nist-800-53  # Options: nist-800-53, disa-stig, pci-dss
k8s_pod_security_audit_logging: true
