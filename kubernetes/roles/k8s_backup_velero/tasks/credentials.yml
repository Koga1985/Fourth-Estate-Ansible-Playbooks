---
# Velero Credentials Setup

- name: Create Velero namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ velero_namespace }}"
        labels:
          app.kubernetes.io/name: velero
          app.kubernetes.io/component: backup
          pod-security.kubernetes.io/enforce: privileged

- name: Create AWS credentials secret (AWS provider)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ velero_aws_credentials_secret }}"
        namespace: "{{ velero_namespace }}"
      type: Opaque
      stringData:
        cloud: |
          [default]
          aws_access_key_id={{ lookup('env', 'AWS_ACCESS_KEY_ID') }}
          aws_secret_access_key={{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}
  when: velero_provider == 'aws'
  no_log: true

- name: Create Azure credentials secret (Azure provider)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ velero_aws_credentials_secret }}"
        namespace: "{{ velero_namespace }}"
      type: Opaque
      stringData:
        cloud: |
          AZURE_SUBSCRIPTION_ID={{ velero_azure_subscription_id }}
          AZURE_TENANT_ID={{ lookup('env', 'AZURE_TENANT_ID') }}
          AZURE_CLIENT_ID={{ lookup('env', 'AZURE_CLIENT_ID') }}
          AZURE_CLIENT_SECRET={{ lookup('env', 'AZURE_CLIENT_SECRET') }}
          AZURE_RESOURCE_GROUP={{ velero_azure_resource_group }}
          AZURE_STORAGE_ACCOUNT_ID={{ velero_azure_storage_account }}
          AZURE_STORAGE_KEY={{ velero_azure_storage_key }}
  when: velero_provider == 'azure'
  no_log: true

- name: Create GCP credentials secret (GCP provider)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ velero_aws_credentials_secret }}"
        namespace: "{{ velero_namespace }}"
      type: Opaque
      data:
        cloud: "{{ velero_gcp_service_account_key | b64encode }}"
  when: velero_provider == 'gcp'
  no_log: true

- name: Create MinIO credentials secret (MinIO provider)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ velero_aws_credentials_secret }}"
        namespace: "{{ velero_namespace }}"
      type: Opaque
      stringData:
        cloud: |
          [default]
          aws_access_key_id={{ velero_minio_access_key }}
          aws_secret_access_key={{ velero_minio_secret_key }}
  when: velero_minio_enabled | bool
  no_log: true

- name: Create encryption key secret (if encryption enabled)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: velero-encryption-key
        namespace: "{{ velero_namespace }}"
      type: Opaque
      data:
        encryption-key: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') | b64encode }}"
  when: velero_encryption_enabled | bool
  no_log: true
