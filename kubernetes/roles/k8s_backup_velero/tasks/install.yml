---
# Velero Installation

- name: Add Velero Helm repository
  kubernetes.core.helm_repository:
    name: vmware-tanzu
    repo_url: "{{ velero_helm_repo }}"
  when: velero_install_method == 'helm'

- name: Create Velero Helm values file
  ansible.builtin.template:
    src: velero-values.yml.j2
    dest: "/tmp/velero-values.yml"
    mode: '0600'
  when: velero_install_method == 'helm'

- name: Install Velero via Helm
  kubernetes.core.helm:
    name: velero
    chart_ref: "{{ velero_helm_repo }}/{{ velero_helm_chart }}"
    chart_version: "{{ velero_version }}"
    release_namespace: "{{ velero_namespace }}"
    create_namespace: true
    values_files:
      - "/tmp/velero-values.yml"
    wait: true
    wait_timeout: "10m"
  when: velero_install_method == 'helm'

- name: Download Velero CLI (CLI installation method)
  ansible.builtin.get_url:
    url: "https://github.com/vmware-tanzu/velero/releases/download/v{{ velero_cli_version }}/velero-v{{ velero_cli_version }}-linux-amd64.tar.gz"
    dest: "/tmp/velero-v{{ velero_cli_version }}-linux-amd64.tar.gz"
    mode: '0644'
  when: velero_install_method == 'cli'

- name: Extract Velero CLI
  ansible.builtin.unarchive:
    src: "/tmp/velero-v{{ velero_cli_version }}-linux-amd64.tar.gz"
    dest: "/tmp/"
    remote_src: true
  when: velero_install_method == 'cli'

- name: Install Velero via CLI
  ansible.builtin.command: >
    /tmp/velero-v{{ velero_cli_version }}-linux-amd64/velero install
    --provider {{ velero_provider }}
    --plugins {{ velero_plugins | map(attribute='image') | join(',') }}
    --bucket {{ velero_aws_bucket if velero_provider == 'aws' else (velero_azure_container if velero_provider == 'azure' else velero_gcp_bucket) }}
    --secret-file /tmp/velero-credentials
    --use-node-agent={{ velero_use_restic | lower }}
    --use-volume-snapshots={{ velero_use_volume_snapshots | lower }}
    --backup-location-config region={{ velero_aws_region if velero_provider == 'aws' else 'default' }}
    --namespace {{ velero_namespace }}
    --wait
  when: velero_install_method == 'cli'
  changed_when: true

- name: Wait for Velero deployment to be ready
  kubernetes.core.k8s_info:
    kind: Deployment
    name: velero
    namespace: "{{ velero_namespace }}"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300

- name: Wait for Restic DaemonSet to be ready
  kubernetes.core.k8s_info:
    kind: DaemonSet
    name: restic
    namespace: "{{ velero_namespace }}"
    wait: true
    wait_timeout: 300
  when: velero_use_restic | bool

- name: Create BackupStorageLocation
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: velero.io/v1
      kind: BackupStorageLocation
      metadata:
        name: "{{ velero_aws_backup_location }}"
        namespace: "{{ velero_namespace }}"
      spec:
        provider: "{{ velero_provider }}"
        objectStorage:
          bucket: "{{ velero_aws_bucket if velero_provider == 'aws' else (velero_azure_container if velero_provider == 'azure' else (velero_gcp_bucket if velero_provider == 'gcp' else velero_minio_bucket)) }}"
          prefix: "{{ velero_namespace }}"
        config:
          region: "{{ velero_aws_region if velero_provider == 'aws' else 'default' }}"
          s3Url: "{{ velero_aws_s3_url if velero_aws_s3_url else (velero_minio_endpoint if velero_minio_enabled else omit) }}"
          s3ForcePathStyle: "{{ velero_aws_s3_force_path_style | string if velero_provider == 'aws' else (velero_minio_enabled | string) }}"
          kmsKeyId: "{{ velero_aws_kms_key_id if velero_aws_kms_key_id else omit }}"
        credential:
          name: "{{ velero_aws_credentials_secret }}"
          key: cloud

- name: Create VolumeSnapshotLocation (if enabled)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: velero.io/v1
      kind: VolumeSnapshotLocation
      metadata:
        name: "{{ velero_snapshot_location_name }}"
        namespace: "{{ velero_namespace }}"
      spec:
        provider: "{{ velero_provider }}"
        config:
          region: "{{ velero_aws_region if velero_provider == 'aws' else 'default' }}"
  when: velero_use_volume_snapshots | bool

- name: Verify Velero installation
  ansible.builtin.command: kubectl get deployment velero -n {{ velero_namespace }}
  register: velero_status
  changed_when: false
  failed_when: velero_status.rc != 0

- name: Display Velero installation status
  ansible.builtin.debug:
    msg: "Velero {{ velero_version }} installed successfully in {{ velero_namespace }} namespace"
