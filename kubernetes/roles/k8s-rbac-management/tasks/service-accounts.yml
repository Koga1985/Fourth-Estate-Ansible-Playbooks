---
# Service Account Management
# STIG V-242445

- name: Patch default service accounts to disable token automount
  kubernetes.core.k8s:
    state: patched
    kind: ServiceAccount
    name: default
    namespace: "{{ item }}"
    definition:
      automountServiceAccountToken: {{ k8s_automount_sa_token | lower }}
  loop:
    - default
    - kube-system
    - kube-public
  when: not k8s_automount_sa_token

- name: Create custom service accounts
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: "{{ item.name }}"
        namespace: "{{ item.namespace | default('default') }}"
      automountServiceAccountToken: {{ item.automount | default(k8s_automount_sa_token) | lower }}
  loop: "{{ k8s_service_accounts | default([]) }}"

- name: Verify service account token secrets are bound
  ansible.builtin.shell: |
    kubectl get sa -A -o json | \
    jq -r '.items[] | select(.automountServiceAccountToken == true) |
    .metadata.namespace + "/" + .metadata.name'
  register: sa_with_automount
  changed_when: false

- name: Display service accounts with automount enabled
  ansible.builtin.debug:
    msg: "Service accounts with automount: {{ sa_with_automount.stdout_lines }}"
  when: sa_with_automount.stdout_lines | length > 0
