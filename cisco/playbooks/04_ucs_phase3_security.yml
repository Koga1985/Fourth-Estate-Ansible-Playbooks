---
# Cisco UCS Phase 3: Security Hardening
# Apply DoD STIG and NIST 800-53 security controls
# Run after Phase 2 networking configuration

- name: Phase 3 - UCS Security Hardening
  hosts: localhost
  gather_facts: yes
  connection: local

  vars:
    apply_changes: false
    ucs_artifacts_dir: "/tmp/ucs-fourth-estate-artifacts/phase3"
    fourth_estate_org_name: "FourthEstate"

    # STIG compliance
    stig_cat1_enabled: true
    stig_cat2_enabled: true
    stig_cat3_enabled: true

  pre_tasks:
    - name: Display Phase 3 banner
      ansible.builtin.debug:
        msg: |
          ════════════════════════════════════════════════════════════════
          PHASE 3: Security Hardening
          ════════════════════════════════════════════════════════════════
          Applying:
            ✓ DoD STIG Category I/II/III findings
            ✓ NIST 800-53 controls (AC, IA, AU, SC, CM, SI, PE)
            ✓ Access control and RBAC
            ✓ Authentication hardening
            ✓ Audit logging
            ✓ Cryptographic controls
            ✓ DoD banner
          ════════════════════════════════════════════════════════════════

    - name: Create Phase 3 artifacts directory
      ansible.builtin.file:
        path: "{{ ucs_artifacts_dir }}"
        state: directory
        mode: '0750'

  tasks:
    - name: Apply UCS security hardening
      ansible.builtin.include_role:
        name: ucs_security_hardening

  post_tasks:
    - name: Generate Phase 3 completion report
      ansible.builtin.copy:
        dest: "{{ ucs_artifacts_dir }}/phase3_complete.txt"
        mode: '0640'
        content: |
          Phase 3: Security Hardening - COMPLETE
          ═════════════════════════════════════════════
          Completed: {{ ansible_date_time.iso8601 }}
          Status: {{ apply_changes | ternary('APPLIED', 'DRY RUN') }}

          Security Controls Applied:
            ✓ DoD STIG findings remediated (21+ findings)
            ✓ NIST 800-53 controls (46+ controls)
            ✓ Password policy: 15 char min, 60 day expiration
            ✓ Session timeout: 15 minutes
            ✓ Account lockout: 3 attempts
            ✓ TLS 1.2+ enforcement
            ✓ Audit logging: 365 day retention
            ✓ DoD banner configured

          Compliance Frameworks:
            ✓ DoD STIG
            ✓ NIST 800-53
            ✓ NIST 800-171
            ✓ FISMA Moderate/High

          Next Phase: Run 05_ucs_phase4_monitoring.yml

    - name: Display next steps
      ansible.builtin.debug:
        msg: |
          Phase 3 Complete!
          Security hardening applied successfully.
          Next: ansible-playbook 05_ucs_phase4_monitoring.yml
