---
# Cisco UCS Phase 2: Networking Configuration
# Configure VLANs, VSANs, QoS, and network policies
# Run after Phase 1 infrastructure deployment

- name: Phase 2 - UCS Networking Configuration
  hosts: localhost
  gather_facts: yes
  connection: local

  vars:
    apply_changes: false
    ucs_artifacts_dir: "/tmp/ucs-fourth-estate-artifacts/phase2"
    fourth_estate_org_name: "FourthEstate"

  pre_tasks:
    - name: Display Phase 2 banner
      ansible.builtin.debug:
        msg: |
          ════════════════════════════════════════════════════════════════
          PHASE 2: Networking Configuration
          ════════════════════════════════════════════════════════════════
          Configuring:
            ✓ VLANs (Management, Production, DMZ)
            ✓ VSANs for SAN connectivity
            ✓ QoS policies
            ✓ Network control (CDP/LLDP)
            ✓ Multicast policies
            ✓ Uplink port channels
          ════════════════════════════════════════════════════════════════

    - name: Create Phase 2 artifacts directory
      ansible.builtin.file:
        path: "{{ ucs_artifacts_dir }}"
        state: directory
        mode: '0750'

  tasks:
    - name: Configure UCS networking
      ansible.builtin.include_role:
        name: ucs_prod_networking

  post_tasks:
    - name: Generate Phase 2 completion report
      ansible.builtin.copy:
        dest: "{{ ucs_artifacts_dir }}/phase2_complete.txt"
        mode: '0640'
        content: |
          Phase 2: Networking Configuration - COMPLETE
          ═══════════════════════════════════════════════
          Completed: {{ ansible_date_time.iso8601 }}
          Status: {{ apply_changes | ternary('APPLIED', 'DRY RUN') }}

          Components Configured:
            ✓ VLANs for network segmentation
            ✓ VSANs for SAN fabric
            ✓ QoS policies (Platinum, Gold, Best-Effort)
            ✓ Network control policies
            ✓ Multicast policies
            ✓ Uplink configurations

          Next Phase: Run 04_ucs_phase3_security.yml

    - name: Display next steps
      ansible.builtin.debug:
        msg: |
          Phase 2 Complete!
          Next: ansible-playbook 04_ucs_phase3_security.yml
