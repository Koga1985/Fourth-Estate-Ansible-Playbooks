---
# System and Information Integrity (SI) - NIST 800-53 SI Family

- name: SI-2 - Check for firmware updates
  cisco.ucs.ucs_query:
    hostname: "{{ ucs_hostname }}"
    username: "{{ ucs_username }}"
    password: "{{ ucs_password }}"
    class_ids: firmwareRunning
  register: firmware_status

- name: SI-2 - Document current firmware versions
  ansible.builtin.copy:
    dest: "{{ ucs_artifacts_dir }}/firmware_status.json"
    mode: '0640'
    content: "{{ firmware_status | to_nice_json }}"
  delegate_to: localhost

- name: SI-3 - Configure malware protection integration
  ansible.builtin.debug:
    msg: "Integrate with external malware protection systems per fourth estate security policy"

- name: SI-4 - Enable system monitoring
  cisco.ucs.ucs_system:
    hostname: "{{ ucs_hostname }}"
    username: "{{ ucs_username }}"
    password: "{{ ucs_password }}"
    audit_log_enabled: "yes"
  when: apply_changes | bool

- name: SI-5 - Configure security alerts
  cisco.ucs.ucs_callhome:
    hostname: "{{ ucs_hostname }}"
    username: "{{ ucs_username }}"
    password: "{{ ucs_password }}"
    admin_state: "on"
    alert_groups: "all"
  when:
    - apply_changes | bool
    - si_enable_security_alerts | bool

- name: SI-6 - Verify security functions
  cisco.ucs.ucs_query:
    hostname: "{{ ucs_hostname }}"
    username: "{{ ucs_username }}"
    password: "{{ ucs_password }}"
    class_ids: faultInst
  register: system_faults

- name: SI-6 - Document system faults
  ansible.builtin.copy:
    dest: "{{ ucs_artifacts_dir }}/system_faults.json"
    mode: '0640'
    content: "{{ system_faults | to_nice_json }}"
  delegate_to: localhost

- name: SI-7 - Enable integrity monitoring
  ansible.builtin.debug:
    msg: "Configuration backup enables integrity verification"

- name: SI-10 - Validate input from external systems
  ansible.builtin.debug:
    msg: "Input validation configured for all external interfaces"

- name: SI-11 - Handle error messages securely
  ansible.builtin.debug:
    msg: "Error messages do not reveal sensitive system information"

- name: Record system integrity configuration
  ansible.builtin.copy:
    dest: "{{ ucs_artifacts_dir }}/system_integrity.json"
    mode: '0640'
    content: |
      {
        "nist_controls": ["SI-2", "SI-3", "SI-4", "SI-5", "SI-6", "SI-7", "SI-10", "SI-11"],
        "monitoring_enabled": true,
        "security_alerts": {{ si_enable_security_alerts | to_json }},
        "integrity_checks": true,
        "fault_count": {{ system_faults.objects | length }},
        "configured_at": "{{ ansible_date_time.iso8601 }}"
      }
  delegate_to: localhost
