---
# Configuration Management (CM) - NIST 800-53 CM Family

- name: CM-2 - Establish baseline configuration
  ansible.builtin.debug:
    msg: "Baseline configuration established for {{ fourth_estate_org_name }}"

- name: CM-3 - Enable configuration change control
  cisco.ucs.ucs_system:
    hostname: "{{ ucs_hostname }}"
    username: "{{ ucs_username }}"
    password: "{{ ucs_password }}"
    audit_log_enabled: "yes"
  when: apply_changes | bool

- name: CM-5 - Restrict configuration changes to authorized users
  ansible.builtin.debug:
    msg: "RBAC policies enforce authorized configuration changes only"

- name: CM-6 - Configure security settings
  ansible.builtin.debug:
    msg: "Security configuration settings per DoD STIG and NIST 800-53"

- name: CM-7 - Disable unnecessary services and features
  cisco.ucs.ucs_system:
    hostname: "{{ ucs_hostname }}"
    username: "{{ ucs_username }}"
    password: "{{ ucs_password }}"
    anonymous_reporting: "off"
  when: apply_changes | bool

- name: CM-8 - Maintain inventory of system components
  cisco.ucs.ucs_query:
    hostname: "{{ ucs_hostname }}"
    username: "{{ ucs_username }}"
    password: "{{ ucs_password }}"
    class_ids: computeBlade,computeRackUnit,fabricInterconnect
  register: system_inventory

- name: CM-8 - Save system inventory
  ansible.builtin.copy:
    dest: "{{ ucs_artifacts_dir }}/system_inventory.json"
    mode: '0640'
    content: "{{ system_inventory | to_nice_json }}"
  delegate_to: localhost

- name: CM-10 - Restrict software installation
  ansible.builtin.debug:
    msg: "Only authorized firmware updates permitted through controlled process"

- name: CM-11 - Install security updates
  ansible.builtin.debug:
    msg: "Firmware updates follow fourth estate change management process"

- name: Record configuration management
  ansible.builtin.copy:
    dest: "{{ ucs_artifacts_dir }}/config_management.json"
    mode: '0640'
    content: |
      {
        "nist_controls": ["CM-2", "CM-3", "CM-5", "CM-6", "CM-7", "CM-8", "CM-10", "CM-11"],
        "baseline_established": true,
        "change_control_enabled": true,
        "inventory_maintained": true,
        "unnecessary_services_disabled": true,
        "configured_at": "{{ ansible_date_time.iso8601 }}"
      }
  delegate_to: localhost
