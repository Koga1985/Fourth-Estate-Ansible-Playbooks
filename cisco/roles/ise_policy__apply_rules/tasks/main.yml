---
- name: Ensure artifacts dir
  ansible.builtin.file:
    path: "{{ artifacts_dir }}"
    state: directory

- name: Emit rules plan
  ansible.builtin.copy:
    dest: "{{ artifacts_dir }}/policy_rules_plan.json"
    mode: "0644"
    content: "{{ {'policy_set': policy_set_name, 'authn_rules': authn_rules, 'authz_rules': authz_rules} | to_nice_json }}"

- name: Apply Authentication rules (guarded placeholder)
  when: apply_changes | bool
  loop: "{{ authn_rules }}"
  loop_control:
    label: "{{ item.name }}"
  ansible.builtin.debug:
    msg: "AuthN rule {{ item.name }} → {{ item.identity_source }} when {{ item.condition }}"

- name: Apply Authorization rules (guarded placeholder)
  when: apply_changes | bool
  loop: "{{ authz_rules }}"
  loop_control:
    label: "{{ item.name }}"
  ansible.builtin.debug:
    msg: "AuthZ rule {{ item.name }} → {{ item.profile | default('') }} / {{ item.sgt | default('') }} / {{ item.dacl | default('') }}"
