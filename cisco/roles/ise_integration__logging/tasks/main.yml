---
# tasks file for ise_integration__logging
# Cisco ISE Logging and SIEM Integration

- name: Validate ISE connection parameters
  ansible.builtin.assert:
    that:
      - ise_hostname is defined
      - ise_username is defined
      - ise_password is defined
    fail_msg: "Required ISE connection parameters not defined"
  tags: [validation, prerequisites]

- name: Ensure artifacts directory
  ansible.builtin.file:
    path: "{{ ise_artifacts_dir }}"
    state: directory
    mode: "0750"
  tags: [always]

- name: Configure remote syslog targets
  cisco.ise.syslog_server:
    ise_hostname: "{{ ise_hostname }}"
    ise_username: "{{ ise_username }}"
    ise_password: "{{ ise_password }}"
    ise_verify: "{{ ise_verify_ssl }}"
    state: present
    name: "{{ item.name }}"
    ipAddress: "{{ item.ip_address }}"
    port: "{{ item.port | default(514) }}"
    protocol: "{{ item.protocol | default('UDP') }}"
  loop: "{{ syslog_servers }}"
  when: apply_changes | bool
  tags: [logging, syslog]

- name: Configure logging categories
  ansible.builtin.uri:
    url: "https://{{ ise_hostname }}/admin/API/mnt/LoggingCategory"
    method: PUT
    user: "{{ ise_username }}"
    password: "{{ ise_password }}"
    force_basic_auth: true
    validate_certs: "{{ ise_verify_ssl }}"
    headers:
      Content-Type: "application/json"
      Accept: "application/json"
    body_format: json
    body:
      loggingCategory: "{{ logging_categories }}"
  when: apply_changes | bool
  tags: [logging, categories]

- name: Configure SIEM integration
  ansible.builtin.uri:
    url: "{{ siem_api_endpoint }}/configure"
    method: POST
    headers:
      Authorization: "Bearer {{ siem_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      source: "cisco_ise"
      hostname: "{{ ise_hostname }}"
      log_types: "{{ siem_log_types }}"
  when:
    - apply_changes | bool
    - siem_integration_enabled | bool
  tags: [siem, integration]

- name: Generate logging configuration report
  ansible.builtin.template:
    src: ise_integration__logging_report.json.j2
    dest: "{{ ise_artifacts_dir }}/logging_config_{{ ansible_date_time.epoch }}.json"
    mode: "0640"
  tags: [reporting]
