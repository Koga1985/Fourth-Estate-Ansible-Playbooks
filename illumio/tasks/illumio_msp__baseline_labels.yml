---
- name: Ensure artifacts dir
  ansible.builtin.file:
    path: "{{ artifacts_dir | default('/tmp/illumio-artifacts') }}"
    state: directory
    mode: "0755"

- name: Set common headers
  ansible.builtin.set_fact:
    illumio_headers:
      Accept: "application/json"
      Content-Type: "application/json"
      X-Illumio-Org: "{{ org_id }}"

- name: Assert schema
  ansible.builtin.assert:
    that: [ tenants is defined, label_schema is defined ]
    fail_msg: "Provide tenants and label_schema."

- name: Apply label schema to each tenant
  ansible.builtin.include_tasks: "illumio_labels__schema_apply.yml"
  loop: "{{ tenants }}"
  loop_control: { loop_var: tnt, label: "{{ tnt.org_id }}" }
  vars:
    org_id: "{{ tnt.org_id }}"
    api_user: "{{ tnt.api_user }}"
    api_key: "{{ tnt.api_key }}"
    pce_url: "{{ tnt.pce_url }}"
    label_schema: "{{ label_schema }}"
