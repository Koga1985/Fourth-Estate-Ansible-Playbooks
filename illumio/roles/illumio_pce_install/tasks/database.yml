---
# PostgreSQL database installation and configuration for PCE

- name: Install PostgreSQL repository (RHEL/CentOS)
  yum:
    name: "{{ illumio_pce_postgresql_repo_url }}"
    state: present
    disable_gpg_check: yes
  when: ansible_distribution_major_version in ["7", "8", "9"]

- name: Disable default PostgreSQL module (RHEL 8/9)
  command: dnf -qy module disable postgresql
  when: ansible_distribution_major_version in ["8", "9"]
  changed_when: false

- name: Install PostgreSQL packages
  package:
    name:
      - "postgresql{{ illumio_pce_postgresql_version }}-server"
      - "postgresql{{ illumio_pce_postgresql_version }}-contrib"
      - "postgresql{{ illumio_pce_postgresql_version }}"
      - python3-psycopg2
    state: present

- name: Check if PostgreSQL is initialized
  stat:
    path: "{{ illumio_pce_postgresql_data_dir }}/PG_VERSION"
  register: pg_initialized

- name: Initialize PostgreSQL database
  command: "/usr/pgsql-{{ illumio_pce_postgresql_version }}/bin/postgresql-{{ illumio_pce_postgresql_version }}-setup initdb"
  when: not pg_initialized.stat.exists

- name: Configure PostgreSQL for PCE
  template:
    src: postgresql.conf.j2
    dest: "{{ illumio_pce_postgresql_data_dir }}/postgresql.conf"
    owner: postgres
    group: postgres
    mode: '0600'
  notify: restart postgresql

- name: Configure PostgreSQL authentication
  template:
    src: pg_hba.conf.j2
    dest: "{{ illumio_pce_postgresql_data_dir }}/pg_hba.conf"
    owner: postgres
    group: postgres
    mode: '0600'
  notify: restart postgresql

- name: Start and enable PostgreSQL
  systemd:
    name: "postgresql-{{ illumio_pce_postgresql_version }}"
    enabled: yes
    state: started

- name: Wait for PostgreSQL to be ready
  wait_for:
    port: 5432
    host: localhost
    timeout: 30

- name: Create PCE database
  postgresql_db:
    name: "{{ illumio_pce_database_name }}"
    encoding: UTF8
    lc_collate: en_US.UTF-8
    lc_ctype: en_US.UTF-8
    template: template0
    state: present
  become: yes
  become_user: postgres

- name: Create PCE database user
  postgresql_user:
    name: "{{ illumio_pce_database_user }}"
    password: "{{ illumio_pce_database_password }}"
    encrypted: yes
    state: present
  become: yes
  become_user: postgres
  no_log: true

- name: Grant privileges to PCE database user
  postgresql_privs:
    database: "{{ illumio_pce_database_name }}"
    privs: ALL
    type: database
    role: "{{ illumio_pce_database_user }}"
    state: present
  become: yes
  become_user: postgres

- name: Enable required PostgreSQL extensions
  postgresql_ext:
    name: "{{ item }}"
    db: "{{ illumio_pce_database_name }}"
    state: present
  loop:
    - pg_stat_statements
    - pgcrypto
  become: yes
  become_user: postgres

- name: Configure PostgreSQL for PCE cluster (if cluster mode)
  include_tasks: database_cluster.yml
  when: illumio_pce_cluster_mode | bool

- name: Create database backup directory
  file:
    path: "{{ illumio_pce_database_backup_dir }}"
    state: directory
    owner: postgres
    group: postgres
    mode: '0700'

- name: Configure automated database backups
  cron:
    name: "Illumio PCE database backup"
    minute: "0"
    hour: "{{ illumio_pce_backup_hour }}"
    job: "/usr/pgsql-{{ illumio_pce_postgresql_version }}/bin/pg_dump -U {{ illumio_pce_database_user }} -Fc {{ illumio_pce_database_name }} > {{ illumio_pce_database_backup_dir }}/pce_backup_$(date +\\%Y\\%m\\%d_\\%H\\%M\\%S).dump"
    user: postgres
  when: illumio_pce_enable_db_backup | bool

- name: Create database backup cleanup script
  copy:
    content: |
      #!/bin/bash
      # Keep only last {{ illumio_pce_backup_retention_days }} days of backups
      find {{ illumio_pce_database_backup_dir }} -name "pce_backup_*.dump" -mtime +{{ illumio_pce_backup_retention_days }} -delete
    dest: /usr/local/bin/cleanup_pce_backups.sh
    mode: '0755'
  when: illumio_pce_enable_db_backup | bool

- name: Schedule backup cleanup
  cron:
    name: "Cleanup old PCE database backups"
    minute: "30"
    hour: "{{ illumio_pce_backup_hour }}"
    job: "/usr/local/bin/cleanup_pce_backups.sh"
    user: postgres
  when: illumio_pce_enable_db_backup | bool

- name: Configure PostgreSQL connection pooling (PgBouncer)
  include_tasks: pgbouncer.yml
  when: illumio_pce_use_pgbouncer | bool

- name: Verify database connectivity
  postgresql_ping:
    db: "{{ illumio_pce_database_name }}"
    login_host: "{{ illumio_pce_database_host }}"
    login_user: "{{ illumio_pce_database_user }}"
    login_password: "{{ illumio_pce_database_password }}"
  no_log: true
