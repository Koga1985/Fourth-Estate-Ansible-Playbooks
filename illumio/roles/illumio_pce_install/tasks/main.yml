---
# tasks file for illumio_pce_install
# Illumio Policy Compute Engine (PCE) Installation Role
# Supports: RHEL/CentOS 7/8/9, Multi-node HA clusters

- name: Validate PCE installation prerequisites
  include_tasks: prerequisites.yml
  tags:
    - illumio
    - pce
    - prerequisites

- name: Configure system requirements
  include_tasks: system_config.yml
  tags:
    - illumio
    - pce
    - system

- name: Install PostgreSQL for PCE
  include_tasks: database.yml
  when: illumio_pce_install_database | bool
  tags:
    - illumio
    - pce
    - database

- name: Install Illumio PCE packages
  include_tasks: install_pce.yml
  tags:
    - illumio
    - pce
    - install

- name: Configure PCE cluster (HA mode)
  include_tasks: cluster_setup.yml
  when: illumio_pce_cluster_mode | bool
  tags:
    - illumio
    - pce
    - cluster

- name: Configure SSL/TLS certificates
  include_tasks: certificates.yml
  tags:
    - illumio
    - pce
    - certificates

- name: Configure load balancer
  include_tasks: load_balancer.yml
  when: illumio_pce_use_loadbalancer | bool
  tags:
    - illumio
    - pce
    - loadbalancer

- name: Configure firewall rules
  include_tasks: firewall.yml
  tags:
    - illumio
    - pce
    - firewall

- name: Initialize PCE
  include_tasks: initialize.yml
  tags:
    - illumio
    - pce
    - initialize

- name: Activate PCE license
  include_tasks: license.yml
  when: illumio_pce_license_file is defined
  tags:
    - illumio
    - pce
    - license

- name: Configure SELinux for PCE
  include_tasks: selinux.yml
  when: ansible_selinux.status == "enabled"
  tags:
    - illumio
    - pce
    - selinux

- name: Verify PCE installation
  include_tasks: verify.yml
  tags:
    - illumio
    - pce
    - verify
