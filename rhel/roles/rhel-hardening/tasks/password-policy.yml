---
# tasks/password-policy.yml - Password Policy Configuration
# DoD STIG V-204405 through V-204418

- name: Install pwquality package
  ansible.builtin.package:
    name:
      - libpwquality
      - pam
    state: present
  tags:
    - packages

- name: Configure password quality requirements
  ansible.builtin.lineinfile:
    path: /etc/security/pwquality.conf
    regexp: "^#?{{ item.key }}"
    line: "{{ item.key }} = {{ item.value }}"
    state: present
  loop:
    - { key: 'minlen', value: "{{ rhel_password_min_length }}" }
    - { key: 'dcredit', value: "-{{ rhel_password_min_digit }}" }
    - { key: 'ucredit', value: "-{{ rhel_password_min_upper }}" }
    - { key: 'lcredit', value: "-{{ rhel_password_min_lower }}" }
    - { key: 'ocredit', value: "-{{ rhel_password_min_special }}" }
    - { key: 'difok', value: "{{ rhel_password_min_diff }}" }
    - { key: 'maxrepeat', value: "{{ rhel_password_max_repeating }}" }
    - { key: 'maxsequence', value: "{{ rhel_password_max_consecutive }}" }
  tags:
    - pwquality

- name: Configure password aging in login.defs (STIG V-204414, V-204415, V-204416)
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: "^{{ item.key }}"
    line: "{{ item.key }}\t{{ item.value }}"
    state: present
  loop:
    - { key: 'PASS_MAX_DAYS', value: "{{ rhel_password_max_days }}" }
    - { key: 'PASS_MIN_DAYS', value: "{{ rhel_password_min_days }}" }
    - { key: 'PASS_WARN_AGE', value: "{{ rhel_password_warn_age }}" }
  tags:
    - login_defs

- name: Configure account inactive period (STIG V-204417)
  ansible.builtin.command: useradd -D -f {{ rhel_account_inactive_days }}
  changed_when: false
  tags:
    - useradd

- name: Configure password hashing algorithm (STIG V-204418)
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^ENCRYPT_METHOD'
    line: "ENCRYPT_METHOD\t{{ rhel_password_hash_algorithm | upper }}"
    state: present
  tags:
    - login_defs

- name: Configure password history in PAM (STIG V-204413)
  ansible.builtin.lineinfile:
    path: /etc/pam.d/system-auth
    regexp: '^password\s+sufficient\s+pam_unix.so'
    line: "password    sufficient    pam_unix.so {{ rhel_password_hash_algorithm }} shadow nullok try_first_pass use_authtok remember={{ rhel_password_remember }}"
    state: present
  tags:
    - pam

- name: Apply password aging to existing users
  ansible.builtin.command: chage --maxdays {{ rhel_password_max_days }} --mindays {{ rhel_password_min_days }} --warndays {{ rhel_password_warn_age }} {{ item }}
  loop: "{{ ansible_facts.getent_passwd.keys() | list }}"
  when:
    - item not in ['root', 'halt', 'sync', 'shutdown']
    - ansible_facts.getent_passwd[item][1] | int >= 1000
  changed_when: false
  failed_when: false
  tags:
    - users
    - never

- name: Validate password policy configuration
  ansible.builtin.command: pwscore
  register: pwscore_test
  changed_when: false
  failed_when: false
  tags:
    - validation
