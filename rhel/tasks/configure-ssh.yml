---
# tasks/configure-ssh.yml - SSH hardening configuration
# DoD STIG V-204596 through V-204612

- name: Backup SSH configuration
  ansible.builtin.copy:
    src: /etc/ssh/sshd_config
    dest: /etc/ssh/sshd_config.backup-{{ ansible_date_time.epoch }}
    remote_src: true
    mode: '0600'
  tags:
    - ssh

- name: Harden SSH configuration
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?{{ item.key }}"
    line: "{{ item.key }} {{ item.value }}"
    state: present
    validate: '/usr/sbin/sshd -t -f %s'
  loop:
    - { key: 'PermitRootLogin', value: 'no' }
    - { key: 'PasswordAuthentication', value: 'no' }
    - { key: 'X11Forwarding', value: 'no' }
    - { key: 'MaxAuthTries', value: '3' }
    - { key: 'ClientAliveInterval', value: '600' }
    - { key: 'ClientAliveCountMax', value: '0' }
    - { key: 'Protocol', value: '2' }
  tags:
    - ssh

- name: Restart SSH service
  ansible.builtin.systemd:
    name: sshd
    state: restarted
  tags:
    - ssh

- name: Validate SSH configuration
  ansible.builtin.command: sshd -t
  changed_when: false
  tags:
    - ssh
    - validation
