---
# Configure Active Directory integration

- name: Check if Active Directory is already configured
  ansible.builtin.uri:
    url: "{{ cohesity_api_protocol }}://{{ cohesity_cluster_vip }}/irisservices/api/v1/public/activeDirectory"
    method: GET
    headers:
      Authorization: "Bearer {{ cohesity_api_token }}"
    validate_certs: "{{ cohesity_api_verify_ssl }}"
    status_code: [200, 404]
  register: ad_status

- name: Join Active Directory domain
  ansible.builtin.uri:
    url: "{{ cohesity_api_protocol }}://{{ cohesity_cluster_vip }}/irisservices/api/v1/public/activeDirectory"
    method: POST
    headers:
      Authorization: "Bearer {{ cohesity_api_token }}"
    body_format: json
    body:
      domainName: "{{ cohesity_ad_domain }}"
      preferredDomainControllers: "{{ cohesity_ad_preferred_dc }}"
      userName: "{{ cohesity_ad_username }}"
      userPassword: "{{ cohesity_ad_password }}"
      ouName: "{{ cohesity_ad_ou_path }}"
      workgroup: "{{ cohesity_ad_workgroup | default(omit) }}"
      ldapProvider: "{{ cohesity_ad_ldap_provider }}"
      userIdMapping:
        type: "{{ cohesity_ad_user_id_mapping }}"
      enableAesEncryption: true
    validate_certs: "{{ cohesity_api_verify_ssl }}"
    status_code: [200, 201]
  no_log: true
  when: ad_status.status == 404

- name: Update Active Directory configuration
  ansible.builtin.uri:
    url: "{{ cohesity_api_protocol }}://{{ cohesity_cluster_vip }}/irisservices/api/v1/public/activeDirectory/{{ cohesity_ad_domain }}"
    method: PUT
    headers:
      Authorization: "Bearer {{ cohesity_api_token }}"
    body_format: json
    body:
      preferredDomainControllers: "{{ cohesity_ad_preferred_dc }}"
      machineAccountsOuPath: "{{ cohesity_ad_ou_path }}"
      trustedDomains: "{{ cohesity_ad_trusted_domains }}"
    validate_certs: "{{ cohesity_api_verify_ssl }}"
    status_code: 200
  when: ad_status.status == 200

- name: Display AD configuration status
  ansible.builtin.debug:
    msg: "Active Directory domain {{ cohesity_ad_domain }} configured successfully"
