---
# Configure RBAC with AD groups

- name: Add AD groups to Cohesity
  ansible.builtin.uri:
    url: "{{ cohesity_api_protocol }}://{{ cohesity_cluster_vip }}/irisservices/api/v1/public/principals"
    method: POST
    headers:
      Authorization: "Bearer {{ cohesity_api_token }}"
    body_format: json
    body:
      domain: "{{ item.domain }}"
      principalName: "{{ item.group_name }}"
      objectClass: "kGroup"
      roles: "{{ item.roles }}"
      description: "{{ item.description }}"
    validate_certs: "{{ cohesity_api_verify_ssl }}"
    status_code: [200, 201, 409]
  loop: "{{ cohesity_ad_groups }}"
  loop_control:
    label: "{{ item.group_name }}"
  register: ad_group_result

- name: Display RBAC configuration
  ansible.builtin.debug:
    msg: "AD group {{ item.item.group_name }} configured with roles: {{ item.item.roles | join(', ') }}"
  loop: "{{ ad_group_result.results }}"
  loop_control:
    label: "{{ item.item.group_name }}"
  when: item.status in [200, 201]
