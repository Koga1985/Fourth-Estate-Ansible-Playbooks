#!/bin/bash
# Cohesity Cluster Bootstrap Script
# Generated by Ansible

set -e

echo "Starting Cohesity cluster bootstrap..."
echo "Cluster Name: {{ cohesity_cluster_name }}"
echo "Node Count: {{ cohesity_nodes | length }}"

# Prepare node list
NODE_IPS="{{ cohesity_nodes | map(attribute='ip_address') | join(',') }}"
CLUSTER_NAME="{{ cohesity_cluster_name }}"
CLUSTER_DOMAIN="{{ cohesity_cluster_domain }}"
CLUSTER_GATEWAY="{{ cohesity_cluster_gateway }}"
CLUSTER_SUBNET="{{ cohesity_cluster_subnet_mask }}"
CLUSTER_VIPS="{{ cohesity_cluster_vips | join(',') }}"

# Execute cluster creation
/opt/cohesity/bin/cluster create \
  --cluster-name="${CLUSTER_NAME}" \
  --cluster-domain="${CLUSTER_DOMAIN}" \
  --node-ips="${NODE_IPS}" \
  --cluster-vips="${CLUSTER_VIPS}" \
  --gateway="${CLUSTER_GATEWAY}" \
  --subnet-mask="${CLUSTER_SUBNET}" \
{% if cohesity_encryption_enabled %}
  --enable-encryption \
{% endif %}
{% if cohesity_fips_mode_enabled %}
  --enable-fips \
{% endif %}
  --metadata-fault-tolerance={{ cohesity_disk_config.metadata_fault_tolerance }} \
  --data-fault-tolerance={{ cohesity_disk_config.data_fault_tolerance }}

echo "Cluster bootstrap initiated. Waiting for cluster services to start..."

# Wait for cluster services
sleep 60

# Check cluster status
for i in {1..30}; do
  if /opt/cohesity/bin/cluster status | grep -q "running"; then
    echo "Cluster services are running"
    break
  fi
  echo "Waiting for cluster services... ($i/30)"
  sleep 30
done

echo "Cluster bootstrap completed successfully"
exit 0
