---
# Ansible Tower Configuration Playbook
# Entry point for Tower automation
#
# Usage:
#   ansible-galaxy collection install -r requirements.yml
#   ansible-playbook -i inventory site.yml --ask-vault-pass

- name: Ansible Tower Configuration
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    deploy_install: false
    deploy_organizations: true
    deploy_inventories: true
    deploy_projects: true
    deploy_templates: true
    deploy_workflows: true
    deploy_rbac: true

  tasks:
    - name: Phase 1 - Tower Installation
      ansible.builtin.include_role:
        name: ansible_tower_install
      when: deploy_install | bool
      tags: ['install', 'phase1']

    - name: Phase 2 - Tower Configuration
      ansible.builtin.include_role:
        name: ansible_tower_config
      tags: ['config', 'phase2']

    - name: Phase 3 - Organizations
      ansible.builtin.include_role:
        name: ansible_tower_organizations
      when: deploy_organizations | bool
      tags: ['organizations', 'phase3']

    - name: Phase 4 - Inventories
      ansible.builtin.include_role:
        name: ansible_tower_inventories
      when: deploy_inventories | bool
      tags: ['inventories', 'phase4']

    - name: Phase 5 - Projects
      ansible.builtin.include_role:
        name: ansible_tower_projects
      when: deploy_projects | bool
      tags: ['projects', 'phase5']

    - name: Phase 6 - Job Templates
      ansible.builtin.include_role:
        name: ansible_tower_job_templates
      when: deploy_templates | bool
      tags: ['templates', 'phase6']

    - name: Phase 7 - Workflows
      ansible.builtin.include_role:
        name: ansible_tower_workflows
      when: deploy_workflows | bool
      tags: ['workflows', 'phase7']

    - name: Phase 8 - RBAC
      ansible.builtin.include_role:
        name: ansible_tower_rbac
      when: deploy_rbac | bool
      tags: ['rbac', 'phase8']

    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "=== Ansible Tower Configuration Complete ==="
          - "Tower: {{ tower_hostname }}"
          - "Organization: {{ tower_organization }}"
      tags: ['always']
