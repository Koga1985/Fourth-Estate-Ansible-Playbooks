---
# vars example:
# users:
#   - name: "svc_ansible"
#     password: "{{ vault_fb_user_pw }}"
#     roles: [ "readonly" ]
#     api_token: true
# disable_defaults: true
- name: Create/Update local users (fallback via REST)
  ansible.builtin.uri:
    url: "{{ fb_url }}/api/1.12/admin/users"
    method: POST
    headers: { api-token: "{{ fb_token }}", Content-Type: "application/json" }
    body_format: json
    body: "{{ item }}"
    status_code: [200,201,204]
    validate_certs: "{{ fb_validate_certs | default(false) }}"
  loop: "{{ users | default([]) }}"
  loop_control: { label: "{{ item.name }}" }

- name: Generate API tokens for users (fallback via REST)
  when: item.api_token | default(false)
  ansible.builtin.uri:
    url: "{{ fb_url }}/api/1.12/admin/users/{{ item.name }}/api-tokens"
    method: POST
    headers: { api-token: "{{ fb_token }}", Content-Type: "application/json" }
    body_format: json
    body: {}
    status_code: [200,201]
    validate_certs: "{{ fb_validate_certs | default(false) }}"
  loop: "{{ users | default([]) }}"
  loop_control: { label: "{{ item.name }}" }

- name: Disable default accounts (guarded)
  when: disable_defaults | default(false)
  ansible.builtin.uri:
    url: "{{ fb_url }}/api/1.12/admin/users/{{ item }}"
    method: PATCH
    headers: { api-token: "{{ fb_token }}", Content-Type: "application/json" }
    body_format: json
    body: { disabled: true }
    status_code: [200,204]
    validate_certs: "{{ fb_validate_certs | default(false) }}"
  loop: [ "pureuser" ]
