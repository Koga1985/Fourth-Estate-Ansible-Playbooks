---
# vars example:
# upgrade:
#   target_version: "6.x.y"
#   maintenance_window_ok: true
#   dry_run: true
- name: Gather current array & controller health
  purestorage.flasharray.purefa_info:
    fa_url: "{{ fa_url }}"
    api_token: "{{ api_token }}"
    gather_subset: [ array, controllers ]
  register: fa_health

- name: Guardrail â€” abort if any controller degraded
  ansible.builtin.fail:
    msg: "Controller degraded; refusing to upgrade."
  when: fa_health.controllers_info | selectattr('status','match','degraded|fault|error') | list | length > 0

- name: (Dry run) Show intended upgrade
  when: upgrade.dry_run | default(true)
  ansible.builtin.debug:
    msg: "Would upgrade {{ fa_health.array_info.model }} from {{ fa_health.array_info.version }} to {{ upgrade.target_version }}"

- name: Trigger Purity upgrade (fallback via REST)
  when: not (upgrade.dry_run | default(true)) and upgrade.maintenance_window_ok | default(false)
  ansible.builtin.uri:
    url: "https://{{ fa_url }}/api/1.0/array/upgrade"
    method: POST
    headers: { api-token: "{{ api_token }}", Content-Type: "application/json" }
    body_format: json
    body: { target: "{{ upgrade.target_version }}" }
    status_code: [200,202]
    validate_certs: "{{ validate_certs | default(false) }}"
