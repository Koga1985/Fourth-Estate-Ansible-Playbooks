---
# vars example:
# pgroups:
#   - name: pg-app01
#     volumes: [ app01-db01, app01-logs01 ]
#     snap_schedule: { per_hour: 4, per_day: 24 }
#     replication: { enabled: true, target: "fa-dr01", rpo: "10m" }
- name: Create/update protection groups and add volumes
  purestorage.flasharray.purefa_pg:
    fa_url: "{{ fa_url }}"
    api_token: "{{ api_token }}"
    pgroup: "{{ item.name }}"
    volumes: "{{ item.volumes | default([]) }}"
    state: present
  loop: "{{ pgroups | default([]) }}"
  loop_control: { label: "{{ item.name }}" }

- name: (Optional) Apply snapshot schedule knobs
  when: item.snap_schedule is defined
  purestorage.flasharray.purefa_pg:
    fa_url: "{{ fa_url }}"
    api_token: "{{ api_token }}"
    pgroup: "{{ item.name }}"
    snap: true
    per_hour: "{{ item.snap_schedule.per_hour | default(omit) }}"
    per_day: "{{ item.snap_schedule.per_day | default(omit) }}"
    per_week: "{{ item.snap_schedule.per_week | default(omit) }}"
    per_month: "{{ item.snap_schedule.per_month | default(omit) }}"
    state: present
  loop: "{{ pgroups | default([]) }}"
  loop_control: { label: "{{ item.name }}" }
