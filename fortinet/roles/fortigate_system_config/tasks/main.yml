---
# tasks file for fortigate_system_config

- name: Configure FortiGate system settings
  tags:
    - fortigate
    - system
    - config
  block:
    - name: Set system global settings
      fortinet.fortios.fortios_system_global:
        vdom: "{{ fortigate_vdom }}"
        access_token: "{{ fortigate_api_token | default(omit) }}"
        enable_log: true
        system_global:
          admin_concurrent: "{{ fortigate_global_settings.admin_concurrent }}"
          admin_console_timeout: "{{ fortigate_global_settings.admin_console_timeout }}"
          admin_https_pki_required: "{{ fortigate_global_settings.admin_https_pki_required }}"
          admin_https_redirect: "{{ fortigate_global_settings.admin_https_redirect }}"
          admin_lockout_duration: "{{ fortigate_global_settings.admin_lockout_duration }}"
          admin_lockout_threshold: "{{ fortigate_global_settings.admin_lockout_threshold }}"
          admin_login_max: "{{ fortigate_global_settings.admin_login_max }}"
          admin_port: "{{ fortigate_global_settings.admin_port }}"
          admin_scp: "{{ fortigate_global_settings.admin_scp }}"
          admin_server_cert: "{{ fortigate_global_settings.admin_server_cert }}"
          admin_sport: "{{ fortigate_global_settings.admin_sport }}"
          admin_ssh_grace_time: "{{ fortigate_global_settings.admin_ssh_grace_time }}"
          admin_ssh_password: "{{ fortigate_global_settings.admin_ssh_password }}"
          admin_ssh_port: "{{ fortigate_global_settings.admin_ssh_port }}"
          admin_ssh_v1: "{{ fortigate_global_settings.admin_ssh_v1 }}"
          admin_telnet: "{{ fortigate_global_settings.admin_telnet }}"
          admintimeout: "{{ fortigate_global_settings.admintimeout }}"
          alias: "{{ fortigate_global_settings.alias }}"
          allow_traffic_redirect: "{{ fortigate_global_settings.allow_traffic_redirect }}"
          anti_replay: "{{ fortigate_global_settings.anti_replay }}"
          arp_max_entry: "{{ fortigate_global_settings.arp_max_entry }}"
          asymroute: "{{ fortigate_global_settings.asymroute }}"
          auto_auth_extension_device: "{{ fortigate_global_settings.auto_auth_extension_device }}"
          autorun_log_fsck: "{{ fortigate_global_settings.autorun_log_fsck }}"
          av_affinity: "{{ fortigate_global_settings.av_affinity }}"
          av_failopen: "{{ fortigate_global_settings.av_failopen }}"
          av_failopen_session: "{{ fortigate_global_settings.av_failopen_session }}"
          batch_cmdb: "{{ fortigate_global_settings.batch_cmdb }}"
          block_session_timer: "{{ fortigate_global_settings.block_session_timer }}"
          cfg_revert_timeout: "{{ fortigate_global_settings.cfg_revert_timeout }}"
          cfg_save: "{{ fortigate_global_settings.cfg_save }}"
          check_protocol_header: "{{ fortigate_global_settings.check_protocol_header }}"
          check_reset_range: "{{ fortigate_global_settings.check_reset_range }}"
          cli_audit_log: "{{ fortigate_global_settings.cli_audit_log }}"
          cloud_communication: "{{ fortigate_global_settings.cloud_communication }}"
          clt_cert_req: "{{ fortigate_global_settings.clt_cert_req }}"
          cpu_use_threshold: "{{ fortigate_global_settings.cpu_use_threshold }}"
          csr_ca_attribute: "{{ fortigate_global_settings.csr_ca_attribute }}"
          daily_restart: "{{ fortigate_global_settings.daily_restart }}"
          default_service_source_port: "{{ fortigate_global_settings.default_service_source_port }}"
          device_idle_timeout: "{{ fortigate_global_settings.device_idle_timeout }}"
          dh_params: "{{ fortigate_global_settings.dh_params }}"
          dst: "{{ fortigate_global_settings.dst }}"
          failtime: "{{ fortigate_global_settings.failtime }}"
          fds_statistics: "{{ fortigate_global_settings.fds_statistics }}"
          fds_statistics_period: "{{ fortigate_global_settings.fds_statistics_period }}"
          fgd_alert_subscription: "{{ fortigate_global_settings.fgd_alert_subscription }}"
          fortiextender: "{{ fortigate_global_settings.fortiextender }}"
          gui_allow_default_hostname: "{{ fortigate_global_settings.gui_allow_default_hostname }}"
          gui_certificates: "{{ fortigate_global_settings.gui_certificates }}"
          gui_custom_language: "{{ fortigate_global_settings.gui_custom_language }}"
          gui_date_format: "{{ fortigate_global_settings.gui_date_format }}"
          gui_date_time_source: "{{ fortigate_global_settings.gui_date_time_source }}"
          gui_display_hostname: "{{ fortigate_global_settings.gui_display_hostname }}"
          gui_firmware_upgrade_warning: "{{ fortigate_global_settings.gui_firmware_upgrade_warning }}"
          gui_ipv6: "{{ fortigate_global_settings.gui_ipv6 }}"
          gui_lines_per_page: "{{ fortigate_global_settings.gui_lines_per_page }}"
          gui_theme: "{{ fortigate_global_settings.gui_theme }}"
          gui_wireless_opensecurity: "{{ fortigate_global_settings.gui_wireless_opensecurity }}"
          honor_df: "{{ fortigate_global_settings.honor_df }}"
          hostname: "{{ fortigate_hostname }}"
          igmp_state_limit: "{{ fortigate_global_settings.igmp_state_limit }}"
          ike_embryonic_limit: "{{ fortigate_global_settings.ike_embryonic_limit }}"
          ike_quick_crash_detect: "{{ fortigate_global_settings.ike_quick_crash_detect }}"
          ike_session_resume: "{{ fortigate_global_settings.ike_session_resume }}"
          implicit_allow_dns: "{{ fortigate_global_settings.implicit_allow_dns }}"
          internet_service_database: "{{ fortigate_global_settings.internet_service_database }}"
          interval: "{{ fortigate_global_settings.interval }}"
          ip_src_port_range: "{{ fortigate_global_settings.ip_src_port_range }}"
          ips_affinity: "{{ fortigate_global_settings.ips_affinity }}"
          ipsec_asic_offload: "{{ fortigate_global_settings.ipsec_asic_offload }}"
          ipsec_hmac_offload: "{{ fortigate_global_settings.ipsec_hmac_offload }}"
          ipsec_soft_dec_async: "{{ fortigate_global_settings.ipsec_soft_dec_async }}"
          ipv6_accept_dad: "{{ fortigate_global_settings.ipv6_accept_dad }}"
          ipv6_allow_anycast_probe: "{{ fortigate_global_settings.ipv6_allow_anycast_probe }}"
          language: "{{ fortigate_global_settings.language }}"
          ldapconntimeout: "{{ fortigate_global_settings.ldapconntimeout }}"
          lldp_reception: "{{ fortigate_global_settings.lldp_reception }}"
          lldp_transmission: "{{ fortigate_global_settings.lldp_transmission }}"
          log_ssl_connection: "{{ fortigate_global_settings.log_ssl_connection }}"
          log_uuid_address: "{{ fortigate_global_settings.log_uuid_address }}"
          log_uuid_policy: "{{ fortigate_global_settings.log_uuid_policy }}"
          login_timestamp: "{{ fortigate_global_settings.login_timestamp }}"
          long_vdom_name: "{{ fortigate_global_settings.long_vdom_name }}"
          management_vdom: "{{ fortigate_global_settings.management_vdom }}"
          max_dlpstat_memory: "{{ fortigate_global_settings.max_dlpstat_memory }}"
          max_route_cache_size: "{{ fortigate_global_settings.max_route_cache_size }}"
          memory_use_threshold_extreme: "{{ fortigate_global_settings.memory_use_threshold_extreme }}"
          memory_use_threshold_green: "{{ fortigate_global_settings.memory_use_threshold_green }}"
          memory_use_threshold_red: "{{ fortigate_global_settings.memory_use_threshold_red }}"
          multi_factor_authentication: "{{ fortigate_global_settings.multi_factor_authentication }}"
          multicast_forward: "{{ fortigate_global_settings.multicast_forward }}"
          ndp_max_entry: "{{ fortigate_global_settings.ndp_max_entry }}"
          per_user_bwl: "{{ fortigate_global_settings.per_user_bwl }}"
          policy_auth_concurrent: "{{ fortigate_global_settings.policy_auth_concurrent }}"
          post_login_banner: "{{ fortigate_global_settings.post_login_banner }}"
          pre_login_banner: "{{ fortigate_global_settings.pre_login_banner }}"
          private_data_encryption: "{{ fortigate_global_settings.private_data_encryption }}"
          proxy_auth_lifetime: "{{ fortigate_global_settings.proxy_auth_lifetime }}"
          proxy_auth_lifetime_timeout: "{{ fortigate_global_settings.proxy_auth_lifetime_timeout }}"
          proxy_auth_timeout: "{{ fortigate_global_settings.proxy_auth_timeout }}"
          proxy_re_authentication_mode: "{{ fortigate_global_settings.proxy_re_authentication_mode }}"
          proxy_worker_count: "{{ fortigate_global_settings.proxy_worker_count }}"
          radius_port: "{{ fortigate_global_settings.radius_port }}"
          reboot_upon_config_restore: "{{ fortigate_global_settings.reboot_upon_config_restore }}"
          refresh: "{{ fortigate_global_settings.refresh }}"
          remoteauthtimeout: "{{ fortigate_global_settings.remoteauthtimeout }}"
          reset_sessionless_tcp: "{{ fortigate_global_settings.reset_sessionless_tcp }}"
          restart_time: "{{ fortigate_global_settings.restart_time }}"
          revision_backup_on_logout: "{{ fortigate_global_settings.revision_backup_on_logout }}"
          revision_image_auto_backup: "{{ fortigate_global_settings.revision_image_auto_backup }}"
          scanunit_count: "{{ fortigate_global_settings.scanunit_count }}"
          security_rating_result_submission: "{{ fortigate_global_settings.security_rating_result_submission }}"
          security_rating_run_on_schedule: "{{ fortigate_global_settings.security_rating_run_on_schedule }}"
          send_pmtu_icmp: "{{ fortigate_global_settings.send_pmtu_icmp }}"
          snat_route_change: "{{ fortigate_global_settings.snat_route_change }}"
          special_file_23_support: "{{ fortigate_global_settings.special_file_23_support }}"
          speedtest_server: "{{ fortigate_global_settings.speedtest_server }}"
          ssd_trim_freq: "{{ fortigate_global_settings.ssd_trim_freq }}"
          ssh_cbc_cipher: "{{ fortigate_global_settings.ssh_cbc_cipher }}"
          ssh_hmac_md5: "{{ fortigate_global_settings.ssh_hmac_md5 }}"
          ssh_kex_sha1: "{{ fortigate_global_settings.ssh_kex_sha1 }}"
          ssh_mac_weak: "{{ fortigate_global_settings.ssh_mac_weak }}"
          ssl_min_proto_version: "{{ fortigate_global_settings.ssl_min_proto_version }}"
          ssl_static_key_ciphers: "{{ fortigate_global_settings.ssl_static_key_ciphers }}"
          sslvpn_cipher_hardware_acceleration: "{{ fortigate_global_settings.sslvpn_cipher_hardware_acceleration }}"
          sslvpn_kxp_hardware_acceleration: "{{ fortigate_global_settings.sslvpn_kxp_hardware_acceleration }}"
          sslvpn_max_worker_count: "{{ fortigate_global_settings.sslvpn_max_worker_count }}"
          sslvpn_plugin_version_check: "{{ fortigate_global_settings.sslvpn_plugin_version_check }}"
          strict_dirty_session_check: "{{ fortigate_global_settings.strict_dirty_session_check }}"
          strong_crypto: "{{ fortigate_global_settings.strong_crypto }}"
          switch_controller: "{{ fortigate_global_settings.switch_controller }}"
          sync_session_ttl: "{{ fortigate_global_settings.sync_session_ttl }}"
          tcp_halfclose_timer: "{{ fortigate_global_settings.tcp_halfclose_timer }}"
          tcp_halfopen_timer: "{{ fortigate_global_settings.tcp_halfopen_timer }}"
          tcp_option: "{{ fortigate_global_settings.tcp_option }}"
          tcp_timewait_timer: "{{ fortigate_global_settings.tcp_timewait_timer }}"
          tftp: "{{ fortigate_global_settings.tftp }}"
          timezone: "{{ fortigate_global_settings.timezone }}"
          traffic_priority: "{{ fortigate_global_settings.traffic_priority }}"
          traffic_priority_level: "{{ fortigate_global_settings.traffic_priority_level }}"
          two_factor_email_expiry: "{{ fortigate_global_settings.two_factor_email_expiry }}"
          two_factor_fac_expiry: "{{ fortigate_global_settings.two_factor_fac_expiry }}"
          two_factor_ftk_expiry: "{{ fortigate_global_settings.two_factor_ftk_expiry }}"
          two_factor_ftm_expiry: "{{ fortigate_global_settings.two_factor_ftm_expiry }}"
          two_factor_sms_expiry: "{{ fortigate_global_settings.two_factor_sms_expiry }}"
          udp_idle_timer: "{{ fortigate_global_settings.udp_idle_timer }}"
          user_device_store_max_devices: "{{ fortigate_global_settings.user_device_store_max_devices }}"
          user_server_cert: "{{ fortigate_global_settings.user_server_cert }}"
          vdom_admin: "{{ fortigate_global_settings.vdom_admin }}"
          vip_arp_range: "{{ fortigate_global_settings.vip_arp_range }}"
          wad_affinity: "{{ fortigate_global_settings.wad_affinity }}"
          wad_csvc_cs_count: "{{ fortigate_global_settings.wad_csvc_cs_count }}"
          wad_csvc_db_count: "{{ fortigate_global_settings.wad_csvc_db_count }}"
          wad_source_affinity: "{{ fortigate_global_settings.wad_source_affinity }}"
          wad_worker_count: "{{ fortigate_global_settings.wad_worker_count }}"
          wifi_ca_certificate: "{{ fortigate_global_settings.wifi_ca_certificate }}"
          wifi_certificate: "{{ fortigate_global_settings.wifi_certificate }}"
          wireless_controller: "{{ fortigate_global_settings.wireless_controller }}"
      notify: Save FortiGate config

    - name: Configure DNS servers
      fortinet.fortios.fortios_system_dns:
        vdom: "{{ fortigate_vdom }}"
        access_token: "{{ fortigate_api_token | default(omit) }}"
        enable_log: true
        system_dns:
          primary: "{{ fortigate_dns_primary }}"
          secondary: "{{ fortigate_dns_secondary }}"
          dns_over_tls: "disable"
          ssl_certificate: ""
          server_hostname: []
          domain: "{{ fortigate_domain }}"
          ip6_primary: "::"
          ip6_secondary: "::"
          timeout: 5
          retry: 2
          dns_cache_limit: 5000
          dns_cache_ttl: 1800
          cache_notfound_responses: "disable"
          source_ip: "0.0.0.0"
      notify: Save FortiGate config

    - name: Configure NTP servers
      fortinet.fortios.fortios_system_ntp:
        vdom: "{{ fortigate_vdom }}"
        access_token: "{{ fortigate_api_token | default(omit) }}"
        enable_log: true
        system_ntp:
          ntpsync: "enable"
          type: "fortiguard"
          syncinterval: "{{ fortigate_ntp_sync_interval }}"
          source_ip: "0.0.0.0"
          source_ip6: "::"
          server_mode: "disable"
          authentication: "disable"
          ntpserver:
            "{{ fortigate_ntp_servers }}"
          interface: []
      notify: Save FortiGate config

    - name: Configure admin accounts
      fortinet.fortios.fortios_system_admin:
        vdom: "{{ fortigate_vdom }}"
        access_token: "{{ fortigate_api_token | default(omit) }}"
        enable_log: true
        state: present
        system_admin:
          name: "{{ item.name }}"
          password: "{{ item.password }}"
          trusthost1: "{{ item.trusthost1 | default('0.0.0.0/0') }}"
          trusthost2: "{{ item.trusthost2 | default('0.0.0.0/0') }}"
          trusthost3: "{{ item.trusthost3 | default('0.0.0.0/0') }}"
          trusthost4: "0.0.0.0/0"
          trusthost5: "0.0.0.0/0"
          trusthost6: "0.0.0.0/0"
          trusthost7: "0.0.0.0/0"
          trusthost8: "0.0.0.0/0"
          trusthost9: "0.0.0.0/0"
          trusthost10: "0.0.0.0/0"
          ip6_trusthost1: "::/0"
          ip6_trusthost2: "::/0"
          ip6_trusthost3: "::/0"
          ip6_trusthost4: "::/0"
          ip6_trusthost5: "::/0"
          ip6_trusthost6: "::/0"
          ip6_trusthost7: "::/0"
          ip6_trusthost8: "::/0"
          ip6_trusthost9: "::/0"
          ip6_trusthost10: "::/0"
          accprofile: "{{ item.accprofile }}"
          allow_remove_admin_session: "enable"
          comments: "{{ item.comments | default('') }}"
          hidden: 0
          vdom: "{{ item.vdom | default(fortigate_vdom) }}"
          force_password_change: "{{ item.force_password_change | default('disable') }}"
          two_factor: "disable"
          fortitoken: ""
          email_to: ""
          sms_server: "fortiguard"
          sms_custom_server: ""
          sms_phone: ""
          guest_auth: "disable"
          guest_usergroups: []
          guest_lang: "english"
          history0: ""
          history1: ""
          login_time: []
          gui_dashboard: []
          gui_global_menu_favorites: []
          gui_vdom_menu_favorites: []
          gui_new_feature_acknowledge: []
          peer_auth: "disable"
          peer_group: ""
          radius_vdom_override: "disable"
          remote_auth: "disable"
          remote_group: ""
          schedule: ""
          wildcard: "disable"
      loop: "{{ fortigate_admin_accounts }}"
      loop_control:
        label: "{{ item.name }}"
      no_log: true
      notify: Save FortiGate config

    - name: Configure SNMPv3 users
      fortinet.fortios.fortios_system_snmp_user:
        vdom: "{{ fortigate_vdom }}"
        access_token: "{{ fortigate_api_token | default(omit) }}"
        enable_log: true
        state: present
        system_snmp_user:
          name: "{{ item.name }}"
          status: "enable"
          trap_status: "enable"
          trap_lport: 162
          trap_rport: 162
          queries: "{{ item.queries }}"
          query_port: 161
          notify_hosts: ""
          notify_hosts6: ""
          source_ip: "0.0.0.0"
          source_ipv6: "::"
          ha_direct: "disable"
          events: "{{ item.events }}"
          mib_view: "all"
          vdoms: []
          security_level: "{{ item.security_level }}"
          auth_proto: "{{ item.auth_proto }}"
          auth_pwd: "{{ item.auth_pwd }}"
          priv_proto: "{{ item.priv_proto }}"
          priv_pwd: "{{ item.priv_pwd }}"
      loop: "{{ fortigate_snmp_v3_users }}"
      loop_control:
        label: "{{ item.name }}"
      when: fortigate_snmp_enabled | bool
      no_log: true
      notify: Save FortiGate config

    - name: Configure SNMP community (disabled by default)
      fortinet.fortios.fortios_system_snmp_community:
        vdom: "{{ fortigate_vdom }}"
        access_token: "{{ fortigate_api_token | default(omit) }}"
        enable_log: true
        state: present
        system_snmp_community:
          id: "{{ item.id }}"
          name: "{{ item.name }}"
          status: "{{ item.status }}"
          hosts: "{{ item.hosts }}"
          hosts6: []
          query_v1_status: "disable"
          query_v1_port: 161
          query_v2c_status: "disable"
          query_v2c_port: 161
          trap_v1_status: "disable"
          trap_v1_lport: 162
          trap_v1_rport: 162
          trap_v2c_status: "disable"
          trap_v2c_lport: 162
          trap_v2c_rport: 162
          events: "cpu_high mem_low log_full intf_ip vpn_tun_up vpn_tun_down ha_switch ha_hb_failure"
          mib_view: "all"
          vdoms: []
      loop: "{{ fortigate_snmp_community }}"
      loop_control:
        label: "{{ item.name }}"
      when: fortigate_snmp_enabled | bool
      no_log: true
      notify: Save FortiGate config

    - name: Enable SNMP system settings
      fortinet.fortios.fortios_system_snmp_sysinfo:
        vdom: "{{ fortigate_vdom }}"
        access_token: "{{ fortigate_api_token | default(omit) }}"
        enable_log: true
        system_snmp_sysinfo:
          status: "enable"
          engine_id: ""
          description: "{{ fortigate_hostname }} - FortiGate Firewall"
          contact_info: "{{ snmp_contact | default('admin@' + fortigate_domain) }}"
          location: "{{ snmp_location | default('Data Center') }}"
          trap_high_cpu_threshold: 80
          trap_low_memory_threshold: 80
          trap_log_full_threshold: 90
      when: fortigate_snmp_enabled | bool
      notify: Save FortiGate config

    - name: Configure password policy
      fortinet.fortios.fortios_system_password_policy:
        vdom: "{{ fortigate_vdom }}"
        access_token: "{{ fortigate_api_token | default(omit) }}"
        enable_log: true
        system_password_policy:
          status: "{{ fortigate_password_policy.status }}"
          apply_to: "{{ fortigate_password_policy.apply_to }}"
          minimum_length: "{{ fortigate_password_policy.minimum_length }}"
          min_lower_case_letter: "{{ fortigate_password_policy.min_lower_case_letter }}"
          min_upper_case_letter: "{{ fortigate_password_policy.min_upper_case_letter }}"
          min_non_alphanumeric: "{{ fortigate_password_policy.min_non_alphanumeric }}"
          min_number: "{{ fortigate_password_policy.min_number }}"
          change_4_characters: "{{ fortigate_password_policy.change_4_characters }}"
          expire_status: "{{ fortigate_password_policy.expire_status }}"
          expire_day: "{{ fortigate_password_policy.expire_day }}"
          reuse_password: "{{ fortigate_password_policy.reuse_password }}"
      notify: Save FortiGate config

    - name: Configure FortiGuard settings
      fortinet.fortios.fortios_system_fortiguard:
        vdom: "{{ fortigate_vdom }}"
        access_token: "{{ fortigate_api_token | default(omit) }}"
        enable_log: true
        system_fortiguard:
          protocol: "{{ fortigate_fortiguard.protocol }}"
          port: "{{ fortigate_fortiguard.port }}"
          service_account_id: "{{ fortigate_fortiguard.service_account_id }}"
          load_balance_servers: "{{ fortigate_fortiguard.load_balance_servers }}"
          auto_join_forticloud: "{{ fortigate_fortiguard.auto_join_forticloud }}"
          update_server_location: "{{ fortigate_fortiguard.update_server_location }}"
          sandbox_region: "{{ fortigate_fortiguard.sandbox_region }}"
          antispam_force_off: "{{ fortigate_fortiguard.antispam_force_off }}"
          antispam_cache: "{{ fortigate_fortiguard.antispam_cache }}"
          antispam_cache_ttl: "{{ fortigate_fortiguard.antispam_cache_ttl }}"
          antispam_cache_mpercent: "{{ fortigate_fortiguard.antispam_cache_mpercent }}"
          antispam_license: "{{ fortigate_fortiguard.antispam_license }}"
          antispam_expiration: "{{ fortigate_fortiguard.antispam_expiration }}"
          antispam_timeout: "{{ fortigate_fortiguard.antispam_timeout }}"
          outbreak_prevention_force_off: "{{ fortigate_fortiguard.outbreak_prevention_force_off }}"
          outbreak_prevention_cache: "{{ fortigate_fortiguard.outbreak_prevention_cache }}"
          outbreak_prevention_cache_ttl: "{{ fortigate_fortiguard.outbreak_prevention_cache_ttl }}"
          outbreak_prevention_cache_mpercent: "{{ fortigate_fortiguard.outbreak_prevention_cache_mpercent }}"
          outbreak_prevention_license: "{{ fortigate_fortiguard.outbreak_prevention_license }}"
          outbreak_prevention_expiration: "{{ fortigate_fortiguard.outbreak_prevention_expiration }}"
          outbreak_prevention_timeout: "{{ fortigate_fortiguard.outbreak_prevention_timeout }}"
          webfilter_force_off: "{{ fortigate_fortiguard.webfilter_force_off }}"
          webfilter_cache: "{{ fortigate_fortiguard.webfilter_cache }}"
          webfilter_cache_ttl: "{{ fortigate_fortiguard.webfilter_cache_ttl }}"
          webfilter_license: "{{ fortigate_fortiguard.webfilter_license }}"
          webfilter_expiration: "{{ fortigate_fortiguard.webfilter_expiration }}"
          webfilter_timeout: "{{ fortigate_fortiguard.webfilter_timeout }}"
          sdns_server_ip: "{{ fortigate_fortiguard.sdns_server_ip }}"
          sdns_server_port: "{{ fortigate_fortiguard.sdns_server_port }}"
          anycast_sdns_server_ip: "{{ fortigate_fortiguard.anycast_sdns_server_ip }}"
          anycast_sdns_server_port: "{{ fortigate_fortiguard.anycast_sdns_server_port }}"
          sdns_options: "{{ fortigate_fortiguard.sdns_options }}"
          source_ip: "{{ fortigate_fortiguard.source_ip }}"
          source_ip6: "{{ fortigate_fortiguard.source_ip6 }}"
          auto_firmware_upgrade: "{{ fortigate_fortiguard.auto_firmware_upgrade }}"
          auto_firmware_upgrade_day: "{{ fortigate_fortiguard.auto_firmware_upgrade_day }}"
          auto_firmware_upgrade_delay: "{{ fortigate_fortiguard.auto_firmware_upgrade_delay }}"
          auto_firmware_upgrade_start_hour: "{{ fortigate_fortiguard.auto_firmware_upgrade_start_hour }}"
          auto_firmware_upgrade_end_hour: "{{ fortigate_fortiguard.auto_firmware_upgrade_end_hour }}"
      notify: Save FortiGate config

    - name: Configure email server for alerts
      fortinet.fortios.fortios_system_email_server:
        vdom: "{{ fortigate_vdom }}"
        access_token: "{{ fortigate_api_token | default(omit) }}"
        enable_log: true
        system_email_server:
          type: "custom"
          reply_to: "{{ fortigate_email_server.reply_to }}"
          server: "{{ fortigate_email_server.server }}"
          port: "{{ fortigate_email_server.port }}"
          source_ip: "{{ fortigate_email_server.source_ip }}"
          source_ip6: "{{ fortigate_email_server.source_ip6 }}"
          authenticate: "{{ fortigate_email_server.authenticate }}"
          validate_server: "{{ fortigate_email_server.validate_server }}"
          username: "{{ fortigate_email_server.username }}"
          password: "{{ fortigate_email_server.password }}"
          security: "{{ fortigate_email_server.security }}"
          ssl_min_proto_version: "{{ fortigate_email_server.ssl_min_proto_version }}"
      notify: Save FortiGate config

    - name: Upload certificates
      fortinet.fortios.fortios_certificate_local:
        vdom: "{{ fortigate_vdom }}"
        access_token: "{{ fortigate_api_token | default(omit) }}"
        enable_log: true
        state: present
        certificate_local:
          name: "{{ item.name }}"
          password: "{{ item.password | default('') }}"
          comments: "{{ item.comments | default('') }}"
          private_key: "{{ item.private_key }}"
          certificate: "{{ item.certificate }}"
      loop: "{{ fortigate_certificates }}"
      loop_control:
        label: "{{ item.name }}"
      when: fortigate_certificates | length > 0
      no_log: true
      notify: Save FortiGate config

    - name: Set pre-login banner
      fortinet.fortios.fortios_system_global:
        vdom: "{{ fortigate_vdom }}"
        access_token: "{{ fortigate_api_token | default(omit) }}"
        enable_log: true
        system_global:
          pre_login_banner: "enable"
      when: fortigate_pre_login_banner | length > 0
      notify: Save FortiGate config

    - name: Configure replacement message for pre-login banner
      fortinet.fortios.fortios_system_replacemsg_admin:
        vdom: "{{ fortigate_vdom }}"
        access_token: "{{ fortigate_api_token | default(omit) }}"
        enable_log: true
        state: present
        system_replacemsg_admin:
          msg_type: "pre-admin-disclaimer-text"
          buffer: "{{ fortigate_pre_login_banner }}"
          format: "text"
          header: "none"
      when: fortigate_pre_login_banner | length > 0
      notify: Save FortiGate config

    - name: Display configuration summary
      ansible.builtin.debug:
        msg:
          - "FortiGate System Configuration Complete"
          - "========================================="
          - "Hostname: {{ fortigate_hostname }}.{{ fortigate_domain }}"
          - "Timezone: {{ fortigate_timezone }}"
          - "DNS Primary: {{ fortigate_dns_primary }}"
          - "DNS Secondary: {{ fortigate_dns_secondary }}"
          - "NTP Servers: {{ fortigate_ntp_servers | map(attribute='server') | list | join(', ') }}"
          - "Admin Accounts: {{ fortigate_admin_accounts | map(attribute='name') | list | join(', ') }}"
          - "SNMP Enabled: {{ fortigate_snmp_enabled }}"
          - "Password Policy: {{ fortigate_password_policy.status }}"
          - "SSL Min Version: {{ fortigate_global_settings.ssl_min_proto_version }}"
          - "Strong Crypto: {{ fortigate_global_settings.strong_crypto }}"

  rescue:
    - name: Configuration error occurred
      ansible.builtin.fail:
        msg: "Failed to configure FortiGate system settings: {{ ansible_failed_result.msg }}"
