---
- name: ans_ctrl__analytics_usage.yml
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    controller_host: "{{ controller_host | default('https://controller.example.mil') }}"
    controller_oauthtoken: "{{ controller_oauthtoken | default(lookup('env','TOWER_TOKEN')) }}"
    validate_certs: "{{ validate_certs | default(true) }}"
    artifacts_dir: "{{ artifacts_dir | default('/tmp/ansible-controller-artifacts') }}"
    apply_changes: "{{ apply_changes | default(false) }}"

  pre_tasks:
    - name: Ensure artifacts directory
      ansible.builtin.file:
        path: "{{ artifacts_dir }}"
        state: directory
        mode: "0750"

  tasks:
    - name: Fetch basic usage stats (JT count)
      ansible.builtin.uri:
        url: "{{ controller_host }}/api/v2/job_templates/"
        method: GET
        headers:
          Authorization: "Bearer {{ controller_oauthtoken }}"
        validate_certs: "{{ validate_certs }}"
      register: jts
      changed_when: false
      no_log: true

    - name: Write usage CSV (placeholder counts)
      ansible.builtin.copy:
        dest: "{{ artifacts_dir }}/analytics_usage.csv"
        mode: "0640"
        content: "metric,value\njob_templates,{{ jts.json.count | default(0) }}\n"
