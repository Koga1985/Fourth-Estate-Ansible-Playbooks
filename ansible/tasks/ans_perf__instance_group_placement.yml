---
- name: ans_perf__instance_group_placement.yml
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    artifacts_dir: "{{ artifacts_dir | default('/tmp/ansible-core-artifacts') }}"
    apply_changes: "{{ apply_changes | default(false) }}"

  pre_tasks:
    - name: Ensure artifacts directory
      ansible.builtin.file:
        path: "{{ artifacts_dir }}"
        state: directory
        mode: "0755"

vars:
  controller_host: "{{ controller_host | default('https://controller.example.mil') }}"
  controller_oauthtoken: "{{ controller_oauthtoken | default(lookup('env','TOWER_TOKEN')) }}"
  validate_certs: "{{ validate_certs | default(true) }}"
  placements: "{{ placements | default([]) }}"
tasks:
  - name: Plan JT→instance group placements
    ansible.builtin.copy:
      dest: "{{ artifacts_dir }}/instance_group_placements.json"
      mode: "0644"
      content: "{{ placements | to_nice_json }}"

  - name: Apply placements to Job Templates
    when: apply_changes | bool
    loop: "{{ placements }}"
    loop_control: { label: "{{ item.job_template }} → {{ (item.instance_groups | join(',')) if (item.instance_groups|length>0) else 'default' }}" }
    ansible.controller.job_template:
      controller_host: "{{ controller_host }}"
      controller_oauthtoken: "{{ controller_oauthtoken }}"
      validate_certs: "{{ validate_certs }}"
      name: "{{ item.job_template }}"
      organization: "{{ item.organization | default(omit) }}"
      instance_groups: "{{ item.instance_groups | default(omit) }}"
      state: present
