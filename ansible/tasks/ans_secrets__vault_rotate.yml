---
- name: ans_secrets__vault_rotate.yml
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    artifacts_dir: "{{ artifacts_dir | default('/tmp/ansible-core-artifacts') }}"
    apply_changes: "{{ apply_changes | default(false) }}"

  pre_tasks:
    - name: Ensure artifacts directory
      ansible.builtin.file:
        path: "{{ artifacts_dir }}"
        state: directory
        mode: "0755"

vars:
  repo_root: "{{ repo_root | default('.') }}"
  vault_id_label: "{{ vault_id_label | default('default') }}"
  new_vault_password_file: "{{ new_vault_password_file | default('~/.vault_pass_new.txt') }}"
tasks:
  - name: Find vaulted files
    ansible.builtin.shell: |
      set -euo pipefail
      grep -rl "^\$ANSIBLE_VAULT;" "{{ repo_root }}" || true
    args: { executable: /bin/bash }
    register: vaulted
    changed_when: false

  - name: Write vaulted files list
    ansible.builtin.copy:
      dest: "{{ artifacts_dir }}/vaulted_files.txt"
      mode: "0644"
      content: "{{ (vaulted.stdout_lines | default([])) | join('\n') }}\n"

  - name: Rekey vaulted files (guarded)
    when: apply_changes | bool and (vaulted.stdout_lines | length > 0)
    ansible.builtin.shell: |
      set -euo pipefail
      while read -r f; do
        [ -z "$f" ] && continue
        ansible-vault rekey --vault-id {{ vault_id_label }}@prompt --new-vault-password-file {{ new_vault_password_file }} "$f"
      done < "{{ artifacts_dir }}/vaulted_files.txt"
    args: { executable: /bin/bash }
