---
- name: ans_secrets__env_to_vault.yml
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    artifacts_dir: "{{ artifacts_dir | default('/tmp/ansible-core-artifacts') }}"
    apply_changes: "{{ apply_changes | default(false) }}"

  pre_tasks:
    - name: Ensure artifacts directory
      ansible.builtin.file:
        path: "{{ artifacts_dir }}"
        state: directory
        mode: "0755"

vars:
  files_to_encrypt: "{{ files_to_encrypt | default([]) }}"
  vault_id_label: "{{ vault_id_label | default('default') }}"
tasks:
  - name: Plan files to encrypt
    ansible.builtin.copy:
      dest: "{{ artifacts_dir }}/encrypt_plan.json"
      mode: "0644"
      content: "{{ files_to_encrypt | to_nice_json }}"

  - name: Encrypt files with ansible-vault (guarded)
    when: apply_changes | bool
    loop: "{{ files_to_encrypt }}"
    loop_control: { label: "{{ item }}" }
    ansible.builtin.shell: |
      set -euo pipefail
      ansible-vault encrypt --vault-id {{ vault_id_label }}@prompt "{{ item }}"
    args: { executable: /bin/bash }
