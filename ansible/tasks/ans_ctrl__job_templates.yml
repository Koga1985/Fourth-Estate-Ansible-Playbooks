---
- name: ans_ctrl__job_templates.yml
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    controller_host: "{{ controller_host | default('https://controller.example.mil') }}"
    controller_oauthtoken: "{{ controller_oauthtoken | default(lookup('env','TOWER_TOKEN')) }}"
    validate_certs: "{{ validate_certs | default(true) }}"
    artifacts_dir: "{{ artifacts_dir | default('/tmp/ansible-controller-artifacts') }}"
    apply_changes: "{{ apply_changes | default(false) }}"

  pre_tasks:
    - name: Ensure artifacts directory
      ansible.builtin.file:
        path: "{{ artifacts_dir }}"
        state: directory
        mode: "0750"

  tasks:
    - name: Plan job/workflow templates
      ansible.builtin.copy:
        dest: "{{ artifacts_dir }}/job_templates_plan.json"
        mode: "0640"
      content: "{{ {'job_templates': job_templates | default([]), 'workflow_templates': workflow_templates | default([])} | to_nice_json }}"

    - name: Create job templates
      when: apply_changes | bool
      loop: "{{ job_templates | default([]) }}"
      loop_control: { label: "{{ item.name }}" }
      ansible.controller.job_template:
        controller_host: "{{ controller_host }}"
        controller_oauthtoken: "{{ controller_oauthtoken }}"
        validate_certs: "{{ validate_certs }}"
        name: "{{ item.name }}"
        organization: "{{ item.organization }}"
        inventory: "{{ item.inventory }}"
        project: "{{ item.project }}"
        playbook: "{{ item.playbook }}"
        execution_environment: "{{ item.execution_environment | default(omit) }}"
        credentials: "{{ item.credentials | default(omit) }}"
        survey_enabled: "{{ item.survey_enabled | default(false) }}"
        survey_spec: "{{ item.survey_spec | default(omit) }}"
        limit: "{{ item.limit | default(omit) }}"
        forks: "{{ item.forks | default(omit) }}"
        job_slice_count: "{{ item.job_slice_count | default(omit) }}"
        state: present

    - name: Create workflow job templates
      when: apply_changes | bool
      loop: "{{ workflow_templates | default([]) }}"
      loop_control: { label: "{{ item.name }}" }
      ansible.controller.workflow_job_template:
        controller_host: "{{ controller_host }}"
        controller_oauthtoken: "{{ controller_oauthtoken }}"
        validate_certs: "{{ validate_certs }}"
        name: "{{ item.name }}"
        organization: "{{ item.organization }}"
        state: present
