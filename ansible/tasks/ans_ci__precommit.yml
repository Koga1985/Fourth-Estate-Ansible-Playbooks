---
- name: ans_ci__precommit.yml
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    artifacts_dir: "{{ artifacts_dir | default('/tmp/ansible-core-artifacts') }}"
    apply_changes: "{{ apply_changes | default(false) }}"

  pre_tasks:
    - name: Ensure artifacts directory
      ansible.builtin.file:
        path: "{{ artifacts_dir }}"
        state: directory
        mode: "0755"

vars:
  repo_root: "{{ repo_root | default('.') }}"
tasks:
  - name: Create pre-commit config
    ansible.builtin.copy:
      dest: "{{ repo_root }}/.pre-commit-config.yaml"
      mode: "0644"
      content: |
        repos:
          - repo: https://github.com/pre-commit/pre-commit-hooks
            rev: v4.6.0
            hooks:
              - id: trailing-whitespace
              - id: end-of-file-fixer
              - id: check-yaml
          - repo: https://github.com/ansible-community/ansible-lint
            rev: v24.7.0
            hooks:
              - id: ansible-lint
          - repo: https://github.com/adrienverge/yamllint
            rev: v1.35.1
            hooks:
              - id: yamllint

  - name: Install pre-commit (optional, local)
    when: apply_changes | bool
    ansible.builtin.shell: |
      set -euo pipefail
      cd "{{ repo_root }}"
      if command -v pre-commit >/dev/null 2>&1; then
        pre-commit install
      fi
    args: { executable: /bin/bash }
    changed_when: false
