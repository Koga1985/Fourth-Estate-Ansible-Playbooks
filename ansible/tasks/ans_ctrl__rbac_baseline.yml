---
- name: ans_ctrl__rbac_baseline.yml
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    controller_host: "{{ controller_host | default('https://controller.example.mil') }}"
    controller_oauthtoken: "{{ controller_oauthtoken | default(lookup('env','TOWER_TOKEN')) }}"
    validate_certs: "{{ validate_certs | default(true) }}"
    artifacts_dir: "{{ artifacts_dir | default('/tmp/ansible-controller-artifacts') }}"
    apply_changes: "{{ apply_changes | default(false) }}"

  pre_tasks:
    - name: Ensure artifacts directory
      ansible.builtin.file:
        path: "{{ artifacts_dir }}"
        state: directory
        mode: "0750"

  tasks:
    - name: Plan RBAC baseline
      ansible.builtin.copy:
        dest: "{{ artifacts_dir }}/rbac_baseline_plan.json"
        mode: "0640"
      content: "{{ {'bindings': iam_bindings | default([])} | to_nice_json }}"

    - name: Apply RBAC bindings
      when: apply_changes | bool
      loop: "{{ iam_bindings | default([]) }}"
      loop_control: { label: "{{ item.principal }} â†’ {{ item.role }} on {{ item.object_type }} {{ item.object_name }}" }
      ansible.controller.role:
        controller_host: "{{ controller_host }}"
        controller_oauthtoken: "{{ controller_oauthtoken }}"
        validate_certs: "{{ validate_certs }}"
        user: "{{ (item.kind == 'user') | ternary(item.principal, omit) }}"
        team: "{{ (item.kind == 'team') | ternary(item.principal, omit) }}"
        role: "{{ item.role }}"
        target_organization: "{{ (item.object_type == 'organization') | ternary(item.object_name, omit) }}"
        target_project: "{{ (item.object_type == 'project') | ternary(item.object_name, omit) }}"
        target_inventory: "{{ (item.object_type == 'inventory') | ternary(item.object_name, omit) }}"
        target_credential: "{{ (item.object_type == 'credential') | ternary(item.object_name, omit) }}"
        target_job_template: "{{ (item.object_type == 'job_template') | ternary(item.object_name, omit) }}"
        state: present
