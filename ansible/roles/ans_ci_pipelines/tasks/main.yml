---
- name: Ensure artifacts directory exists
  ansible.builtin.file:
    path: "{{ artifacts_dir }}"
    state: directory
    mode: "0755"
  delegate_to: localhost

- name: Create CI configuration directory
  ansible.builtin.file:
    path: "{{ repo_root }}/ci"
    state: directory
    mode: "0755"
  when: apply_changes | bool

- name: Generate GitLab CI configuration
  when: apply_changes | bool and ci_platform == 'gitlab' and gitlab_ci_enabled
  ansible.builtin.template:
    src: gitlab-ci.yml.j2
    dest: "{{ repo_root }}/.gitlab-ci.yml"
    mode: "0644"

- name: Generate GitHub Actions workflows
  when: apply_changes | bool and ci_platform == 'github' and github_actions_enabled
  block:
    - name: Create GitHub workflows directory
      ansible.builtin.file:
        path: "{{ repo_root }}/{{ github_workflows_dir }}"
        state: directory
        mode: "0755"

    - name: Generate GitHub Actions main workflow
      ansible.builtin.template:
        src: github-actions-main.yml.j2
        dest: "{{ repo_root }}/{{ github_workflows_dir }}/main.yml"
        mode: "0644"

- name: Generate ansible-lint configuration
  when: apply_changes | bool and ci_pipeline_lint_enabled
  ansible.builtin.copy:
    dest: "{{ repo_root }}/.ansible-lint"
    mode: "0644"
    content: |
      ---
      skip_list:
        - yaml[line-length]
      warn_list:
        - no-handler
      use_default_rules: true
      parseable: true

- name: Create job templates for CI/CD in Controller
  when: apply_changes | bool and deploy_to_controller
  ansible.controller.job_template:
    controller_host: "{{ controller_host }}"
    controller_oauthtoken: "{{ controller_oauthtoken }}"
    controller_username: "{{ controller_username }}"
    controller_password: "{{ controller_password }}"
    validate_certs: "{{ validate_certs }}"
    name: "CI/CD - {{ item.name }}"
    job_type: "run"
    inventory: "Localhost"
    project: "Ansible Content Repository"
    playbook: "{{ item.playbook }}"
    state: present
  loop:
    - name: "Lint Content"
      playbook: "ci/playbooks/lint.yml"
    - name: "Test Content"
      playbook: "ci/playbooks/test.yml"
    - name: "Build Execution Environments"
      playbook: "ci/playbooks/build-ee.yml"
  loop_control:
    label: "{{ item.name }}"

- name: Generate CI/CD pipeline summary report
  ansible.builtin.copy:
    dest: "{{ artifacts_dir }}/ci_pipeline_summary.json"
    mode: "0644"
    content: |
      {
        "platform": "{{ ci_platform }}",
        "lint_enabled": {{ ci_pipeline_lint_enabled | bool | lower }},
        "test_enabled": {{ ci_pipeline_test_enabled | bool | lower }},
        "build_ee_enabled": {{ ci_pipeline_build_ee_enabled | bool | lower }},
        "fourth_estate_features": {
          "content_signing": {{ fourth_estate_content_signing | bool | lower }},
          "compliance_checks": {{ fourth_estate_compliance_checks | bool | lower }},
          "audit_logging": {{ fourth_estate_audit_logging | bool | lower }}
        }
      }
  delegate_to: localhost

- name: Display CI/CD configuration summary
  ansible.builtin.debug:
    msg:
      - "CI/CD Platform: {{ ci_platform }}"
      - "Pipeline Stages: Lint={{ ci_pipeline_lint_enabled }}, Test={{ ci_pipeline_test_enabled }}, Build={{ ci_pipeline_build_ee_enabled }}"
      - "Summary Report: {{ artifacts_dir }}/ci_pipeline_summary.json"
