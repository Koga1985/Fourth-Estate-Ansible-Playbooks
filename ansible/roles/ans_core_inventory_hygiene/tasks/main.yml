---
- name: Get all inventories
  ansible.builtin.uri:
    url: "{{ controller_host }}/api/v2/inventories/"
    method: GET
    headers:
      Authorization: "Bearer {{ controller_oauthtoken }}"
    validate_certs: "{{ validate_certs }}"
  register: inventories

- name: Find stale hosts
  when: cleanup_stale_hosts | bool
  ansible.builtin.uri:
    url: "{{ controller_host }}/api/v2/hosts/?last_job__lt={{ stale_days }}"
    method: GET
    headers:
      Authorization: "Bearer {{ controller_oauthtoken }}"
    validate_certs: "{{ validate_certs }}"
  register: stale_hosts

- name: Remove stale hosts
  when: apply_changes | bool and cleanup_stale_hosts | bool
  ansible.builtin.uri:
    url: "{{ controller_host }}/api/v2/hosts/{{ item.id }}/"
    method: DELETE
    headers:
      Authorization: "Bearer {{ controller_oauthtoken }}"
    validate_certs: "{{ validate_certs }}"
    status_code: [204]
  loop: "{{ stale_hosts.json.results | default([]) }}"

- name: Find empty groups
  when: cleanup_empty_groups | bool
  ansible.builtin.uri:
    url: "{{ controller_host }}/api/v2/groups/?hosts__count=0"
    method: GET
    headers:
      Authorization: "Bearer {{ controller_oauthtoken }}"
    validate_certs: "{{ validate_certs }}"
  register: empty_groups

- name: Generate hygiene report
  ansible.builtin.copy:
    dest: "{{ artifacts_dir }}/inventory_hygiene_report.json"
    mode: "0644"
    content: |
      {
        "stale_hosts": {{ stale_hosts.json.count | default(0) }},
        "empty_groups": {{ empty_groups.json.count | default(0) }},
        "total_inventories": {{ inventories.json.count | default(0) }}
      }

- name: Display hygiene summary
  ansible.builtin.debug:
    msg:
      - "Stale Hosts Found: {{ stale_hosts.json.count | default(0) }}"
      - "Empty Groups Found: {{ empty_groups.json.count | default(0) }}"
