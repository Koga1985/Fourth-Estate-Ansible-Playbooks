---
- name: Create organizations
  when: apply_changes | bool
  ansible.controller.organization:
    controller_host: "{{ controller_host }}"
    controller_oauthtoken: "{{ controller_oauthtoken }}"
    validate_certs: "{{ validate_certs }}"
    name: "{{ item.organization }}"
    state: present
  loop: "{{ inventory_structure }}"

- name: Create inventories
  when: apply_changes | bool
  ansible.controller.inventory:
    controller_host: "{{ controller_host }}"
    controller_oauthtoken: "{{ controller_oauthtoken }}"
    validate_certs: "{{ validate_certs }}"
    name: "{{ item.name }}"
    organization: "{{ item.organization }}"
    description: "{{ item.description }}"
    state: present
  loop: "{{ inventory_structure }}"

- name: Create inventory sources
  when: apply_changes | bool
  ansible.controller.inventory_source:
    controller_host: "{{ controller_host }}"
    controller_oauthtoken: "{{ controller_oauthtoken }}"
    validate_certs: "{{ validate_certs }}"
    name: "{{ item.name }}"
    inventory: "Production"
    source: "{{ item.source }}"
    credential: "{{ item.credential }}"
    update_on_launch: true
    state: present
  loop: "{{ inventory_sources }}"

- name: Display inventory model
  ansible.builtin.debug:
    msg:
      - "Inventories: {{ inventory_structure | length }}"
      - "Sources: {{ inventory_sources | length }}"
