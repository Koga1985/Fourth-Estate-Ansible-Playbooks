---
- name: Ensure backup directory exists
  ansible.builtin.file:
    path: "{{ backup_path }}"
    state: directory
    mode: "0750"
  delegate_to: localhost

- name: Export Controller configuration
  when: backup_enabled | bool
  ansible.builtin.command:
    cmd: "awx-manage export_config --output {{ backup_path }}/{{ backup_filename }}"
  register: backup_result
  changed_when: true

- name: Compress backup
  when: backup_enabled | bool and backup_compression | bool
  community.general.archive:
    path: "{{ backup_path }}/{{ backup_filename }}"
    dest: "{{ backup_path }}/{{ backup_filename }}.gz"
    format: gz
    remove: false

- name: Upload to S3
  when: dr_enabled | bool and dr_remote_storage == 's3'
  amazon.aws.s3_object:
    bucket: "{{ dr_s3_bucket }}"
    object: "{{ backup_filename }}.gz"
    src: "{{ backup_path }}/{{ backup_filename }}.gz"
    mode: put

- name: Cleanup old backups
  ansible.builtin.find:
    paths: "{{ backup_path }}"
    age: "{{ backup_retention_days }}d"
    patterns: "controller_backup_*.json*"
  register: old_backups

- name: Remove old backups
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ old_backups.files }}"
  when: old_backups.files | length > 0

- name: Collect audit logs
  when: audit_enabled | bool
  ansible.builtin.uri:
    url: "{{ controller_host }}/api/v2/activity_stream/"
    method: GET
    headers:
      Authorization: "Bearer {{ controller_oauthtoken }}"
    validate_certs: "{{ validate_certs }}"
    return_content: true
  register: audit_logs

- name: Save audit logs
  when: audit_enabled | bool
  ansible.builtin.copy:
    dest: "{{ artifacts_dir }}/audit_{{ ansible_date_time.date }}.json"
    content: "{{ audit_logs.json | to_nice_json }}"
    mode: "0640"

- name: Display backup summary
  ansible.builtin.debug:
    msg:
      - "Backup Location: {{ backup_path }}/{{ backup_filename }}"
      - "DR Storage: {{ dr_remote_storage if dr_enabled else 'Disabled' }}"
      - "Audit Logs: {{ artifacts_dir }}/audit_{{ ansible_date_time.date }}.json"
