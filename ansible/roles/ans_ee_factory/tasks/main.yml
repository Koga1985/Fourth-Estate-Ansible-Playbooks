---
- name: Ensure build directory exists
  ansible.builtin.file:
    path: "{{ artifacts_dir }}/ee_builds"
    state: directory
    mode: "0755"

- name: Generate execution-environment.yml files
  ansible.builtin.template:
    src: execution-environment.yml.j2
    dest: "{{ artifacts_dir }}/ee_builds/{{ item.name }}/execution-environment.yml"
    mode: "0644"
  loop: "{{ ee_definitions }}"
  loop_control:
    label: "{{ item.name }}"
  when: apply_changes | bool

- name: Generate requirements files
  ansible.builtin.copy:
    dest: "{{ artifacts_dir }}/ee_builds/{{ item.0.name }}/{{ item.1.type }}"
    content: "{{ item.1.content }}"
    mode: "0644"
  loop: "{{ ee_definitions | subelements('dependencies', skip_missing=True) }}"
  when: apply_changes | bool

- name: Build execution environments
  when: apply_changes | bool
  ansible.builtin.command:
    cmd: "ansible-builder build -t {{ item.image }}:{{ item.tag }} -c {{ artifacts_dir }}/ee_builds/{{ item.name }}"
    chdir: "{{ artifacts_dir }}/ee_builds/{{ item.name }}"
  loop: "{{ ee_definitions }}"
  loop_control:
    label: "{{ item.name }}"
  register: build_result
  timeout: "{{ ee_build_timeout }}"

- name: Scan images for vulnerabilities
  when: ee_scanning_enabled | bool
  ansible.builtin.command:
    cmd: "{{ ee_scanner }} image {{ item.image }}:{{ item.tag }}"
  loop: "{{ ee_definitions }}"
  register: scan_result
  failed_when: ee_scan_fail_on_critical | bool and 'CRITICAL' in scan_result.stdout

- name: Push images to registry
  when: apply_changes | bool and registry_push | bool
  ansible.builtin.command:
    cmd: "podman push {{ item.image }}:{{ item.tag }}"
  loop: "{{ ee_definitions }}"
  loop_control:
    label: "{{ item.name }}"

- name: Register EEs in Controller
  when: apply_changes | bool and ee_register_in_controller | bool
  ansible.controller.execution_environment:
    controller_host: "{{ controller_host }}"
    controller_oauthtoken: "{{ controller_oauthtoken }}"
    validate_certs: "{{ validate_certs }}"
    name: "{{ item.name }}"
    image: "{{ item.image }}:{{ item.tag }}"
    state: present
  loop: "{{ ee_definitions }}"

- name: Display build summary
  ansible.builtin.debug:
    msg:
      - "Built {{ ee_definitions | length }} execution environments"
      - "Registry: {{ ee_registry }}"
      - "Scanning: {{ 'Enabled' if ee_scanning_enabled else 'Disabled' }}"
