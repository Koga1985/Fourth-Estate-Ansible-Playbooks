---
- name: Check for available upgrades
  ansible.builtin.uri:
    url: "{{ controller_host }}/api/v2/config/"
    method: GET
    headers:
      Authorization: "Bearer {{ controller_oauthtoken }}"
    validate_certs: "{{ validate_certs }}"
  register: current_version

- name: Create maintenance schedule
  when: apply_changes | bool
  ansible.controller.schedule:
    controller_host: "{{ controller_host }}"
    controller_oauthtoken: "{{ controller_oauthtoken }}"
    validate_certs: "{{ validate_certs }}"
    name: "{{ item.name }}"
    rrule: "DTSTART:20260101T000000Z RRULE:FREQ=MONTHLY;INTERVAL=1"
    state: present
  loop: "{{ maintenance_windows }}"

- name: Send upgrade notification
  when: upgrade_window_enabled | bool
  ansible.builtin.debug:
    msg: "Upgrade window scheduled - {{ upgrade_schedule }}"

- name: Display upgrade summary
  ansible.builtin.debug:
    msg:
      - "Upgrade Window: {{ upgrade_schedule }}"
      - "Change Control: {{ fourth_estate_change_control }}"
