---
- name: Get old job records
  ansible.builtin.uri:
    url: "{{ controller_host }}/api/v2/jobs/?created__lt={{ job_retention_days }}"
    method: GET
    headers:
      Authorization: "Bearer {{ controller_oauthtoken }}"
    validate_certs: "{{ validate_certs }}"
  register: old_jobs

- name: Delete old job records
  when: apply_changes | bool and job_cleanup_enabled | bool
  ansible.builtin.uri:
    url: "{{ controller_host }}/api/v2/jobs/{{ item.id }}/"
    method: DELETE
    headers:
      Authorization: "Bearer {{ controller_oauthtoken }}"
    validate_certs: "{{ validate_certs }}"
    status_code: [204]
  loop: "{{ old_jobs.json.results | default([]) }}"

- name: Configure job limits
  when: apply_changes | bool
  ansible.controller.settings:
    controller_host: "{{ controller_host }}"
    controller_oauthtoken: "{{ controller_oauthtoken }}"
    validate_certs: "{{ validate_certs }}"
    settings:
      MAX_FORKS: "{{ max_concurrent_jobs }}"
      DEFAULT_JOB_TIMEOUT: "{{ job_timeout_default }}"

- name: Display job lifecycle summary
  ansible.builtin.debug:
    msg:
      - "Old Jobs Found: {{ old_jobs.json.count | default(0) }}"
      - "Retention: {{ job_retention_days }} days"
