---
- name: Enable policy enforcement
  when: apply_changes | bool
  ansible.controller.settings:
    controller_host: "{{ controller_host }}"
    controller_oauthtoken: "{{ controller_oauthtoken }}"
    validate_certs: "{{ validate_certs }}"
    settings:
      AWX_ISOLATION_SHOW_PATHS: []
      AWX_PROOT_ENABLED: false

- name: Create approval workflow
  when: apply_changes | bool and require_approval_for_production | bool
  ansible.controller.workflow_approval:
    controller_host: "{{ controller_host }}"
    controller_oauthtoken: "{{ controller_oauthtoken }}"
    validate_certs: "{{ validate_certs }}"
    name: "Production Deployment Approval"
    description: "Requires approval for production deployments"
    timeout: 3600

- name: Display policy summary
  ansible.builtin.debug:
    msg:
      - "Policy Mode: {{ policy_mode }}"
      - "Production Approval: {{ require_approval_for_production }}"
      - "MFA Required: {{ fourth_estate_mandatory_mfa }}"
