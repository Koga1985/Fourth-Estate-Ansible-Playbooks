---
- name: Generate GPG key for signing
  when: apply_changes | bool and signing_enabled | bool
  ansible.builtin.command:
    cmd: gpg --batch --gen-key
  changed_when: false

- name: Sign collections
  when: apply_changes | bool and signing_enabled | bool
  ansible.builtin.command:
    cmd: ansible-sign collection sign {{ item }}
  loop: "{{ collections_to_sign | default([]) }}"
  changed_when: true

- name: Generate requirements lock file
  when: apply_changes | bool and lock_collections | bool
  ansible.builtin.shell: |
    ansible-galaxy collection list --format=json | jq -r '.[] | .name + ":" + .version' > {{ requirements_lock_file }}
  changed_when: true

- name: Verify collection signatures
  when: fourth_estate_signature_verification | bool
  ansible.builtin.command:
    cmd: ansible-sign collection verify {{ item }}
  loop: "{{ collections_to_verify | default([]) }}"
  register: verify_result
  failed_when: verify_result.rc != 0

- name: Display trust summary
  ansible.builtin.debug:
    msg:
      - "Signing: {{ 'Enabled' if signing_enabled else 'Disabled' }}"
      - "Verification: {{ 'Mandatory' if fourth_estate_mandatory_signing else 'Optional' }}"
