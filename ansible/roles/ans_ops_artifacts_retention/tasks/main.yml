---
- name: Find old artifacts
  ansible.builtin.find:
    paths: "{{ artifacts_dir }}"
    age: "{{ artifact_retention_days }}d"
    recurse: true
  register: old_artifacts

- name: Archive old artifacts
  when: apply_changes | bool and fourth_estate_evidence_archival | bool
  community.general.archive:
    path: "{{ item.path }}"
    dest: "{{ artifacts_dir }}/archives/{{ item.path | basename }}.tar.gz"
    format: gz
  loop: "{{ old_artifacts.files }}"

- name: Remove archived artifacts
  when: apply_changes | bool and cleanup_enabled | bool
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ old_artifacts.files }}"

- name: Display retention summary
  ansible.builtin.debug:
    msg:
      - "Old Artifacts: {{ old_artifacts.matched }}"
      - "Retention: {{ artifact_retention_days }} days"
      - "Compliance Retention: {{ fourth_estate_compliance_retention }} days"
