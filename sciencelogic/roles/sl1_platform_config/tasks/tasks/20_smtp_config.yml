---
- name: Configure SMTP server
  ansible.builtin.uri:
    url: "{{ sl1.url }}/api/system/smtp"
    method: PUT
    body:
      server: "{{ sl1_smtp.server }}"
      port: "{{ sl1_smtp.port }}"
      use_tls: "{{ sl1_smtp.use_tls }}"
      use_auth: "{{ sl1_smtp.use_auth }}"
      username: "{{ sl1_smtp.username }}"
      password: "{{ sl1_smtp.password }}"
      from_address: "{{ sl1_smtp.from_address }}"
      from_name: "{{ sl1_smtp.from_name }}"
    body_format: json
    headers:
      Content-Type: "application/json"
      X-EM7-API-Username: "{{ sl1.api_user }}"
      X-EM7-API-Password: "{{ sl1.api_password }}"
    validate_certs: "{{ sl1.verify_ssl }}"
    status_code: [200, 201]
  when: not dry_run

- name: Test SMTP configuration
  ansible.builtin.uri:
    url: "{{ sl1.url }}/api/system/smtp/test"
    method: POST
    body:
      recipient: "{{ sl1_smtp.test_email }}"
      subject: "SL1 SMTP Test"
      message: "This is a test email from SL1 SMTP configuration"
    body_format: json
    headers:
      Content-Type: "application/json"
      X-EM7-API-Username: "{{ sl1.api_user }}"
      X-EM7-API-Password: "{{ sl1.api_password }}"
    validate_certs: "{{ sl1.verify_ssl }}"
    status_code: [200, 201]
  register: smtp_test_result
  when: not dry_run

- name: SMTP configuration summary
  ansible.builtin.debug:
    msg:
      - "SMTP configured successfully"
      - "Server: {{ sl1_smtp.server }}:{{ sl1_smtp.port }}"
      - "Test email sent to: {{ sl1_smtp.test_email }}"
