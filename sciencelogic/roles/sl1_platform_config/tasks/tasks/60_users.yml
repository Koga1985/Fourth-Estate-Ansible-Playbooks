---
- name: Create or update SL1 users
  ansible.builtin.uri:
    url: "{{ sl1.url }}/api/account/user"
    method: POST
    body:
      username: "{{ item.username }}"
      email: "{{ item.email }}"
      first_name: "{{ item.first_name }}"
      last_name: "{{ item.last_name }}"
      role: "{{ item.role }}"
      organization: "{{ item.organization }}"
      active: "{{ item.active | int }}"
      password: "{{ item.password }}"
    body_format: json
    headers:
      Content-Type: "application/json"
      X-EM7-API-Username: "{{ sl1.api_user }}"
      X-EM7-API-Password: "{{ sl1.api_password }}"
    validate_certs: "{{ sl1.verify_ssl }}"
    status_code: [200, 201, 409]
  loop: "{{ sl1_users }}"
  no_log: true
  when: not dry_run

- name: Users configuration summary
  ansible.builtin.debug:
    msg:
      - "Configured {{ sl1_users | length }} user accounts"
      - "Users: {{ sl1_users | map(attribute='username') | join(', ') }}"
