---
- name: Install required system packages
  ansible.builtin.yum:
    name:
      - python3
      - python3-pip
      - python3-requests
      - wget
      - curl
      - net-tools
      - bind-utils
      - ntp
      - ntpdate
      - openssl
      - perl
      - perl-Time-HiRes
      - perl-DBI
      - perl-DBD-MySQL
      - libaio
      - numactl
      - sysstat
      - iotop
      - iftop
      - tcpdump
      - traceroute
      - telnet
      - nc
    state: present
  when: not dry_run

- name: Disable SELinux (if required)
  ansible.builtin.selinux:
    state: "{{ 'enforcing' if sl1_install_options.configure_selinux else 'disabled' }}"
  when: ansible_selinux.status != 'disabled'
  notify: Reboot system

- name: Configure firewall rules
  ansible.posix.firewalld:
    port: "{{ item }}"
    permanent: true
    state: enabled
    immediate: true
  loop:
    - "443/tcp"   # HTTPS
    - "7700/tcp"  # SL1 API
    - "7705/tcp"  # SL1 Collector
    - "162/udp"   # SNMP Traps
    - "514/udp"   # Syslog
    - "514/tcp"   # Syslog TCP
    - "3306/tcp"  # MySQL (for collectors)
    - "9200/tcp"  # Elasticsearch
  when:
    - sl1_network.firewall_enabled
    - not dry_run

- name: Set system limits
  ansible.builtin.pam_limits:
    domain: '*'
    limit_type: "{{ item.type }}"
    limit_item: "{{ item.item }}"
    value: "{{ item.value }}"
  loop:
    - { type: 'soft', item: 'nofile', value: '{{ sl1_system.max_open_files }}' }
    - { type: 'hard', item: 'nofile', value: '{{ sl1_system.max_open_files }}' }
    - { type: 'soft', item: 'nproc', value: '65536' }
    - { type: 'hard', item: 'nproc', value: '65536' }
  when: not dry_run

- name: Configure sysctl parameters
  ansible.builtin.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: true
  loop:
    - { name: 'vm.max_map_count', value: '{{ sl1_system.vm_max_map_count }}' }
    - { name: 'vm.swappiness', value: '10' }
    - { name: 'net.ipv4.tcp_max_syn_backlog', value: '4096' }
    - { name: 'net.core.somaxconn', value: '4096' }
    - { name: 'net.ipv4.ip_local_port_range', value: '10000 65535' }
    - { name: 'net.ipv4.tcp_tw_reuse', value: '1' }
  when: not dry_run

- name: Configure NTP
  ansible.builtin.template:
    src: ntp.conf.j2
    dest: /etc/ntp.conf
    owner: root
    group: root
    mode: '0644'
  when: not dry_run
  notify: Restart ntpd

- name: Start and enable NTP service
  ansible.builtin.service:
    name: ntpd
    state: started
    enabled: true
  when: not dry_run

- name: Synchronize time
  ansible.builtin.command: ntpdate -u {{ sl1_aio.ntp_servers[0] }}
  changed_when: true
  when: not dry_run

- name: Create SL1 installation directory
  ansible.builtin.file:
    path: /opt/em7
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: not dry_run

- name: Download SL1 installer (if not present)
  ansible.builtin.get_url:
    url: "https://updates.sciencelogic.com/releases/{{ sl1_version }}/sl1_installer_{{ sl1_version }}.bin"
    dest: "{{ sl1_package_path }}"
    mode: '0755'
  when:
    - sl1_install_options.download_installer | default(false)
    - not dry_run

- name: Make installer executable
  ansible.builtin.file:
    path: "{{ sl1_package_path }}"
    mode: '0755'
  when: not dry_run

- name: Prerequisites installation summary
  ansible.builtin.debug:
    msg:
      - "Prerequisites installation completed"
      - "System limits configured"
      - "Firewall rules applied"
      - "NTP synchronized"
