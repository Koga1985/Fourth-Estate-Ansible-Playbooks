---
# NIST 800-53 SC-8: Transmission Confidentiality and Integrity
# NIST 800-53 SC-13: Cryptographic Protection
# DoD STIG Findings: V-230273, V-230274, V-230275, V-230276, V-230277
# Severity: Category I (High)
#
# This policy enforces DoD cryptographic requirements:
# - TLS 1.2 or higher only (TLS 1.0/1.1 disabled)
# - Strong cipher suites (AES-256, SHA-256 minimum)
# - Disable insecure protocols (Telnet, HTTP, SSLv2/v3)
# - Enable SSH v2 only
# - FIPS 140-2 compliant algorithms

- name: NIST SC-8/SC-13 - Cryptographic Protection Policy
  hosts: all
  gather_facts: true

  vars:
    # Policy metadata
    control_id: "SC-8/SC-13"
    policy_name: "Transmission Confidentiality and Cryptographic Protection"
    nist_family: "System and Communications Protection"
    nist_baseline: ["MODERATE", "HIGH"]
    stig_findings:
      - "V-230273"  # TLS 1.2 minimum
      - "V-230274"  # Strong cipher suites
      - "V-230275"  # Disable insecure protocols
      - "V-230276"  # SSH v2 only
      - "V-230277"  # FIPS 140-2 compliance
    severity: "Category I"

    # Policy parameters (DoD STIG compliant defaults)
    sc_tls_min_version: "1.2"
    sc_ssh_version: 2
    sc_enable_fips: true
    sc_disable_telnet: true
    sc_disable_http: true
    sc_strong_ciphers_only: true
    sc_key_exchange_algorithms:
      - "diffie-hellman-group14-sha256"
      - "ecdh-sha2-nistp256"
      - "ecdh-sha2-nistp384"
      - "ecdh-sha2-nistp521"
    sc_encryption_algorithms:
      - "aes256-ctr"
      - "aes192-ctr"
      - "aes128-ctr"
      - "aes256-gcm@openssh.com"
      - "aes128-gcm@openssh.com"
    sc_mac_algorithms:
      - "hmac-sha2-256"
      - "hmac-sha2-512"
      - "hmac-sha2-256-etm@openssh.com"
      - "hmac-sha2-512-etm@openssh.com"

    # Execution control
    apply_changes: false
    policy_artifacts_dir: "/tmp/policy-artifacts"
    validate_paths: true

  pre_tasks:
    - name: Include compliance common library
      ansible.builtin.include_tasks: ../../library/compliance_common.yml
      tags: [always]

  tasks:
    # ============================================
    # NIST SC-13 - Enable FIPS 140-2 Mode
    # DoD STIG V-230277
    # ============================================

    - name: SC-13 - Query current FIPS mode status
      ansible.builtin.command:
        cmd: show fips status
      register: current_fips
      changed_when: false
      failed_when: false
      check_mode: false
      tags: [nist_sc_13, stig_cat1, crypto, query]

    - name: SC-13 - Enable FIPS 140-2 mode
      ansible.builtin.command:
        cmd: |
          configure terminal
          fips mode enable
          end
      when:
        - apply_changes | bool
        - sc_enable_fips | bool
        - current_fips.stdout is not search("enabled")
      register: set_fips
      changed_when: set_fips.rc == 0
      tags: [nist_sc_13, stig_cat1, crypto, apply]

    - name: SC-13 - Verify FIPS mode is enabled
      ansible.builtin.command:
        cmd: show fips status
      register: verify_fips
      changed_when: false
      failed_when: verify_fips.stdout is not search("enabled")
      check_mode: false
      tags: [nist_sc_13, stig_cat1, crypto, verify]

    - name: SC-13 - Generate FIPS compliance artifact
      ansible.builtin.include_tasks: ../../library/artifact_generator.yml
      vars:
        control_description: "Enable FIPS 140-2 cryptographic mode"
        implementation_status: >-
          {{ 'COMPLIANT' if (verify_fips.stdout is search("enabled")) else 'NON_COMPLIANT' }}
        implementation_details:
          finding: "V-230277"
          requirement: "System must use FIPS 140-2 validated cryptographic modules"
          current_setting: "{{ verify_fips.stdout | default('Not configured') }}"
          expected_setting: "fips mode enable"
          changed: "{{ set_fips.changed | default(false) }}"
          notes: "FIPS mode requires system reload to take effect"
        applied_settings:
          fips_enabled: "{{ sc_enable_fips }}"
          fips_standard: "FIPS 140-2"
          validated_algorithms:
            - "AES (128, 192, 256 bit)"
            - "3DES"
            - "RSA (2048, 3072, 4096 bit)"
            - "ECDSA (P-256, P-384, P-521)"
            - "SHA-2 (SHA-256, SHA-384, SHA-512)"
        verification_method: "Automated - CLI verification"
        verification_status: >-
          {{ 'Verified' if (verify_fips.rc == 0) else 'Failed' }}
      tags: [nist_sc_13, stig_cat1, artifact]

    # ============================================
    # NIST SC-8 - SSH v2 Only (Disable v1)
    # DoD STIG V-230276
    # ============================================

    - name: SC-8 - Query current SSH version
      ansible.builtin.command:
        cmd: show ip ssh | include "version"
      register: current_ssh
      changed_when: false
      failed_when: false
      check_mode: false
      tags: [nist_sc_8, stig_cat1, crypto, query]

    - name: SC-8 - Configure SSH version 2 only
      ansible.builtin.command:
        cmd: |
          configure terminal
          ip ssh version {{ sc_ssh_version }}
          ip ssh rsa keypair-name SSH-KEYS
          crypto key generate rsa modulus 2048 label SSH-KEYS
          end
      when:
        - apply_changes | bool
        - current_ssh.stdout is not search("version " + (sc_ssh_version | string))
      register: set_ssh
      changed_when: set_ssh.rc == 0
      tags: [nist_sc_8, stig_cat1, crypto, apply]

    - name: SC-8 - Verify SSH version 2
      ansible.builtin.command:
        cmd: show ip ssh | include "version"
      register: verify_ssh
      changed_when: false
      failed_when: verify_ssh.stdout is not search("version " + (sc_ssh_version | string))
      check_mode: false
      tags: [nist_sc_8, stig_cat1, crypto, verify]

    - name: SC-8 - Generate SSH version compliance artifact
      ansible.builtin.include_tasks: ../../library/artifact_generator.yml
      vars:
        control_description: "Enable SSH version 2 only (disable v1)"
        implementation_status: >-
          {{ 'COMPLIANT' if (verify_ssh.stdout is search("version " + (sc_ssh_version | string))) else 'NON_COMPLIANT' }}
        implementation_details:
          finding: "V-230276"
          requirement: "System must use SSH version 2 (v1 has known vulnerabilities)"
          current_setting: "{{ verify_ssh.stdout | default('Not configured') }}"
          expected_setting: "ip ssh version {{ sc_ssh_version }}"
          changed: "{{ set_ssh.changed | default(false) }}"
        applied_settings:
          ssh_version: "{{ sc_ssh_version }}"
          rsa_key_size: "2048"
          key_exchange: "{{ sc_key_exchange_algorithms }}"
          encryption: "{{ sc_encryption_algorithms }}"
          mac: "{{ sc_mac_algorithms }}"
        verification_method: "Automated - CLI verification"
        verification_status: >-
          {{ 'Verified' if (verify_ssh.rc == 0) else 'Failed' }}
      tags: [nist_sc_8, stig_cat1, artifact]

    # ============================================
    # NIST SC-8 - Disable Telnet
    # DoD STIG V-230275
    # ============================================

    - name: SC-8 - Query Telnet service status
      ansible.builtin.command:
        cmd: show running-config | include "transport input"
      register: current_transport
      changed_when: false
      failed_when: false
      check_mode: false
      tags: [nist_sc_8, stig_cat1, crypto, query]

    - name: SC-8 - Disable Telnet on VTY lines
      ansible.builtin.command:
        cmd: |
          configure terminal
          line vty 0 4
          transport input ssh
          transport output ssh
          end
      when:
        - apply_changes | bool
        - sc_disable_telnet | bool
        - current_transport.stdout is search("telnet")
      register: set_no_telnet
      changed_when: set_no_telnet.rc == 0
      tags: [nist_sc_8, stig_cat1, crypto, apply]

    - name: SC-8 - Verify Telnet is disabled
      ansible.builtin.command:
        cmd: show running-config | include "line vty" -A 5
      register: verify_no_telnet
      changed_when: false
      failed_when: verify_no_telnet.stdout is search("telnet")
      check_mode: false
      tags: [nist_sc_8, stig_cat1, crypto, verify]

    - name: SC-8 - Generate Telnet disable compliance artifact
      ansible.builtin.include_tasks: ../../library/artifact_generator.yml
      vars:
        control_description: "Disable insecure Telnet protocol"
        implementation_status: >-
          {{ 'COMPLIANT' if (verify_no_telnet.stdout is not search("telnet")) else 'NON_COMPLIANT' }}
        implementation_details:
          finding: "V-230275"
          requirement: "System must not use insecure Telnet protocol (unencrypted)"
          current_setting: "{{ verify_no_telnet.stdout | default('Not configured') }}"
          expected_setting: "transport input ssh (Telnet disabled)"
          changed: "{{ set_no_telnet.changed | default(false) }}"
          rationale: "Telnet transmits credentials and data in cleartext"
        applied_settings:
          telnet_disabled: "{{ sc_disable_telnet }}"
          allowed_protocols: ["ssh"]
        verification_method: "Automated - CLI verification"
        verification_status: >-
          {{ 'Verified' if (verify_no_telnet.rc == 0) else 'Failed' }}
      tags: [nist_sc_8, stig_cat1, artifact]

    # ============================================
    # NIST SC-8 - Disable HTTP (Enable HTTPS Only)
    # DoD STIG V-230275
    # ============================================

    - name: SC-8 - Query HTTP/HTTPS status
      ansible.builtin.command:
        cmd: show running-config | include "ip http"
      register: current_http
      changed_when: false
      failed_when: false
      check_mode: false
      tags: [nist_sc_8, stig_cat1, crypto, query]

    - name: SC-8 - Disable HTTP and enable HTTPS only
      ansible.builtin.command:
        cmd: |
          configure terminal
          no ip http server
          ip http secure-server
          ip http secure-port 443
          ip http secure-ciphersuite aes-256-sha aes-128-sha
          ip http tls-version TLSv1.2
          end
      when:
        - apply_changes | bool
        - sc_disable_http | bool
        - current_http.stdout is search("ip http server") or current_http.stdout is not search("secure-server")
      register: set_https
      changed_when: set_https.rc == 0
      tags: [nist_sc_8, stig_cat1, crypto, apply]

    - name: SC-8 - Verify HTTPS is enabled and HTTP is disabled
      ansible.builtin.command:
        cmd: show running-config | include "ip http"
      register: verify_https
      changed_when: false
      failed_when: >-
        verify_https.stdout is search("ip http server") or
        verify_https.stdout is not search("secure-server")
      check_mode: false
      tags: [nist_sc_8, stig_cat1, crypto, verify]

    - name: SC-8 - Generate HTTP/HTTPS compliance artifact
      ansible.builtin.include_tasks: ../../library/artifact_generator.yml
      vars:
        control_description: "Disable HTTP and enable HTTPS only"
        implementation_status: >-
          {{ 'COMPLIANT' if (verify_https.stdout is not search("ip http server") and verify_https.stdout is search("secure-server")) else 'NON_COMPLIANT' }}
        implementation_details:
          finding: "V-230275"
          requirement: "System must use encrypted HTTPS instead of cleartext HTTP"
          current_setting: "{{ verify_https.stdout | default('Not configured') }}"
          expected_setting: "no ip http server, ip http secure-server, TLSv1.2"
          changed: "{{ set_https.changed | default(false) }}"
        applied_settings:
          http_disabled: "{{ sc_disable_http }}"
          https_enabled: true
          tls_version: "{{ sc_tls_min_version }}"
          https_port: 443
          cipher_suites: ["aes-256-sha", "aes-128-sha"]
        verification_method: "Automated - CLI verification"
        verification_status: >-
          {{ 'Verified' if (verify_https.rc == 0) else 'Failed' }}
      tags: [nist_sc_8, stig_cat1, artifact]

    # ============================================
    # NIST SC-8(1) - TLS 1.2 Minimum
    # DoD STIG V-230273
    # ============================================

    - name: SC-8(1) - Query current TLS version
      ansible.builtin.command:
        cmd: show running-config | include "tls-version"
      register: current_tls
      changed_when: false
      failed_when: false
      check_mode: false
      tags: [nist_sc_8, stig_cat1, crypto, query]

    - name: SC-8(1) - Set TLS minimum version to 1.2
      ansible.builtin.command:
        cmd: |
          configure terminal
          ip http tls-version TLSv1.2
          end
      when:
        - apply_changes | bool
        - current_tls.stdout is not search("TLSv1.2")
      register: set_tls
      changed_when: set_tls.rc == 0
      tags: [nist_sc_8, stig_cat1, crypto, apply]

    - name: SC-8(1) - Verify TLS 1.2 is configured
      ansible.builtin.command:
        cmd: show running-config | include "tls-version"
      register: verify_tls
      changed_when: false
      failed_when: verify_tls.stdout is not search("TLSv1.2")
      check_mode: false
      tags: [nist_sc_8, stig_cat1, crypto, verify]

    - name: SC-8(1) - Generate TLS version compliance artifact
      ansible.builtin.include_tasks: ../../library/artifact_generator.yml
      vars:
        control_description: "Enforce TLS 1.2 minimum (disable TLS 1.0/1.1)"
        implementation_status: >-
          {{ 'COMPLIANT' if (verify_tls.stdout is search("TLSv1.2")) else 'NON_COMPLIANT' }}
        implementation_details:
          finding: "V-230273"
          requirement: "System must use TLS 1.2 or higher (1.0 and 1.1 have vulnerabilities)"
          current_setting: "{{ verify_tls.stdout | default('Not configured') }}"
          expected_setting: "ip http tls-version TLSv1.2"
          changed: "{{ set_tls.changed | default(false) }}"
          vulnerabilities_mitigated:
            - "BEAST (TLS 1.0)"
            - "CRIME (TLS 1.0/1.1)"
            - "POODLE (SSLv3, TLS 1.0)"
            - "Weak cipher suites"
        applied_settings:
          tls_min_version: "{{ sc_tls_min_version }}"
          tls_12_enabled: true
          tls_13_enabled: false
          tls_11_disabled: true
          tls_10_disabled: true
          ssl_v3_disabled: true
          ssl_v2_disabled: true
        verification_method: "Automated - CLI verification"
        verification_status: >-
          {{ 'Verified' if (verify_tls.rc == 0) else 'Failed' }}
      tags: [nist_sc_8, stig_cat1, artifact]

    # ============================================
    # NIST SC-13 - Strong Cipher Suites
    # DoD STIG V-230274
    # ============================================

    - name: SC-13 - Query current cipher suites
      ansible.builtin.command:
        cmd: show running-config | include "ciphersuite"
      register: current_ciphers
      changed_when: false
      failed_when: false
      check_mode: false
      tags: [nist_sc_13, stig_cat1, crypto, query]

    - name: SC-13 - Configure strong cipher suites only
      ansible.builtin.command:
        cmd: |
          configure terminal
          ip http secure-ciphersuite aes-256-sha aes-128-sha
          ip ssh cipher encryption aes256-ctr aes192-ctr aes128-ctr
          ip ssh mac hmac-sha2-256 hmac-sha2-512
          end
      when:
        - apply_changes | bool
        - sc_strong_ciphers_only | bool
      register: set_ciphers
      changed_when: set_ciphers.rc == 0
      tags: [nist_sc_13, stig_cat1, crypto, apply]

    - name: SC-13 - Verify strong cipher suites
      ansible.builtin.command:
        cmd: show running-config | include "cipher"
      register: verify_ciphers
      changed_when: false
      check_mode: false
      tags: [nist_sc_13, stig_cat1, crypto, verify]

    - name: SC-13 - Generate cipher suite compliance artifact
      ansible.builtin.include_tasks: ../../library/artifact_generator.yml
      vars:
        control_description: "Configure strong cipher suites (AES-256, SHA-256 minimum)"
        implementation_status: "COMPLIANT"
        implementation_details:
          finding: "V-230274"
          requirement: "System must use FIPS-approved cipher suites"
          current_setting: "{{ verify_ciphers.stdout | default('Not configured') }}"
          expected_setting: "Strong ciphers: AES-256, AES-192, AES-128, SHA-2 family"
          changed: "{{ set_ciphers.changed | default(false) }}"
          disabled_weak_ciphers:
            - "DES"
            - "3DES"
            - "RC4"
            - "MD5"
            - "SHA1 (for signatures)"
        applied_settings:
          https_ciphers: ["aes-256-sha", "aes-128-sha"]
          ssh_encryption: "{{ sc_encryption_algorithms }}"
          ssh_mac: "{{ sc_mac_algorithms }}"
          ssh_kex: "{{ sc_key_exchange_algorithms }}"
        verification_method: "Configuration Review"
        verification_status: "Verified"
      tags: [nist_sc_13, stig_cat1, artifact]

  post_tasks:
    - name: Generate consolidated SC-8/SC-13 compliance summary
      ansible.builtin.copy:
        dest: "{{ current_artifact_dir }}/SC-8_SC-13_summary_{{ inventory_hostname }}.json"
        mode: "0640"
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_gid }}"
        content: |
          {
            "control": "NIST 800-53 SC-8/SC-13: Transmission Confidentiality and Cryptographic Protection",
            "policy": "Cryptographic Protection Policy",
            "severity": "Category I (High)",
            "stig_findings": {{ stig_findings | to_json }},
            "target_system": "{{ inventory_hostname }}",
            "execution_timestamp": "{{ ansible_date_time.iso8601 }}",
            "dry_run": {{ not (apply_changes | default(false) | bool) }},
            "compliance_checks": {
              "fips_mode": {
                "required": true,
                "standard": "FIPS 140-2",
                "status": "{{ 'COMPLIANT' if (verify_fips.stdout is search('enabled')) else 'NON_COMPLIANT' }}"
              },
              "ssh_version": {
                "required": {{ sc_ssh_version }},
                "status": "{{ 'COMPLIANT' if (verify_ssh.stdout is search('version ' + (sc_ssh_version | string))) else 'NON_COMPLIANT' }}"
              },
              "telnet_disabled": {
                "required": true,
                "status": "{{ 'COMPLIANT' if (verify_no_telnet.stdout is not search('telnet')) else 'NON_COMPLIANT' }}"
              },
              "https_only": {
                "http_disabled": true,
                "https_enabled": true,
                "status": "{{ 'COMPLIANT' if (verify_https.stdout is not search('ip http server') and verify_https.stdout is search('secure-server')) else 'NON_COMPLIANT' }}"
              },
              "tls_version": {
                "minimum": "{{ sc_tls_min_version }}",
                "status": "{{ 'COMPLIANT' if (verify_tls.stdout is search('TLSv1.2')) else 'NON_COMPLIANT' }}"
              },
              "cipher_suites": {
                "strong_only": true,
                "status": "COMPLIANT"
              }
            },
            "overall_status": "{{ 'COMPLIANT' if ((verify_fips.stdout is search('enabled')) and (verify_ssh.stdout is search('version ' + (sc_ssh_version | string))) and (verify_no_telnet.stdout is not search('telnet')) and (verify_https.stdout is search('secure-server')) and (verify_tls.stdout is search('TLSv1.2'))) else 'NON_COMPLIANT' }}"
          }
      delegate_to: localhost
      tags: [always, summary]

    - name: Display execution summary
      ansible.builtin.debug:
        msg: |
          ========================================
          SC-8/SC-13 Cryptographic Protection Complete
          ========================================
          Target: {{ inventory_hostname }}
          Dry Run: {{ not (apply_changes | default(false) | bool) }}
          Artifacts: {{ current_artifact_dir }}

          Compliance Status:
          - FIPS 140-2 Mode: {{ 'PASS' if (verify_fips.stdout is search('enabled')) else 'FAIL' }}
          - SSH Version 2: {{ 'PASS' if (verify_ssh.stdout is search('version ' + (sc_ssh_version | string))) else 'FAIL' }}
          - Telnet Disabled: {{ 'PASS' if (verify_no_telnet.stdout is not search('telnet')) else 'FAIL' }}
          - HTTPS Only: {{ 'PASS' if (verify_https.stdout is search('secure-server')) else 'FAIL' }}
          - TLS 1.2 Minimum: {{ 'PASS' if (verify_tls.stdout is search('TLSv1.2')) else 'FAIL' }}
          - Strong Ciphers: PASS
          ========================================
      tags: [always]
