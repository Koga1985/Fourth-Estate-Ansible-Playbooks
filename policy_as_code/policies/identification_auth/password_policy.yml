---
# NIST 800-53 IA-5: Authenticator Management
# DoD STIG Findings: V-230502, V-230503, V-230505, V-230507, V-230509
# Severity: Category I (High)
#
# This policy enforces DoD password requirements:
# - Minimum 15 characters (DoD requirement)
# - Complexity: uppercase, lowercase, numeric, special
# - Maximum age: 60 days
# - Password history: 5 previous passwords
# - Account lockout: 3 failed attempts

- name: NIST IA-5 - Password Policy Enforcement
  hosts: all
  gather_facts: true

  vars:
    # Policy metadata
    control_id: "IA-5"
    policy_name: "Authenticator Management - Password Policy"
    nist_family: "Identification and Authentication"
    nist_baseline: ["MODERATE", "HIGH"]
    stig_findings:
      - "V-230502"  # Password minimum length
      - "V-230503"  # Password complexity
      - "V-230505"  # Password maximum age
      - "V-230507"  # Password history
      - "V-230509"  # Account lockout
    severity: "Category I"

    # Policy parameters (DoD STIG compliant defaults)
    ia_password_min_length: 15
    ia_password_max_age_days: 60
    ia_password_history_count: 5
    ia_password_lockout_attempts: 3
    ia_password_lockout_duration: 15
    ia_password_complexity_enabled: true

    # Execution control
    apply_changes: false
    policy_artifacts_dir: "/tmp/policy-artifacts"
    validate_paths: true

  pre_tasks:
    - name: Include compliance common library
      ansible.builtin.include_tasks: ../../library/compliance_common.yml
      tags: [always]

  tasks:
    # ============================================
    # NIST IA-5(1)(a) - Password Minimum Length
    # DoD STIG V-230502
    # ============================================

    - name: IA-5(1)(a) - Query current password minimum length
      ansible.builtin.command:
        cmd: show running-config | include "aaa authentication login password-min-length"
      register: current_min_length
      changed_when: false
      failed_when: false
      check_mode: false
      tags: [nist_ia_5, stig_cat1, password_policy, query]

    - name: IA-5(1)(a) - Set password minimum length to {{ ia_password_min_length }} characters
      ansible.builtin.command:
        cmd: |
          configure terminal
          aaa authentication login password-min-length {{ ia_password_min_length }}
          end
      when:
        - apply_changes | bool
        - current_min_length.stdout is not search(ia_password_min_length | string)
      register: set_min_length
      changed_when: set_min_length.rc == 0
      tags: [nist_ia_5, stig_cat1, password_policy, apply]

    - name: IA-5(1)(a) - Verify password minimum length
      ansible.builtin.command:
        cmd: show running-config | include "aaa authentication login password-min-length"
      register: verify_min_length
      changed_when: false
      failed_when: verify_min_length.stdout is not search(ia_password_min_length | string)
      check_mode: false
      tags: [nist_ia_5, stig_cat1, password_policy, verify]

    - name: IA-5(1)(a) - Generate compliance artifact
      ansible.builtin.include_tasks: ../../library/artifact_generator.yml
      vars:
        control_description: "Password minimum length enforcement (15 characters)"
        implementation_status: >-
          {{ 'COMPLIANT' if (verify_min_length.stdout is search(ia_password_min_length | string)) else 'NON_COMPLIANT' }}
        implementation_details:
          finding: "V-230502"
          requirement: "Password minimum length must be 15 characters"
          current_setting: "{{ verify_min_length.stdout | default('Not configured') }}"
          expected_setting: "aaa authentication login password-min-length {{ ia_password_min_length }}"
          changed: "{{ set_min_length.changed | default(false) }}"
        applied_settings:
          min_length: "{{ ia_password_min_length }}"
        verification_method: "Automated - CLI verification"
        verification_status: >-
          {{ 'Verified' if (verify_min_length.rc == 0) else 'Failed' }}
      tags: [nist_ia_5, stig_cat1, artifact]

    # ============================================
    # NIST IA-5(1)(a) - Password Complexity
    # DoD STIG V-230503
    # ============================================

    - name: IA-5(1)(a) - Query current password complexity settings
      ansible.builtin.command:
        cmd: show running-config | include "aaa authentication login password-complexity"
      register: current_complexity
      changed_when: false
      failed_when: false
      check_mode: false
      tags: [nist_ia_5, stig_cat1, password_policy, query]

    - name: IA-5(1)(a) - Enable password complexity requirements
      ansible.builtin.command:
        cmd: |
          configure terminal
          aaa authentication login password-complexity enable
          end
      when:
        - apply_changes | bool
        - ia_password_complexity_enabled | bool
        - current_complexity.stdout is not search("enable")
      register: set_complexity
      changed_when: set_complexity.rc == 0
      tags: [nist_ia_5, stig_cat1, password_policy, apply]

    - name: IA-5(1)(a) - Verify password complexity enabled
      ansible.builtin.command:
        cmd: show running-config | include "aaa authentication login password-complexity"
      register: verify_complexity
      changed_when: false
      failed_when: verify_complexity.stdout is not search("enable")
      check_mode: false
      tags: [nist_ia_5, stig_cat1, password_policy, verify]

    - name: IA-5(1)(a) - Generate complexity compliance artifact
      ansible.builtin.include_tasks: ../../library/artifact_generator.yml
      vars:
        control_description: "Password complexity requirements (upper, lower, numeric, special)"
        implementation_status: >-
          {{ 'COMPLIANT' if (verify_complexity.stdout is search("enable")) else 'NON_COMPLIANT' }}
        implementation_details:
          finding: "V-230503"
          requirement: "Password must contain uppercase, lowercase, numeric, and special characters"
          current_setting: "{{ verify_complexity.stdout | default('Not configured') }}"
          expected_setting: "aaa authentication login password-complexity enable"
          changed: "{{ set_complexity.changed | default(false) }}"
        applied_settings:
          complexity_enabled: "{{ ia_password_complexity_enabled }}"
          requirements:
            - "Uppercase letters"
            - "Lowercase letters"
            - "Numeric digits"
            - "Special characters"
        verification_method: "Automated - CLI verification"
        verification_status: >-
          {{ 'Verified' if (verify_complexity.rc == 0) else 'Failed' }}
      tags: [nist_ia_5, stig_cat1, artifact]

    # ============================================
    # NIST IA-5(1)(d) - Password Maximum Age
    # DoD STIG V-230505
    # ============================================

    - name: IA-5(1)(d) - Query current password maximum age
      ansible.builtin.command:
        cmd: show running-config | include "aaa authentication login password-max-age"
      register: current_max_age
      changed_when: false
      failed_when: false
      check_mode: false
      tags: [nist_ia_5, stig_cat1, password_policy, query]

    - name: IA-5(1)(d) - Set password maximum age to {{ ia_password_max_age_days }} days
      ansible.builtin.command:
        cmd: |
          configure terminal
          aaa authentication login password-max-age {{ ia_password_max_age_days }}
          end
      when:
        - apply_changes | bool
        - current_max_age.stdout is not search(ia_password_max_age_days | string)
      register: set_max_age
      changed_when: set_max_age.rc == 0
      tags: [nist_ia_5, stig_cat1, password_policy, apply]

    - name: IA-5(1)(d) - Verify password maximum age
      ansible.builtin.command:
        cmd: show running-config | include "aaa authentication login password-max-age"
      register: verify_max_age
      changed_when: false
      failed_when: verify_max_age.stdout is not search(ia_password_max_age_days | string)
      check_mode: false
      tags: [nist_ia_5, stig_cat1, password_policy, verify]

    - name: IA-5(1)(d) - Generate maximum age compliance artifact
      ansible.builtin.include_tasks: ../../library/artifact_generator.yml
      vars:
        control_description: "Password maximum age enforcement (60 days)"
        implementation_status: >-
          {{ 'COMPLIANT' if (verify_max_age.stdout is search(ia_password_max_age_days | string)) else 'NON_COMPLIANT' }}
        implementation_details:
          finding: "V-230505"
          requirement: "Password maximum age must be 60 days or less"
          current_setting: "{{ verify_max_age.stdout | default('Not configured') }}"
          expected_setting: "aaa authentication login password-max-age {{ ia_password_max_age_days }}"
          changed: "{{ set_max_age.changed | default(false) }}"
        applied_settings:
          max_age_days: "{{ ia_password_max_age_days }}"
        verification_method: "Automated - CLI verification"
        verification_status: >-
          {{ 'Verified' if (verify_max_age.rc == 0) else 'Failed' }}
      tags: [nist_ia_5, stig_cat1, artifact]

    # ============================================
    # NIST IA-5(1)(e) - Password History
    # DoD STIG V-230507
    # ============================================

    - name: IA-5(1)(e) - Query current password history count
      ansible.builtin.command:
        cmd: show running-config | include "aaa authentication login password-history"
      register: current_history
      changed_when: false
      failed_when: false
      check_mode: false
      tags: [nist_ia_5, stig_cat1, password_policy, query]

    - name: IA-5(1)(e) - Set password history to {{ ia_password_history_count }} passwords
      ansible.builtin.command:
        cmd: |
          configure terminal
          aaa authentication login password-history {{ ia_password_history_count }}
          end
      when:
        - apply_changes | bool
        - current_history.stdout is not search(ia_password_history_count | string)
      register: set_history
      changed_when: set_history.rc == 0
      tags: [nist_ia_5, stig_cat1, password_policy, apply]

    - name: IA-5(1)(e) - Verify password history
      ansible.builtin.command:
        cmd: show running-config | include "aaa authentication login password-history"
      register: verify_history
      changed_when: false
      failed_when: verify_history.stdout is not search(ia_password_history_count | string)
      check_mode: false
      tags: [nist_ia_5, stig_cat1, password_policy, verify]

    - name: IA-5(1)(e) - Generate history compliance artifact
      ansible.builtin.include_tasks: ../../library/artifact_generator.yml
      vars:
        control_description: "Password history enforcement (5 previous passwords)"
        implementation_status: >-
          {{ 'COMPLIANT' if (verify_history.stdout is search(ia_password_history_count | string)) else 'NON_COMPLIANT' }}
        implementation_details:
          finding: "V-230507"
          requirement: "System must prohibit password reuse for 5 generations"
          current_setting: "{{ verify_history.stdout | default('Not configured') }}"
          expected_setting: "aaa authentication login password-history {{ ia_password_history_count }}"
          changed: "{{ set_history.changed | default(false) }}"
        applied_settings:
          history_count: "{{ ia_password_history_count }}"
        verification_method: "Automated - CLI verification"
        verification_status: >-
          {{ 'Verified' if (verify_history.rc == 0) else 'Failed' }}
      tags: [nist_ia_5, stig_cat1, artifact]

    # ============================================
    # NIST IA-5(1) - Account Lockout
    # DoD STIG V-230509
    # ============================================

    - name: IA-5(1) - Query current account lockout settings
      ansible.builtin.command:
        cmd: show running-config | include "aaa authentication login lock-out"
      register: current_lockout
      changed_when: false
      failed_when: false
      check_mode: false
      tags: [nist_ia_5, stig_cat1, password_policy, query]

    - name: IA-5(1) - Configure account lockout after {{ ia_password_lockout_attempts }} failed attempts
      ansible.builtin.command:
        cmd: |
          configure terminal
          aaa authentication login lock-out {{ ia_password_lockout_attempts }}
          aaa authentication login lock-out-duration {{ ia_password_lockout_duration }}
          end
      when:
        - apply_changes | bool
        - current_lockout.stdout is not search(ia_password_lockout_attempts | string)
      register: set_lockout
      changed_when: set_lockout.rc == 0
      tags: [nist_ia_5, stig_cat1, password_policy, apply]

    - name: IA-5(1) - Verify account lockout configuration
      ansible.builtin.command:
        cmd: show running-config | include "aaa authentication login lock-out"
      register: verify_lockout
      changed_when: false
      failed_when: >-
        verify_lockout.stdout is not search(ia_password_lockout_attempts | string) or
        verify_lockout.stdout is not search(ia_password_lockout_duration | string)
      check_mode: false
      tags: [nist_ia_5, stig_cat1, password_policy, verify]

    - name: IA-5(1) - Generate lockout compliance artifact
      ansible.builtin.include_tasks: ../../library/artifact_generator.yml
      vars:
        control_description: "Account lockout after failed authentication attempts"
        implementation_status: >-
          {{ 'COMPLIANT' if (verify_lockout.stdout is search(ia_password_lockout_attempts | string)) else 'NON_COMPLIANT' }}
        implementation_details:
          finding: "V-230509"
          requirement: "System must lock account after 3 failed login attempts for 15 minutes"
          current_setting: "{{ verify_lockout.stdout | default('Not configured') }}"
          expected_setting: "aaa authentication login lock-out {{ ia_password_lockout_attempts }}, duration {{ ia_password_lockout_duration }}"
          changed: "{{ set_lockout.changed | default(false) }}"
        applied_settings:
          lockout_attempts: "{{ ia_password_lockout_attempts }}"
          lockout_duration_minutes: "{{ ia_password_lockout_duration }}"
        verification_method: "Automated - CLI verification"
        verification_status: >-
          {{ 'Verified' if (verify_lockout.rc == 0) else 'Failed' }}
      tags: [nist_ia_5, stig_cat1, artifact]

  post_tasks:
    - name: Generate consolidated IA-5 compliance summary
      ansible.builtin.copy:
        dest: "{{ current_artifact_dir }}/IA-5_summary_{{ inventory_hostname }}.json"
        mode: "0640"
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_gid }}"
        content: |
          {
            "control": "NIST 800-53 IA-5: Authenticator Management",
            "policy": "Password Policy Enforcement",
            "severity": "Category I (High)",
            "stig_findings": {{ stig_findings | to_json }},
            "target_system": "{{ inventory_hostname }}",
            "execution_timestamp": "{{ ansible_date_time.iso8601 }}",
            "dry_run": {{ not (apply_changes | default(false) | bool) }},
            "compliance_checks": {
              "minimum_length": {
                "required": {{ ia_password_min_length }},
                "status": "{{ 'COMPLIANT' if (verify_min_length.stdout is search(ia_password_min_length | string)) else 'NON_COMPLIANT' }}"
              },
              "complexity": {
                "required": true,
                "status": "{{ 'COMPLIANT' if (verify_complexity.stdout is search('enable')) else 'NON_COMPLIANT' }}"
              },
              "maximum_age": {
                "required": {{ ia_password_max_age_days }},
                "status": "{{ 'COMPLIANT' if (verify_max_age.stdout is search(ia_password_max_age_days | string)) else 'NON_COMPLIANT' }}"
              },
              "history": {
                "required": {{ ia_password_history_count }},
                "status": "{{ 'COMPLIANT' if (verify_history.stdout is search(ia_password_history_count | string)) else 'NON_COMPLIANT' }}"
              },
              "lockout": {
                "attempts": {{ ia_password_lockout_attempts }},
                "duration": {{ ia_password_lockout_duration }},
                "status": "{{ 'COMPLIANT' if (verify_lockout.stdout is search(ia_password_lockout_attempts | string)) else 'NON_COMPLIANT' }}"
              }
            },
            "overall_status": "{{ 'COMPLIANT' if ((verify_min_length.stdout is search(ia_password_min_length | string)) and (verify_complexity.stdout is search('enable')) and (verify_max_age.stdout is search(ia_password_max_age_days | string)) and (verify_history.stdout is search(ia_password_history_count | string)) and (verify_lockout.stdout is search(ia_password_lockout_attempts | string))) else 'NON_COMPLIANT' }}"
          }
      delegate_to: localhost
      tags: [always, summary]

    - name: Display execution summary
      ansible.builtin.debug:
        msg: |
          ========================================
          IA-5 Password Policy Execution Complete
          ========================================
          Target: {{ inventory_hostname }}
          Dry Run: {{ not (apply_changes | default(false) | bool) }}
          Artifacts: {{ current_artifact_dir }}

          Compliance Status:
          - Minimum Length (15): {{ 'PASS' if (verify_min_length.stdout is search(ia_password_min_length | string)) else 'FAIL' }}
          - Complexity (enabled): {{ 'PASS' if (verify_complexity.stdout is search('enable')) else 'FAIL' }}
          - Maximum Age (60 days): {{ 'PASS' if (verify_max_age.stdout is search(ia_password_max_age_days | string)) else 'FAIL' }}
          - History (5 passwords): {{ 'PASS' if (verify_history.stdout is search(ia_password_history_count | string)) else 'FAIL' }}
          - Lockout (3 attempts): {{ 'PASS' if (verify_lockout.stdout is search(ia_password_lockout_attempts | string)) else 'FAIL' }}
          ========================================
      tags: [always]
