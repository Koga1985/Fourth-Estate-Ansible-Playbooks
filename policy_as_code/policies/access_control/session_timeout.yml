---
# NIST 800-53 AC-12: Session Termination
# DoD STIG Findings: V-230286, V-230287
# Severity: Category II (Medium)
#
# This policy enforces DoD session timeout requirements:
# - Absolute session timeout: 15 minutes of inactivity
# - Console session timeout: 10 minutes
# - SSH/Web session timeout: 15 minutes
# - Automatic logout on timeout

- name: NIST AC-12 - Session Termination Policy
  hosts: all
  gather_facts: true

  vars:
    # Policy metadata
    control_id: "AC-12"
    policy_name: "Session Termination - Timeout Enforcement"
    nist_family: "Access Control"
    nist_baseline: ["LOW", "MODERATE", "HIGH"]
    stig_findings:
      - "V-230286"  # Console session timeout
      - "V-230287"  # Remote session timeout
    severity: "Category II"

    # Policy parameters (DoD STIG compliant defaults)
    ac_console_timeout_minutes: 10
    ac_ssh_timeout_minutes: 15
    ac_web_timeout_minutes: 15
    ac_absolute_timeout_minutes: 60

    # Execution control
    apply_changes: false
    policy_artifacts_dir: "/tmp/policy-artifacts"
    validate_paths: true

  pre_tasks:
    - name: Include compliance common library
      ansible.builtin.include_tasks: ../../library/compliance_common.yml
      tags: [always]

  tasks:
    # ============================================
    # NIST AC-12 - Console Session Timeout
    # DoD STIG V-230286
    # ============================================

    - name: AC-12 - Query current console session timeout
      ansible.builtin.command:
        cmd: show running-config | include "exec-timeout"
      register: current_console_timeout
      changed_when: false
      failed_when: false
      check_mode: false
      tags: [nist_ac_12, stig_cat2, session_timeout, query]

    - name: AC-12 - Set console session timeout to {{ ac_console_timeout_minutes }} minutes
      ansible.builtin.command:
        cmd: |
          configure terminal
          line console 0
          exec-timeout {{ ac_console_timeout_minutes }} 0
          end
      when:
        - apply_changes | bool
        - current_console_timeout.stdout is not search(ac_console_timeout_minutes | string)
      register: set_console_timeout
      changed_when: set_console_timeout.rc == 0
      tags: [nist_ac_12, stig_cat2, session_timeout, apply]

    - name: AC-12 - Verify console session timeout
      ansible.builtin.command:
        cmd: show running-config | include "line console" -A 5
      register: verify_console_timeout
      changed_when: false
      failed_when: verify_console_timeout.stdout is not search("exec-timeout " + (ac_console_timeout_minutes | string))
      check_mode: false
      tags: [nist_ac_12, stig_cat2, session_timeout, verify]

    - name: AC-12 - Generate console timeout compliance artifact
      ansible.builtin.include_tasks: ../../library/artifact_generator.yml
      vars:
        control_description: "Console session timeout enforcement (10 minutes)"
        implementation_status: >-
          {{ 'COMPLIANT' if (verify_console_timeout.stdout is search("exec-timeout " + (ac_console_timeout_minutes | string))) else 'NON_COMPLIANT' }}
        implementation_details:
          finding: "V-230286"
          requirement: "Console sessions must terminate after 10 minutes of inactivity"
          current_setting: "{{ verify_console_timeout.stdout | default('Not configured') }}"
          expected_setting: "exec-timeout {{ ac_console_timeout_minutes }} 0"
          changed: "{{ set_console_timeout.changed | default(false) }}"
        applied_settings:
          timeout_minutes: "{{ ac_console_timeout_minutes }}"
          interface: "console 0"
        verification_method: "Automated - CLI verification"
        verification_status: >-
          {{ 'Verified' if (verify_console_timeout.rc == 0) else 'Failed' }}
      tags: [nist_ac_12, stig_cat2, artifact]

    # ============================================
    # NIST AC-12 - VTY (SSH/Telnet) Session Timeout
    # DoD STIG V-230287
    # ============================================

    - name: AC-12 - Query current VTY session timeout
      ansible.builtin.command:
        cmd: show running-config | include "line vty" -A 5
      register: current_vty_timeout
      changed_when: false
      failed_when: false
      check_mode: false
      tags: [nist_ac_12, stig_cat2, session_timeout, query]

    - name: AC-12 - Set VTY session timeout to {{ ac_ssh_timeout_minutes }} minutes
      ansible.builtin.command:
        cmd: |
          configure terminal
          line vty 0 4
          exec-timeout {{ ac_ssh_timeout_minutes }} 0
          end
      when:
        - apply_changes | bool
        - current_vty_timeout.stdout is not search("exec-timeout " + (ac_ssh_timeout_minutes | string))
      register: set_vty_timeout
      changed_when: set_vty_timeout.rc == 0
      tags: [nist_ac_12, stig_cat2, session_timeout, apply]

    - name: AC-12 - Verify VTY session timeout
      ansible.builtin.command:
        cmd: show running-config | include "line vty" -A 5
      register: verify_vty_timeout
      changed_when: false
      failed_when: verify_vty_timeout.stdout is not search("exec-timeout " + (ac_ssh_timeout_minutes | string))
      check_mode: false
      tags: [nist_ac_12, stig_cat2, session_timeout, verify]

    - name: AC-12 - Generate VTY timeout compliance artifact
      ansible.builtin.include_tasks: ../../library/artifact_generator.yml
      vars:
        control_description: "VTY (SSH) session timeout enforcement (15 minutes)"
        implementation_status: >-
          {{ 'COMPLIANT' if (verify_vty_timeout.stdout is search("exec-timeout " + (ac_ssh_timeout_minutes | string))) else 'NON_COMPLIANT' }}
        implementation_details:
          finding: "V-230287"
          requirement: "Remote sessions must terminate after 15 minutes of inactivity"
          current_setting: "{{ verify_vty_timeout.stdout | default('Not configured') }}"
          expected_setting: "exec-timeout {{ ac_ssh_timeout_minutes }} 0"
          changed: "{{ set_vty_timeout.changed | default(false) }}"
        applied_settings:
          timeout_minutes: "{{ ac_ssh_timeout_minutes }}"
          interface: "vty 0 4"
        verification_method: "Automated - CLI verification"
        verification_status: >-
          {{ 'Verified' if (verify_vty_timeout.rc == 0) else 'Failed' }}
      tags: [nist_ac_12, stig_cat2, artifact]

    # ============================================
    # NIST AC-12 - Web UI Session Timeout
    # Additional DoD Requirement
    # ============================================

    - name: AC-12 - Query current web session timeout
      ansible.builtin.command:
        cmd: show running-config | include "ip http timeout-policy"
      register: current_web_timeout
      changed_when: false
      failed_when: false
      check_mode: false
      tags: [nist_ac_12, stig_cat2, session_timeout, query]

    - name: AC-12 - Set web session timeout to {{ ac_web_timeout_minutes }} minutes
      ansible.builtin.command:
        cmd: |
          configure terminal
          ip http timeout-policy idle {{ ac_web_timeout_minutes }} life {{ ac_absolute_timeout_minutes }} requests 100
          end
      when:
        - apply_changes | bool
        - current_web_timeout.stdout is not search("idle " + (ac_web_timeout_minutes | string))
      register: set_web_timeout
      changed_when: set_web_timeout.rc == 0
      tags: [nist_ac_12, stig_cat2, session_timeout, apply]

    - name: AC-12 - Verify web session timeout
      ansible.builtin.command:
        cmd: show running-config | include "ip http timeout-policy"
      register: verify_web_timeout
      changed_when: false
      failed_when: verify_web_timeout.stdout is not search("idle " + (ac_web_timeout_minutes | string))
      check_mode: false
      tags: [nist_ac_12, stig_cat2, session_timeout, verify]

    - name: AC-12 - Generate web timeout compliance artifact
      ansible.builtin.include_tasks: ../../library/artifact_generator.yml
      vars:
        control_description: "Web UI session timeout enforcement (15 minutes idle)"
        implementation_status: >-
          {{ 'COMPLIANT' if (verify_web_timeout.stdout is search("idle " + (ac_web_timeout_minutes | string))) else 'NON_COMPLIANT' }}
        implementation_details:
          finding: "Additional DoD Requirement"
          requirement: "Web UI sessions must terminate after 15 minutes of inactivity"
          current_setting: "{{ verify_web_timeout.stdout | default('Not configured') }}"
          expected_setting: "ip http timeout-policy idle {{ ac_web_timeout_minutes }} life {{ ac_absolute_timeout_minutes }}"
          changed: "{{ set_web_timeout.changed | default(false) }}"
        applied_settings:
          idle_timeout_minutes: "{{ ac_web_timeout_minutes }}"
          absolute_timeout_minutes: "{{ ac_absolute_timeout_minutes }}"
          max_requests: 100
        verification_method: "Automated - CLI verification"
        verification_status: >-
          {{ 'Verified' if (verify_web_timeout.rc == 0) else 'Failed' }}
      tags: [nist_ac_12, stig_cat2, artifact]

    # ============================================
    # NIST AC-12(1) - User-Initiated Logouts
    # ============================================

    - name: AC-12(1) - Verify logout capability exists
      ansible.builtin.command:
        cmd: show version | include "IOS"
      register: verify_logout
      changed_when: false
      check_mode: false
      tags: [nist_ac_12, session_timeout, verify]

    - name: AC-12(1) - Generate logout capability artifact
      ansible.builtin.include_tasks: ../../library/artifact_generator.yml
      vars:
        control_description: "User-initiated logout capability"
        implementation_status: "COMPLIANT"
        implementation_details:
          requirement: "System must provide capability for users to directly initiate session logout"
          implementation: "Native IOS/NX-OS logout command available"
          commands_available:
            - "logout"
            - "exit"
            - "quit"
        verification_method: "Design Review"
        verification_status: "Verified"
      tags: [nist_ac_12, artifact]

  post_tasks:
    - name: Generate consolidated AC-12 compliance summary
      ansible.builtin.copy:
        dest: "{{ current_artifact_dir }}/AC-12_summary_{{ inventory_hostname }}.json"
        mode: "0640"
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_gid }}"
        content: |
          {
            "control": "NIST 800-53 AC-12: Session Termination",
            "policy": "Session Timeout Enforcement",
            "severity": "Category II (Medium)",
            "stig_findings": {{ stig_findings | to_json }},
            "target_system": "{{ inventory_hostname }}",
            "execution_timestamp": "{{ ansible_date_time.iso8601 }}",
            "dry_run": {{ not (apply_changes | default(false) | bool) }},
            "compliance_checks": {
              "console_timeout": {
                "required_minutes": {{ ac_console_timeout_minutes }},
                "status": "{{ 'COMPLIANT' if (verify_console_timeout.stdout is search('exec-timeout ' + (ac_console_timeout_minutes | string))) else 'NON_COMPLIANT' }}"
              },
              "vty_timeout": {
                "required_minutes": {{ ac_ssh_timeout_minutes }},
                "status": "{{ 'COMPLIANT' if (verify_vty_timeout.stdout is search('exec-timeout ' + (ac_ssh_timeout_minutes | string))) else 'NON_COMPLIANT' }}"
              },
              "web_timeout": {
                "idle_minutes": {{ ac_web_timeout_minutes }},
                "absolute_minutes": {{ ac_absolute_timeout_minutes }},
                "status": "{{ 'COMPLIANT' if (verify_web_timeout.stdout is search('idle ' + (ac_web_timeout_minutes | string))) else 'NON_COMPLIANT' }}"
              },
              "user_logout": {
                "required": true,
                "status": "COMPLIANT"
              }
            },
            "overall_status": "{{ 'COMPLIANT' if ((verify_console_timeout.stdout is search('exec-timeout ' + (ac_console_timeout_minutes | string))) and (verify_vty_timeout.stdout is search('exec-timeout ' + (ac_ssh_timeout_minutes | string))) and (verify_web_timeout.stdout is search('idle ' + (ac_web_timeout_minutes | string)))) else 'NON_COMPLIANT' }}"
          }
      delegate_to: localhost
      tags: [always, summary]

    - name: Display execution summary
      ansible.builtin.debug:
        msg: |
          ========================================
          AC-12 Session Timeout Execution Complete
          ========================================
          Target: {{ inventory_hostname }}
          Dry Run: {{ not (apply_changes | default(false) | bool) }}
          Artifacts: {{ current_artifact_dir }}

          Compliance Status:
          - Console Timeout (10 min): {{ 'PASS' if (verify_console_timeout.stdout is search('exec-timeout ' + (ac_console_timeout_minutes | string))) else 'FAIL' }}
          - VTY Timeout (15 min): {{ 'PASS' if (verify_vty_timeout.stdout is search('exec-timeout ' + (ac_ssh_timeout_minutes | string))) else 'FAIL' }}
          - Web Timeout (15 min): {{ 'PASS' if (verify_web_timeout.stdout is search('idle ' + (ac_web_timeout_minutes | string))) else 'FAIL' }}
          - User Logout: PASS
          ========================================
      tags: [always]
