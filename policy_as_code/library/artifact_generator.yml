---
# Compliance artifact generation
# Generates NIST 800-53 and DoD STIG compliance documentation

- name: Validate artifact generation variables
  ansible.builtin.assert:
    that:
      - control_id is defined
      - control_description is defined
      - implementation_status is defined
      - implementation_status in ['COMPLIANT', 'NON_COMPLIANT', 'NOT_APPLICABLE', 'PARTIAL']
    fail_msg: "Required artifact variables missing or invalid"
  tags: [always, validation]

- name: Build compliance artifact data structure
  ansible.builtin.set_fact:
    compliance_artifact:
      metadata:
        control_id: "{{ control_id }}"
        control_description: "{{ control_description }}"
        nist_family: "{{ nist_family | default('Unknown') }}"
        nist_baseline: "{{ nist_baseline | default(['MODERATE', 'HIGH']) }}"
        stig_findings: "{{ stig_findings | default([]) }}"
        severity: "{{ severity | default('Not Specified') }}"
        framework_version: "NIST 800-53 Rev 5"
      implementation:
        status: "{{ implementation_status }}"
        details: "{{ implementation_details | default({}) }}"
        applied_settings: "{{ applied_settings | default({}) }}"
        deviations: "{{ deviations | default([]) }}"
        exceptions: "{{ exceptions | default([]) }}"
      execution:
        timestamp: "{{ ansible_date_time.iso8601 }}"
        executor: "{{ ansible_user_id }}"
        target_system: "{{ inventory_hostname }}"
        ansible_version: "{{ ansible_version.full }}"
        dry_run: "{{ not (apply_changes | default(false) | bool) }}"
        check_mode: "{{ ansible_check_mode | default(true) }}"
      verification:
        verification_method: "{{ verification_method | default('Automated') }}"
        verification_status: "{{ verification_status | default('Pending') }}"
        last_verified: "{{ ansible_date_time.iso8601 }}"
        next_verification: "{{ next_verification_date | default('N/A') }}"
      audit:
        change_ticket: "{{ change_ticket | default('N/A') }}"
        approver: "{{ approver | default('N/A') }}"
        security_review: "{{ security_review | default('Pending') }}"
  tags: [always, artifact]

- name: Generate compliance artifact JSON
  ansible.builtin.copy:
    dest: "{{ current_artifact_dir }}/{{ control_id | replace('/', '_') | replace(' ', '_') }}_{{ inventory_hostname }}.json"
    mode: "0640"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
    content: "{{ compliance_artifact | to_nice_json }}"
  delegate_to: localhost
  register: artifact_written
  tags: [always, artifact]

- name: Compute SHA-256 checksum for artifact
  ansible.builtin.stat:
    path: "{{ artifact_written.dest }}"
    checksum_algorithm: sha256
  register: artifact_checksum
  delegate_to: localhost
  tags: [always, artifact, checksum]

- name: Write SHA-256 checksum sidecar
  ansible.builtin.copy:
    dest: "{{ artifact_written.dest }}.sha256"
    mode: "0640"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
    content: "{{ artifact_checksum.stat.checksum }}  {{ artifact_written.dest | basename }}\n"
  delegate_to: localhost
  tags: [always, artifact, checksum]

- name: Log compliance artifact generation
  ansible.builtin.debug:
    msg: |
      ========================================
      Compliance Artifact Generated
      ========================================
      Control: {{ control_id }}
      Status: {{ implementation_status }}
      File: {{ artifact_written.dest }}
      Checksum: {{ artifact_checksum.stat.checksum }}
      Size: {{ artifact_checksum.stat.size }} bytes
      ========================================
  tags: [always, logging]

- name: Append to execution summary
  ansible.builtin.set_fact:
    policy_execution_summary: "{{ policy_execution_summary | default([]) + [compliance_artifact] }}"
  tags: [always, summary]
