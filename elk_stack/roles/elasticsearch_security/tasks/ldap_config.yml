---
# LDAP integration configuration

- name: Add LDAP bind password to keystore
  shell: |
    echo "{{ elasticsearch_ldap_bind_password }}" | /usr/share/elasticsearch/bin/elasticsearch-keystore add -f xpack.security.authc.realms.ldap.ldap1.secure_bind_password
  when: elasticsearch_ldap_enabled | bool
  no_log: true
  changed_when: true

- name: Create LDAP realm configuration
  blockinfile:
    path: /etc/elasticsearch/elasticsearch.yml
    marker: "# {mark} ANSIBLE MANAGED LDAP BLOCK"
    block: |
      xpack.security.authc.realms.ldap.ldap1:
        order: 0
        url: "{{ elasticsearch_ldap_url }}"
        bind_dn: "{{ elasticsearch_ldap_bind_dn }}"
        user_search:
          base_dn: "{{ elasticsearch_ldap_user_search_base }}"
          filter: "{{ elasticsearch_ldap_user_search_filter }}"
        group_search:
          base_dn: "{{ elasticsearch_ldap_group_search_base }}"
          filter: "{{ elasticsearch_ldap_group_search_filter }}"
        unmapped_groups_as_roles: false
    backup: yes
  notify: restart elasticsearch

- name: Create role mapping for LDAP
  template:
    src: ldap_role_mapping.yml.j2
    dest: /etc/elasticsearch/role_mapping.yml
    owner: root
    group: elasticsearch
    mode: '0660'
  notify: restart elasticsearch
