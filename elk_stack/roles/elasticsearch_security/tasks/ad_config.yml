---
# Active Directory integration configuration

- name: Create Active Directory realm configuration
  blockinfile:
    path: /etc/elasticsearch/elasticsearch.yml
    marker: "# {mark} ANSIBLE MANAGED AD BLOCK"
    block: |
      xpack.security.authc.realms.active_directory.ad1:
        order: 0
        domain_name: "{{ elasticsearch_ad_domain }}"
        url: "{{ elasticsearch_ad_url }}"
        user_search:
          base_dn: "{{ elasticsearch_ad_user_search_base }}"
        group_search:
          base_dn: "{{ elasticsearch_ad_group_search_base }}"
    backup: yes
  notify: restart elasticsearch

- name: Create role mapping for Active Directory
  template:
    src: ad_role_mapping.yml.j2
    dest: /etc/elasticsearch/role_mapping.yml
    owner: root
    group: elasticsearch
    mode: '0660'
  notify: restart elasticsearch
