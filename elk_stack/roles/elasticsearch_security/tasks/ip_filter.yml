---
# IP filtering configuration

- name: Configure IP filtering
  blockinfile:
    path: /etc/elasticsearch/elasticsearch.yml
    marker: "# {mark} ANSIBLE MANAGED IP FILTER BLOCK"
    block: |
      xpack.security.transport.filter.enabled: {{ elasticsearch_ip_filter_enabled | lower }}
      xpack.security.http.filter.enabled: {{ elasticsearch_ip_filter_enabled | lower }}
      {% if elasticsearch_ip_filter_enabled %}
      {% if elasticsearch_ip_filter_allow | length > 0 %}
      xpack.security.transport.filter.allow: {{ elasticsearch_ip_filter_allow | to_json }}
      xpack.security.http.filter.allow: {{ elasticsearch_ip_filter_allow | to_json }}
      {% endif %}
      {% if elasticsearch_ip_filter_deny | length > 0 %}
      xpack.security.transport.filter.deny: {{ elasticsearch_ip_filter_deny | to_json }}
      xpack.security.http.filter.deny: {{ elasticsearch_ip_filter_deny | to_json }}
      {% endif %}
      {% endif %}
    backup: yes
  notify: restart elasticsearch
