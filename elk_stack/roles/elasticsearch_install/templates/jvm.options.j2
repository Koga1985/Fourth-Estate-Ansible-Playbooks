## JVM configuration for Elasticsearch
## Generated by Ansible - DO NOT EDIT MANUALLY

################################################################
## IMPORTANT: JVM heap size
################################################################
##
## The heap size is automatically configured by Elasticsearch
## based on the available memory in your system and the roles
## each node will fulfill. If specifying heap is required, it
## should be done through Ansible variables.
##
################################################################

# Xms represents the initial size of total heap space
# Xmx represents the maximum size of total heap space

{{ elasticsearch_jvm_options | join('\n') }}

################################################################
## Expert settings
################################################################
##
## All settings below here are considered expert settings. Do
## not adjust them unless you understand what you are doing.
##
################################################################

## GC configuration
-XX:+UseG1GC
-XX:G1ReservePercent=25
-XX:InitiatingHeapOccupancyPercent=30

## JVM temporary directory
-Djava.io.tmpdir=${ES_TMPDIR}

## heap dumps

# generate a heap dump when an allocation from the Java heap fails; heap dumps
# are created in the working directory of the JVM unless an alternative path is
# specified
-XX:+HeapDumpOnOutOfMemoryError

# specify an alternative path for heap dumps; ensure the directory exists and
# has sufficient space
-XX:HeapDumpPath={{ elasticsearch_data_dir }}

# specify an alternative path for JVM fatal error logs
-XX:ErrorFile={{ elasticsearch_log_dir }}/hs_err_pid%p.log

## GC logging
-Xlog:gc*,gc+age=trace,safepoint:file={{ elasticsearch_log_dir }}/gc.log:utctime,pid,tags:filecount=32,filesize=64m

# JVM fatal error log
-XX:ErrorFile={{ elasticsearch_log_dir }}/hs_err_pid%p.log

## JVM security
-Djava.security.policy={{ elasticsearch_config_dir }}/elasticsearch.policy

## Disable JMX remote
-Dcom.sun.management.jmxremote=false

## Ensure UTF-8 encoding by default
-Dfile.encoding=UTF-8

## Use our provided JNA
-Djna.nosys=true

## Turn off a JDK optimization that throws away stack traces
-XX:-OmitStackTraceInFastThrow

## Flags to configure Netty
-Dio.netty.noUnsafe=true
-Dio.netty.noKeySetOptimization=true
-Dio.netty.recycler.maxCapacityPerThread=0
-Dio.netty.allocator.numDirectArenas=0

## Log4j 2
-Dlog4j2.disable.jmx=true
-Dlog4j.shutdownHookEnabled=false
-Dlog4j2.formatMsgNoLookups=true

## Locale
-Djava.locale.providers=SPI,COMPAT

## DNS cache policy
# cache dns lookups for 60 seconds
-Dnetworkaddress.cache.ttl=60

## Security manager
-Djava.security.manager=allow

# Pre-touch memory pages used by JVM during initialization
-XX:+AlwaysPreTouch

## Explicitly set MaxDirectMemorySize
-XX:MaxDirectMemorySize=2147483648

## Fourth Estate specific optimizations
# Optimize for throughput
-XX:+UseStringDeduplication
-XX:+ParallelRefProcEnabled

# Performance monitoring
-XX:+UnlockDiagnosticVMOptions
-XX:+DebugNonSafepoints
