# ======================== Elasticsearch Configuration =========================
# Generated by Ansible for Fourth Estate
# NOTE: Elasticsearch comes with reasonable defaults for most settings.
#       Before you set out to tweak and tune the configuration, make sure you
#       understand what are you trying to accomplish and the consequences.

# ---------------------------------- Cluster -----------------------------------
cluster.name: {{ elasticsearch_cluster_name }}

# ------------------------------------ Node ------------------------------------
node.name: {{ elasticsearch_node_name }}

# Node roles
node.roles:
{% if elasticsearch_node_master %}
  - master
{% endif %}
{% if elasticsearch_node_data %}
  - data
{% endif %}
{% if elasticsearch_node_data_content %}
  - data_content
{% endif %}
{% if elasticsearch_node_data_hot %}
  - data_hot
{% endif %}
{% if elasticsearch_node_data_warm %}
  - data_warm
{% endif %}
{% if elasticsearch_node_data_cold %}
  - data_cold
{% endif %}
{% if elasticsearch_node_data_frozen %}
  - data_frozen
{% endif %}
{% if elasticsearch_node_ingest %}
  - ingest
{% endif %}
{% if elasticsearch_node_ml %}
  - ml
{% endif %}
{% if elasticsearch_node_remote_cluster_client %}
  - remote_cluster_client
{% endif %}
{% if elasticsearch_node_transform %}
  - transform
{% endif %}

# Node attributes for shard allocation awareness
node.attr.rack: {{ elasticsearch_node_attr_rack }}
node.attr.zone: {{ elasticsearch_node_attr_zone }}
{% if elasticsearch_hot_warm_enabled %}
node.attr.temp: {{ elasticsearch_node_temperature }}
{% endif %}

# ----------------------------------- Paths ------------------------------------
path.data: {{ elasticsearch_path_data }}
path.logs: {{ elasticsearch_path_logs }}
{% if elasticsearch_path_repo is defined %}
path.repo: {{ elasticsearch_path_repo }}
{% endif %}

# ----------------------------------- Memory -----------------------------------
bootstrap.memory_lock: {{ elasticsearch_bootstrap_memory_lock | lower }}

# ---------------------------------- Network -----------------------------------
network.host: {{ elasticsearch_network_host }}
http.host: {{ elasticsearch_http_host }}
http.port: {{ elasticsearch_http_port }}
transport.host: {{ elasticsearch_transport_host }}
transport.port: {{ elasticsearch_transport_port }}

{% if elasticsearch_publish_host is defined and elasticsearch_publish_host != '' %}
# Publish host for cluster communication
network.publish_host: {{ elasticsearch_publish_host }}
{% endif %}

# --------------------------------- Discovery ----------------------------------
{% if elasticsearch_discovery_seed_hosts | length > 0 %}
discovery.seed_hosts:
{% for host in elasticsearch_discovery_seed_hosts %}
  - {{ host }}
{% endfor %}
{% endif %}

{% if elasticsearch_cluster_initial_master_nodes | length > 0 %}
# Bootstrap the cluster using an initial set of master-eligible nodes
# IMPORTANT: Remove this setting after cluster formation
cluster.initial_master_nodes:
{% for node in elasticsearch_cluster_initial_master_nodes %}
  - {{ node }}
{% endfor %}
{% endif %}

# ---------------------------------- Gateway -----------------------------------
{% if elasticsearch_gateway_expected_nodes is defined %}
gateway.expected_nodes: {{ elasticsearch_gateway_expected_nodes }}
gateway.expected_master_nodes: {{ elasticsearch_gateway_expected_master_nodes }}
gateway.expected_data_nodes: {{ elasticsearch_gateway_expected_data_nodes }}
gateway.recover_after_time: {{ elasticsearch_gateway_recover_after_time }}
gateway.recover_after_nodes: {{ elasticsearch_gateway_recover_after_nodes }}
gateway.recover_after_master_nodes: {{ elasticsearch_gateway_recover_after_master_nodes }}
gateway.recover_after_data_nodes: {{ elasticsearch_gateway_recover_after_data_nodes }}
{% endif %}

# ---------------------------------- Various -----------------------------------
action.auto_create_index: {{ elasticsearch_action_auto_create_index | lower }}
action.destructive_requires_name: {{ elasticsearch_action_destructive_requires_name | lower }}

# --------------------------------- Allocation ---------------------------------
cluster.routing.allocation.enable: {{ elasticsearch_cluster_routing_allocation_enable }}
cluster.routing.allocation.awareness.attributes: {{ elasticsearch_cluster_routing_allocation_awareness_attributes | join(',') }}
cluster.routing.allocation.disk.threshold_enabled: {{ elasticsearch_cluster_routing_allocation_disk_threshold_enabled | lower }}
cluster.routing.allocation.disk.watermark.low: {{ elasticsearch_cluster_routing_allocation_disk_watermark_low }}
cluster.routing.allocation.disk.watermark.high: {{ elasticsearch_cluster_routing_allocation_disk_watermark_high }}
cluster.routing.allocation.disk.watermark.flood_stage: {{ elasticsearch_cluster_routing_allocation_disk_watermark_flood_stage }}

cluster.max_shards_per_node: {{ elasticsearch_cluster_max_shards_per_node }}
cluster.routing.allocation.node_concurrent_recoveries: {{ elasticsearch_cluster_routing_allocation_node_concurrent_recoveries }}
cluster.routing.allocation.node_initial_primaries_recoveries: {{ elasticsearch_cluster_routing_allocation_node_initial_primaries_recoveries }}
indices.recovery.max_bytes_per_sec: {{ elasticsearch_indices_recovery_max_bytes_per_sec }}

# -------------------------------- Thread Pools --------------------------------
thread_pool.write.queue_size: {{ elasticsearch_thread_pool_write_queue_size }}
thread_pool.search.queue_size: {{ elasticsearch_thread_pool_search_queue_size }}
thread_pool.get.queue_size: {{ elasticsearch_thread_pool_get_queue_size }}

# ------------------------------- Circuit Breakers -----------------------------
indices.breaker.total.limit: {{ elasticsearch_indices_breaker_total_limit }}
indices.breaker.fielddata.limit: {{ elasticsearch_indices_breaker_fielddata_limit }}
indices.breaker.request.limit: {{ elasticsearch_indices_breaker_request_limit }}

# -------------------------------- Index Settings ------------------------------
index.number_of_shards: {{ elasticsearch_index_number_of_shards }}
index.number_of_replicas: {{ elasticsearch_index_number_of_replicas }}
index.refresh_interval: {{ elasticsearch_index_refresh_interval }}
index.max_result_window: {{ elasticsearch_index_max_result_window }}

# --------------------------------- Monitoring ---------------------------------
{% if elasticsearch_monitoring_enabled %}
xpack.monitoring.enabled: true
xpack.monitoring.collection.enabled: {{ elasticsearch_monitoring_collection_enabled | lower }}
xpack.monitoring.collection.interval: {{ elasticsearch_monitoring_collection_interval }}
{% else %}
xpack.monitoring.enabled: false
{% endif %}

# ---------------------------------- Watcher -----------------------------------
xpack.watcher.enabled: {{ elasticsearch_watcher_enabled | lower }}

# ------------------------------- Machine Learning -----------------------------
xpack.ml.enabled: {{ elasticsearch_ml_enabled | lower }}
{% if elasticsearch_ml_enabled and elasticsearch_max_ml_node_size > 0 %}
xpack.ml.max_ml_node_size: {{ elasticsearch_max_ml_node_size }}
{% endif %}

# ------------------------------------- SQL ------------------------------------
xpack.sql.enabled: {{ elasticsearch_sql_enabled | lower }}

# -------------------------------- Fourth Estate -------------------------------
{% if elasticsearch_fourth_estate_mode %}
# Custom settings for news media organization

# Enable audit trail for journalist activity
xpack.security.audit.enabled: true

# Index lifecycle management for compliance
indices.lifecycle.poll_interval: "10m"

# Slow log thresholds for performance monitoring
index.search.slowlog.threshold.query.warn: {{ elasticsearch_slowlog_threshold_query_warn }}
index.search.slowlog.threshold.query.info: {{ elasticsearch_slowlog_threshold_query_info }}
index.search.slowlog.threshold.fetch.warn: {{ elasticsearch_slowlog_threshold_fetch_warn }}
index.search.slowlog.threshold.fetch.info: {{ elasticsearch_slowlog_threshold_fetch_info }}
index.indexing.slowlog.threshold.index.warn: {{ elasticsearch_slowlog_threshold_index_warn }}
index.indexing.slowlog.threshold.index.info: {{ elasticsearch_slowlog_threshold_index_info }}

# Source protection settings
# Ensure sensitive journalist sources are properly logged and protected
cluster.routing.allocation.same_shard.host: true

# Compliance and retention
# {{ elasticsearch_retention_days }} day retention for regulatory compliance
{% endif %}
