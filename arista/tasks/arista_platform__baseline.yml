---
- name: Arista platform baseline (hostname, banners, NTP, syslog, eAPI)
  hosts: arista
  gather_facts: false
  collections:
    - arista.eos
    - arista.cvp
    - ansible.utils
  vars:
    apply_changes: false
    artifacts_dir: "/tmp/arista-artifacts"
  pre_tasks:
    - name: Ensure artifacts dir
      ansible.builtin.file:
        path: "{ artifacts_dir }"
        state: directory
        mode: "0755"

  vars:
    baseline:
      hostname: "eos-switch"
      banners: { login: "UNCLASSIFIED // FOUO", motd: "DoD Notice" }
      ntp: [{ server: "10.0.0.10", vrf: "MGMT" }]
      syslog: [{ host: "10.0.0.20", port: 514, protocol: "udp", vrf: "MGMT" }]
      eapi: { enabled: True, https: True, vrf: "MGMT" }

  tasks:
    - name: Plan baseline
      ansible.builtin.copy:
        dest: "{{ artifacts_dir }}/platform_baseline_plan.json"
        content: "{{ baseline | to_nice_json }}"
        mode: "0644"

    - name: Set hostname
      when: apply_changes | bool
      arista.eos.eos_hostname:
        config: { hostname: "{{ baseline.hostname }}" }
        state: merged

    - name: Login banner
      when: apply_changes | bool
      arista.eos.eos_banner:
        banner: login
        text: "{{ baseline.banners.login }}"
        state: present

    - name: MOTD banner
      when: apply_changes | bool
      arista.eos.eos_banner:
        banner: motd
        text: "{{ baseline.banners.motd }}"
        state: present

    - name: NTP servers
      when: apply_changes | bool
      arista.eos.eos_ntp:
        config: { servers: "{{ baseline.ntp }}" }
        state: merged

    - name: Syslog targets
      when: apply_changes | bool
      arista.eos.eos_logging:
        config: { hosts: "{{ baseline.syslog }}" }
        state: merged

    - name: Enable eAPI
      when: apply_changes | bool and baseline.eapi.enabled | default(True)
      arista.eos.eos_eapi:
        http: false
        https: "{{ baseline.eapi.https | default(True) }}"
        state: started
        vrf: "{{ baseline.eapi.vrf | default('MGMT') }}"
