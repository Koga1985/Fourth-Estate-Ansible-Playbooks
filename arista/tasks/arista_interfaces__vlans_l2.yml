---
- name: Configure VLANs and L2 access/trunk ports
  hosts: arista
  gather_facts: false
  collections:
    - arista.eos
    - arista.cvp
    - ansible.utils
  vars:
    apply_changes: false
    artifacts_dir: "/tmp/arista-artifacts"
  pre_tasks:
    - name: Ensure artifacts dir
      ansible.builtin.file:
        path: "{ artifacts_dir }"
        state: directory
        mode: "0755"

  vars:
    vlans: [{ id: 10, name: "USERS" }, { id: 20, name: "SERVERS" }]
    l2_interfaces:
      - { name: "Ethernet1", mode: "access", access_vlan: 10 }
      - { name: "Ethernet2", mode: "trunk", trunk_vlans: "10,20" }

  tasks:
    - name: Plan L2
      ansible.builtin.copy:
        dest: "{{ artifacts_dir }}/l2_plan.json"
        content: "{{ {'vlans': vlans, 'l2_interfaces': l2_interfaces} | to_nice_json }}"
        mode: "0644"

    - name: VLANs
      when: apply_changes | bool
      arista.eos.eos_vlans:
        config: "{{ vlans }}"
        state: merged

    - name: L2 interfaces
      when: apply_changes | bool and (l2_interfaces | length) > 0
      arista.eos.eos_l2_interfaces:
        config: "{{ l2_interfaces }}"
        state: merged
