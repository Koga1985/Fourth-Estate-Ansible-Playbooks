---
# Open ServiceNow/Jira tasks per item.
- name: Ensure artifacts dir
  ansible.builtin.file:
    path: "{{ artifacts_dir | default('/tmp/ot-artifacts') }}"
    state: directory
    mode: "0755"

- name: Load worklist
  ansible.builtin.slurp:
    src: "{{ artifacts_dir }}/vuln_worklist.csv"
  register: _wl

- name: Open tickets (ServiceNow example)
  when: itsm.type | default('servicenow') == 'servicenow'
  ansible.builtin.uri:
    url: "{{ itsm.url }}/api/now/table/{{ itsm.table | default('incident') }}"
    method: POST
    force_basic_auth: true
    url_username: "{{ itsm.user }}"
    url_password: "{{ itsm.token }}"
    headers: { "Content-Type": "application/json" }
    body_format: json
    body: "{{ item }}"
    status_code: 200,201,409
  loop: "{{ vuln_ticket_payloads | default([]) }}"
  loop_control: { label: "{{ item.short_description | default(item.id) }}" }
