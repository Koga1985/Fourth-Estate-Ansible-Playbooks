---
# CPU/mem/AV checks + VM snapshot if virtualized.
- name: Ensure artifacts dir
  ansible.builtin.file:
    path: "{{ artifacts_dir | default('/tmp/ot-artifacts') }}"
    state: directory
    mode: "0755"

- name: Prechecks (placeholder)
  ansible.builtin.shell: "echo CPU/Memory/AV OK"
  register: _pre
  changed_when: false

- name: Write precheck artifact
  ansible.builtin.copy:
    dest: "{{ artifacts_dir }}/hmi_prechecks_{{ inventory_hostname }}.txt"
    mode: "0644"
    content: "{{ _pre.stdout }}"

- name: Snapshot VM if virtualized (guarded)
  when: vmware is defined and vmware.snapshot | default(true) | bool
  ansible.builtin.debug:
    msg: "Would snapshot VM { inventory_hostname } before patching."
