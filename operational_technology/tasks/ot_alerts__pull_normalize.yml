---
# Pull from OT platforms; normalize to CSV/JSON.
- name: Ensure artifacts dir
  ansible.builtin.file:
    path: "{{ artifacts_dir | default('/tmp/ot-artifacts') }}"
    state: directory
    mode: "0755"

- name: Pull alerts
  ansible.builtin.uri:
    url: "{{ provider.url }}{{ provider.paths.alerts | default('/alerts') }}"
    method: GET
    headers: { Authorization: "{{ provider.token }}" }
    validate_certs: "{{ verify_ssl | default(true) }}"
    return_content: true
  register: _alerts

- name: Save raw alerts
  ansible.builtin.copy:
    dest: "{{ artifacts_dir }}/alerts_raw.json"
    mode: "0644"
    content: "{{ _alerts.json | to_nice_json }}"

- name: Write normalized CSV
  ansible.builtin.copy:
    dest: "{{ artifacts_dir }}/alerts_norm.csv"
    mode: "0644"
    content: |
      time,site,asset,severity,category,message
      {% for a in _alerts.json | default([]) %}
      {{ a.time | default('') }},{{ a.site | default('') }},{{ a.asset | default('') }},{{ a.severity | default('') }},{{ a.category | default('') }},{{ (a.message | default('')) | replace(',',';') }}
      {% endfor %}
