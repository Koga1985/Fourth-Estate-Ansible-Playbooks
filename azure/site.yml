---
# Azure Infrastructure Deployment Playbook
# Entry point for Azure platform automation
#
# Usage:
#   ansible-galaxy collection install -r requirements.yml
#   ansible-playbook -i inventory site.yml
#
# Tags:
#   - identity: Azure AD, RBAC, managed identity
#   - network: VNet, subnets, NSGs
#   - compute: VMs, VMSS, AKS
#   - storage: Storage accounts, blob, file shares
#   - database: SQL, PostgreSQL, MySQL, Cosmos DB
#   - security: Key Vault, Defender, Sentinel
#   - monitoring: Monitor, Log Analytics
#   - compliance: NIST/FedRAMP compliance checks

- name: Azure Infrastructure Deployment
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    # Deployment control - set to true to enable each component
    deploy_identity: true
    deploy_network: true
    deploy_compute: false
    deploy_aks: false
    deploy_storage: true
    deploy_database: false
    deploy_security: true
    deploy_monitoring: true
    deploy_compliance: true

  tasks:
    # =========================================
    # Phase 1: Identity & Access Management
    # =========================================
    - name: Phase 1 - Azure AD Configuration
      ansible.builtin.include_role:
        name: azure_ad
      when: deploy_identity | bool
      tags: ['identity', 'phase1']

    - name: Phase 1 - Azure AD MFA
      ansible.builtin.include_role:
        name: azure_ad_mfa
      when: deploy_identity | bool
      tags: ['identity', 'phase1']

    - name: Phase 1 - RBAC Configuration
      ansible.builtin.include_role:
        name: azure_rbac
      when: deploy_identity | bool
      tags: ['identity', 'phase1']

    - name: Phase 1 - Managed Identity
      ansible.builtin.include_role:
        name: azure_managed_identity
      when: deploy_identity | bool
      tags: ['identity', 'phase1']

    - name: Phase 1 - Service Principals
      ansible.builtin.include_role:
        name: azure_service_principals
      when: deploy_identity | bool
      tags: ['identity', 'phase1']

    - name: Phase 1 - Conditional Access
      ansible.builtin.include_role:
        name: azure_conditional_access
      when: deploy_identity | bool
      tags: ['identity', 'phase1']

    - name: Phase 1 - Privileged Identity Management
      ansible.builtin.include_role:
        name: azure_privileged_identity
      when: deploy_identity | bool
      tags: ['identity', 'phase1']

    # =========================================
    # Phase 2: Networking
    # =========================================
    - name: Phase 2 - Virtual Network
      ansible.builtin.include_role:
        name: azure_vnet
      when: deploy_network | bool
      tags: ['network', 'phase2']

    - name: Phase 2 - Subnets
      ansible.builtin.include_role:
        name: azure_subnets
      when: deploy_network | bool
      tags: ['network', 'phase2']

    - name: Phase 2 - Network Security Groups
      ansible.builtin.include_role:
        name: azure_nsg
      when: deploy_network | bool
      tags: ['network', 'phase2']

    - name: Phase 2 - Azure Firewall
      ansible.builtin.include_role:
        name: azure_firewall
      when: deploy_network | bool
      tags: ['network', 'phase2']

    - name: Phase 2 - Application Gateway
      ansible.builtin.include_role:
        name: azure_application_gateway
      when: deploy_network | bool
      tags: ['network', 'phase2']

    - name: Phase 2 - VPN Gateway
      ansible.builtin.include_role:
        name: azure_vpn_gateway
      when: deploy_network | bool
      tags: ['network', 'phase2']

    # =========================================
    # Phase 3: Security Services
    # =========================================
    - name: Phase 3 - Key Vault
      ansible.builtin.include_role:
        name: azure_key_vault
      when: deploy_security | bool
      tags: ['security', 'phase3']

    - name: Phase 3 - Azure Defender
      ansible.builtin.include_role:
        name: azure_defender
      when: deploy_security | bool
      tags: ['security', 'phase3']

    - name: Phase 3 - Security Center
      ansible.builtin.include_role:
        name: azure_security_center
      when: deploy_security | bool
      tags: ['security', 'phase3']

    - name: Phase 3 - Azure Sentinel
      ansible.builtin.include_role:
        name: azure_sentinel
      when: deploy_security | bool
      tags: ['security', 'phase3']

    - name: Phase 3 - Azure Policy
      ansible.builtin.include_role:
        name: azure_policy
      when: deploy_security | bool
      tags: ['security', 'phase3']

    # =========================================
    # Phase 4: Storage
    # =========================================
    - name: Phase 4 - Storage Accounts
      ansible.builtin.include_role:
        name: azure_storage_account
      when: deploy_storage | bool
      tags: ['storage', 'phase4']

    - name: Phase 4 - Blob Storage
      ansible.builtin.include_role:
        name: azure_blob_storage
      when: deploy_storage | bool
      tags: ['storage', 'phase4']

    - name: Phase 4 - File Shares
      ansible.builtin.include_role:
        name: azure_file_share
      when: deploy_storage | bool
      tags: ['storage', 'phase4']

    - name: Phase 4 - Managed Disks
      ansible.builtin.include_role:
        name: azure_disk_storage
      when: deploy_storage | bool
      tags: ['storage', 'phase4']

    # =========================================
    # Phase 5: Compute (Optional)
    # =========================================
    - name: Phase 5 - Availability Sets
      ansible.builtin.include_role:
        name: azure_availability_sets
      when: deploy_compute | bool
      tags: ['compute', 'phase5']

    - name: Phase 5 - VM Images
      ansible.builtin.include_role:
        name: azure_image
      when: deploy_compute | bool
      tags: ['compute', 'phase5']

    - name: Phase 5 - Virtual Machines
      ansible.builtin.include_role:
        name: azure_vm
      when: deploy_compute | bool
      tags: ['compute', 'phase5']

    - name: Phase 5 - VM Scale Sets
      ansible.builtin.include_role:
        name: azure_vmss
      when: deploy_compute | bool
      tags: ['compute', 'phase5']

    # =========================================
    # Phase 6: AKS (Optional)
    # =========================================
    - name: Phase 6 - Container Registry
      ansible.builtin.include_role:
        name: azure_acr
      when: deploy_aks | bool
      tags: ['aks', 'phase6']

    - name: Phase 6 - AKS Cluster
      ansible.builtin.include_role:
        name: azure_aks
      when: deploy_aks | bool
      tags: ['aks', 'phase6']

    - name: Phase 6 - Container Instances
      ansible.builtin.include_role:
        name: azure_aci
      when: deploy_aks | bool
      tags: ['aks', 'phase6']

    # =========================================
    # Phase 7: Databases (Optional)
    # =========================================
    - name: Phase 7 - Azure SQL Database
      ansible.builtin.include_role:
        name: azure_sql_database
      when: deploy_database | bool
      tags: ['database', 'phase7']

    - name: Phase 7 - PostgreSQL
      ansible.builtin.include_role:
        name: azure_postgresql
      when: deploy_database | bool
      tags: ['database', 'phase7']

    - name: Phase 7 - MySQL
      ansible.builtin.include_role:
        name: azure_mysql
      when: deploy_database | bool
      tags: ['database', 'phase7']

    - name: Phase 7 - Cosmos DB
      ansible.builtin.include_role:
        name: azure_cosmos_db
      when: deploy_database | bool
      tags: ['database', 'phase7']

    # =========================================
    # Phase 8: Monitoring & Logging
    # =========================================
    - name: Phase 8 - Log Analytics
      ansible.builtin.include_role:
        name: azure_log_analytics
      when: deploy_monitoring | bool
      tags: ['monitoring', 'phase8']

    - name: Phase 8 - Azure Monitor
      ansible.builtin.include_role:
        name: azure_monitor
      when: deploy_monitoring | bool
      tags: ['monitoring', 'phase8']

    - name: Phase 8 - Application Insights
      ansible.builtin.include_role:
        name: azure_application_insights
      when: deploy_monitoring | bool
      tags: ['monitoring', 'phase8']

    # =========================================
    # Phase 9: Compliance Validation
    # =========================================
    - name: Phase 9 - NIST Compliance Check
      ansible.builtin.include_role:
        name: azure_nist_compliance
      when: deploy_compliance | bool
      tags: ['compliance', 'phase9']

    - name: Phase 9 - FedRAMP Compliance Check
      ansible.builtin.include_role:
        name: azure_fedramp_compliance
      when: deploy_compliance | bool
      tags: ['compliance', 'phase9']

    - name: Phase 9 - Azure Compliance Review
      ansible.builtin.include_role:
        name: azure_compliance
      when: deploy_compliance | bool
      tags: ['compliance', 'phase9']

    # =========================================
    # Deployment Summary
    # =========================================
    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "=== Azure Deployment Complete ==="
          - "Location: {{ azure_location | default('eastus') }}"
          - "Environment: {{ azure_environment | default('production') }}"
          - "Resource Group: {{ azure_resource_group | default('myorg-production-rg') }}"
          - "Identity: {{ 'Configured' if deploy_identity else 'Skipped' }}"
          - "Network: {{ 'Configured' if deploy_network else 'Skipped' }}"
          - "Security: {{ 'Configured' if deploy_security else 'Skipped' }}"
          - "Storage: {{ 'Configured' if deploy_storage else 'Skipped' }}"
          - "Compute: {{ 'Configured' if deploy_compute else 'Skipped' }}"
          - "AKS: {{ 'Configured' if deploy_aks else 'Skipped' }}"
          - "Database: {{ 'Configured' if deploy_database else 'Skipped' }}"
          - "Monitoring: {{ 'Configured' if deploy_monitoring else 'Skipped' }}"
          - "Compliance: {{ 'Validated' if deploy_compliance else 'Skipped' }}"
      tags: ['always']
