# Veeam Backup & Replication Installation Verification Script
# Generated by Ansible for {{ ansible_hostname }}

Add-PSSnapin VeeamPSSnapin -ErrorAction Stop

Write-Host "=== Veeam Backup & Replication Installation Verification ===" -ForegroundColor Cyan

# Check server information
$server = Get-VBRLocalhost
Write-Host "`nVeeam Server: $($server.Name)" -ForegroundColor Green
Write-Host "Version: $($server.Info.ProductVersion)" -ForegroundColor Green

# Check license
$license = Get-VBRInstalledLicense
Write-Host "`nLicense Information:" -ForegroundColor Yellow
Write-Host "Edition: $($license.Edition)"
Write-Host "Licensed to: $($license.LicensedTo)"
Write-Host "Expiration: $($license.ExpirationDate)"
Write-Host "Support Expiration: $($license.SupportExpirationDate)"

# Check services
Write-Host "`nVeeam Services Status:" -ForegroundColor Yellow
$services = @(
    "VeeamBackupSvc",
    "VeeamBrokerSvc",
    "VeeamCatalogSvc",
    "VeeamCloudSvc",
    "VeeamDeploymentService",
    "VeeamEnterpriseManagerSvc",
    "VeeamMountSvc",
    "VeeamRESTSvc"
)

foreach ($svc in $services) {
    $service = Get-Service $svc -ErrorAction SilentlyContinue
    if ($service) {
        $color = if ($service.Status -eq "Running") { "Green" } else { "Red" }
        Write-Host "$($svc): $($service.Status)" -ForegroundColor $color
    }
}

# Check database connection
Write-Host "`nDatabase Configuration:" -ForegroundColor Yellow
$config = Get-VBRConfiguration
Write-Host "SQL Server: $($config.SqlServerName)"
Write-Host "Database: $($config.SqlDatabaseName)"

# Check backup infrastructure
Write-Host "`nBackup Infrastructure:" -ForegroundColor Yellow
$proxies = Get-VBRViProxy
Write-Host "Backup Proxies: $($proxies.Count)"

$repos = Get-VBRBackupRepository
Write-Host "Backup Repositories: $($repos.Count)"

# Fourth Estate compliance checks
{% if fourth_estate_mode %}
Write-Host "`nFourth Estate Compliance:" -ForegroundColor Cyan
Write-Host "Audit Logging: {{ 'Enabled' if enable_audit_logging else 'Disabled' }}"
Write-Host "MFA Required: {{ 'Yes' if require_mfa else 'No' }}"
Write-Host "Immutable Backups: {{ 'Enabled' if immutable_backups else 'Disabled' }}"
Write-Host "Encryption Required: {{ 'Yes' if encryption_required else 'No' }}"
{% endif %}

Write-Host "`n=== Verification Complete ===" -ForegroundColor Cyan
