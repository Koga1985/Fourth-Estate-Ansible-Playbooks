---
# tasks file for aws_route_tables

- name: Create route tables
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ item.vpc_id | default(vpc_id) }}"
    region: "{{ item.region | default(aws_region) }}"
    tags: "{{ item.tags | default(route_table_tags) | combine({'Name': item.name, 'ManagedBy': 'Ansible'}) }}"
    routes: "{{ item.routes | default([]) }}"
    subnets: "{{ item.subnets | default([]) }}"
    purge_routes: "{{ item.purge_routes | default(true) }}"
    purge_subnets: "{{ item.purge_subnets | default(false) }}"
    state: "{{ item.state | default(route_table_state) }}"
  loop: "{{ route_tables }}"
  when: route_tables is defined
  register: route_table_result

- name: Create public route table with Internet Gateway
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ vpc_id }}"
    region: "{{ aws_region }}"
    tags: "{{ route_table_tags | combine({'Name': route_table_public_name, 'Type': 'Public', 'ManagedBy': 'Ansible'}) }}"
    routes:
      - dest: "0.0.0.0/0"
        gateway_id: "{{ internet_gateway_id }}"
    subnets: "{{ public_subnet_ids }}"
    state: "{{ route_table_state }}"
  when:
    - create_public_route_table | bool
    - internet_gateway_id is defined
    - public_subnet_ids is defined
  register: public_route_table

- name: Create private route tables with NAT Gateway
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ vpc_id }}"
    region: "{{ aws_region }}"
    tags: "{{ route_table_tags | combine({'Name': item.name, 'Type': 'Private', 'AvailabilityZone': item.az, 'ManagedBy': 'Ansible'}) }}"
    routes:
      - dest: "0.0.0.0/0"
        gateway_id: "{{ item.nat_gateway_id }}"
    subnets: "{{ item.subnets }}"
    state: "{{ route_table_state }}"
  loop: "{{ private_route_tables }}"
  when:
    - create_private_route_tables | bool
    - private_route_tables is defined
  register: private_route_table_results

- name: Create route table for VPN connectivity
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ vpc_id }}"
    region: "{{ aws_region }}"
    tags: "{{ route_table_tags | combine({'Name': route_table_vpn_name, 'Type': 'VPN', 'ManagedBy': 'Ansible'}) }}"
    routes:
      - dest: "{{ item.destination }}"
        gateway_id: "{{ vpn_gateway_id }}"
    subnets: "{{ vpn_subnet_ids | default([]) }}"
    state: "{{ route_table_state }}"
  loop: "{{ vpn_routes }}"
  when:
    - create_vpn_route_table | bool
    - vpn_gateway_id is defined
    - vpn_routes is defined
  register: vpn_route_table

- name: Add routes to Transit Gateway
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ vpc_id }}"
    region: "{{ aws_region }}"
    route_table_id: "{{ item.route_table_id }}"
    routes:
      - dest: "{{ item.destination }}"
        gateway_id: "{{ transit_gateway_id }}"
    lookup: id
    state: "{{ route_table_state }}"
  loop: "{{ transit_gateway_routes }}"
  when:
    - enable_transit_gateway | bool
    - transit_gateway_id is defined
    - transit_gateway_routes is defined

- name: Enable route propagation for VPN
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ vpc_id }}"
    region: "{{ aws_region }}"
    route_table_id: "{{ item.route_table_id }}"
    propagating_vgw_ids:
      - "{{ vpn_gateway_id }}"
    lookup: id
    state: "{{ route_table_state }}"
  loop: "{{ route_tables_with_propagation }}"
  when:
    - enable_route_propagation | bool
    - vpn_gateway_id is defined
    - route_tables_with_propagation is defined

- name: Tag route tables for compliance
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ vpc_id }}"
    region: "{{ aws_region }}"
    route_table_id: "{{ item.route_table_id }}"
    tags: "{{ route_table_tags | combine({'Compliance': 'FedRAMP-High', 'DataFlow': item.data_flow}) }}"
    lookup: id
    state: "{{ route_table_state }}"
  loop: "{{ route_table_result.results }}"
  when:
    - route_table_result is defined
    - item.route_table is defined

- name: Display route table summary
  ansible.builtin.debug:
    msg:
      - "Route Tables Created: {{ route_table_result.results | selectattr('changed', 'equalto', true) | list | length if route_table_result is defined else 0 }}"
      - "Public Route Table ID: {{ public_route_table.route_table.id if public_route_table is defined and public_route_table.route_table is defined else 'N/A' }}"
      - "Private Route Tables: {{ private_route_table_results.results | length if private_route_table_results is defined else 0 }}"

- name: Notify route table changes
  ansible.builtin.debug:
    msg: "Route table configuration completed"
  changed_when: true
  notify: notify route table changes
  when:
    - route_table_result is defined
    - route_table_result.changed | default(false)
