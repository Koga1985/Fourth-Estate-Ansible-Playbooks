---
# tasks file for aws_ec2_key_pairs

- name: Create EC2 key pairs
  amazon.aws.ec2_key:
    name: "{{ item.name }}"
    region: "{{ item.region | default(aws_region) }}"
    key_material: "{{ item.public_key | default(omit) }}"
    tags: "{{ item.tags | default(key_pair_tags) | combine({'Name': item.name, 'ManagedBy': 'Ansible'}) }}"
    state: "{{ item.state | default(key_pair_state) }}"
  loop: "{{ ec2_key_pairs }}"
  when: ec2_key_pairs is defined
  register: key_pair_result

- name: Save private keys securely
  ansible.builtin.copy:
    content: "{{ item.key.private_key }}"
    dest: "{{ key_pair_output_dir }}/{{ item.key.name }}.pem"
    mode: '0400'
  loop: "{{ key_pair_result.results }}"
  when:
    - key_pair_result is defined
    - item.key is defined
    - item.key.private_key is defined
    - key_pair_save_private_keys | bool
  delegate_to: localhost
  no_log: true

- name: Generate local key pairs
  community.crypto.openssh_keypair:
    path: "{{ key_pair_output_dir }}/{{ item.name }}"
    type: "{{ item.type | default('rsa') }}"
    size: "{{ item.size | default(4096) }}"
    comment: "{{ item.comment | default('Generated by Ansible for ' + item.name) }}"
    state: present
  loop: "{{ ec2_key_pairs }}"
  when:
    - ec2_key_pairs is defined
    - item.generate_locally | default(false) | bool
  delegate_to: localhost
  register: local_key_result

- name: Upload locally generated keys to AWS
  amazon.aws.ec2_key:
    name: "{{ item.item.name }}"
    region: "{{ item.item.region | default(aws_region) }}"
    key_material: "{{ lookup('file', key_pair_output_dir + '/' + item.item.name + '.pub') }}"
    tags: "{{ item.item.tags | default(key_pair_tags) | combine({'Name': item.item.name, 'ManagedBy': 'Ansible'}) }}"
    state: present
  loop: "{{ local_key_result.results }}"
  when:
    - local_key_result is defined
    - item.changed | default(false)

- name: Tag key pairs for compliance
  amazon.aws.ec2_key:
    name: "{{ item.key.name }}"
    region: "{{ item.item.region | default(aws_region) }}"
    tags: "{{ key_pair_tags | combine({'Compliance': 'FedRAMP-High', 'KeyType': 'SSH', 'RotationDate': ansible_date_time.date}) }}"
    state: present
  loop: "{{ key_pair_result.results }}"
  when:
    - key_pair_result is defined
    - item.key is defined

- name: Create key rotation reminder
  ansible.builtin.template:
    src: "key_rotation_schedule.j2"
    dest: "/tmp/key_rotation_schedule_{{ ansible_date_time.date }}.txt"
    mode: '0644'
  delegate_to: localhost
  when: key_pair_enable_rotation_tracking | bool

- name: Display key pair summary
  ansible.builtin.debug:
    msg:
      - "Key Pairs Created: {{ key_pair_result.results | selectattr('changed', 'equalto', true) | list | length if key_pair_result is defined else 0 }}"
      - "Total Key Pairs Managed: {{ ec2_key_pairs | length if ec2_key_pairs is defined else 0 }}"
      - "Private Keys Saved: {{ key_pair_output_dir }}"

- name: Notify key pair changes
  ansible.builtin.debug:
    msg: "EC2 key pair configuration completed"
  changed_when: true
  notify: notify key pair changes
  when:
    - key_pair_result is defined
    - key_pair_result.changed | default(false)
