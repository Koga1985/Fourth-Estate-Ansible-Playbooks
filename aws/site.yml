---
# AWS Infrastructure Deployment Playbook
# Entry point for AWS platform automation
#
# Usage:
#   ansible-galaxy collection install -r requirements.yml
#   ansible-playbook -i inventory site.yml
#
# Tags:
#   - iam: Identity and Access Management only
#   - network: VPC, subnets, routing only
#   - compute: EC2, EKS only
#   - storage: S3, EBS only
#   - database: RDS only
#   - security: Security services only
#   - monitoring: CloudWatch, CloudTrail only
#   - compliance: FedRAMP/NIST compliance checks

- name: AWS Infrastructure Deployment
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    # Deployment control - set to true to enable each component
    deploy_iam: true
    deploy_network: true
    deploy_compute: false
    deploy_eks: false
    deploy_storage: true
    deploy_database: false
    deploy_security: true
    deploy_monitoring: true
    deploy_compliance: true

  tasks:
    # =========================================
    # Phase 1: Identity & Access Management
    # =========================================
    - name: Phase 1 - IAM Policies
      ansible.builtin.include_role:
        name: aws_iam_policies
      when: deploy_iam | bool
      tags: ['iam', 'phase1']

    - name: Phase 1 - IAM Roles
      ansible.builtin.include_role:
        name: aws_iam_roles
      when: deploy_iam | bool
      tags: ['iam', 'phase1']

    - name: Phase 1 - IAM Groups
      ansible.builtin.include_role:
        name: aws_iam_groups
      when: deploy_iam | bool
      tags: ['iam', 'phase1']

    - name: Phase 1 - IAM Users
      ansible.builtin.include_role:
        name: aws_iam_users
      when: deploy_iam | bool
      tags: ['iam', 'phase1']

    - name: Phase 1 - IAM MFA Enforcement
      ansible.builtin.include_role:
        name: aws_iam_mfa
      when: deploy_iam | bool
      tags: ['iam', 'phase1']

    # =========================================
    # Phase 2: Networking
    # =========================================
    - name: Phase 2 - VPC
      ansible.builtin.include_role:
        name: aws_vpc
      when: deploy_network | bool
      tags: ['network', 'phase2']

    - name: Phase 2 - Subnets
      ansible.builtin.include_role:
        name: aws_subnets
      when: deploy_network | bool
      tags: ['network', 'phase2']

    - name: Phase 2 - Route Tables
      ansible.builtin.include_role:
        name: aws_route_tables
      when: deploy_network | bool
      tags: ['network', 'phase2']

    - name: Phase 2 - Network ACLs
      ansible.builtin.include_role:
        name: aws_nacls
      when: deploy_network | bool
      tags: ['network', 'phase2']

    - name: Phase 2 - Security Groups
      ansible.builtin.include_role:
        name: aws_security_groups
      when: deploy_network | bool
      tags: ['network', 'phase2']

    - name: Phase 2 - VPN Configuration
      ansible.builtin.include_role:
        name: aws_vpn
      when: deploy_network | bool
      tags: ['network', 'phase2']

    # =========================================
    # Phase 3: Security Services
    # =========================================
    - name: Phase 3 - KMS Key Management
      ansible.builtin.include_role:
        name: aws_kms
      when: deploy_security | bool
      tags: ['security', 'phase3']

    - name: Phase 3 - GuardDuty
      ansible.builtin.include_role:
        name: aws_guardduty_detector
      when: deploy_security | bool
      tags: ['security', 'phase3']

    - name: Phase 3 - IAM Access Analyzer
      ansible.builtin.include_role:
        name: aws_iam_access_analyzer
      when: deploy_security | bool
      tags: ['security', 'phase3']

    # =========================================
    # Phase 4: Storage
    # =========================================
    - name: Phase 4 - S3 Buckets
      ansible.builtin.include_role:
        name: aws_s3_buckets
      when: deploy_storage | bool
      tags: ['storage', 'phase4']

    - name: Phase 4 - S3 Lifecycle Policies
      ansible.builtin.include_role:
        name: aws_s3_lifecycle
      when: deploy_storage | bool
      tags: ['storage', 'phase4']

    - name: Phase 4 - EBS Volumes
      ansible.builtin.include_role:
        name: aws_ec2_ebs_volumes
      when: deploy_storage | bool
      tags: ['storage', 'phase4']

    # =========================================
    # Phase 5: Compute (Optional)
    # =========================================
    - name: Phase 5 - EC2 Key Pairs
      ansible.builtin.include_role:
        name: aws_ec2_key_pairs
      when: deploy_compute | bool
      tags: ['compute', 'phase5']

    - name: Phase 5 - EC2 Instances
      ansible.builtin.include_role:
        name: aws_ec2_instances
      when: deploy_compute | bool
      tags: ['compute', 'phase5']

    - name: Phase 5 - EC2 AMIs
      ansible.builtin.include_role:
        name: aws_ec2_amis
      when: deploy_compute | bool
      tags: ['compute', 'phase5']

    # =========================================
    # Phase 6: EKS (Optional)
    # =========================================
    - name: Phase 6 - EKS Clusters
      ansible.builtin.include_role:
        name: aws_eks_clusters
      when: deploy_eks | bool
      tags: ['eks', 'phase6']

    - name: Phase 6 - EKS Node Groups
      ansible.builtin.include_role:
        name: aws_eks_node_groups
      when: deploy_eks | bool
      tags: ['eks', 'phase6']

    # =========================================
    # Phase 7: Databases (Optional)
    # =========================================
    - name: Phase 7 - RDS Databases
      ansible.builtin.include_role:
        name: aws_rds
      when: deploy_database | bool
      tags: ['database', 'phase7']

    # =========================================
    # Phase 8: Monitoring & Logging
    # =========================================
    - name: Phase 8 - CloudTrail
      ansible.builtin.include_role:
        name: aws_cloudtrail_trails
      when: deploy_monitoring | bool
      tags: ['monitoring', 'phase8']

    - name: Phase 8 - CloudWatch Logs
      ansible.builtin.include_role:
        name: aws_cloudwatch_logs
      when: deploy_monitoring | bool
      tags: ['monitoring', 'phase8']

    - name: Phase 8 - CloudWatch Alarms
      ansible.builtin.include_role:
        name: aws_cloudwatch_alarms
      when: deploy_monitoring | bool
      tags: ['monitoring', 'phase8']

    - name: Phase 8 - AWS Config Rules
      ansible.builtin.include_role:
        name: aws_config_rules
      when: deploy_monitoring | bool
      tags: ['monitoring', 'phase8']

    # =========================================
    # Phase 9: Compliance Validation
    # =========================================
    - name: Phase 9 - FedRAMP Compliance Check
      ansible.builtin.include_role:
        name: aws_fedramp_compliance
      when: deploy_compliance | bool
      tags: ['compliance', 'phase9']

    # =========================================
    # Deployment Summary
    # =========================================
    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "=== AWS Deployment Complete ==="
          - "Region: {{ aws_region | default('us-east-1') }}"
          - "Environment: {{ aws_environment | default('production') }}"
          - "IAM: {{ 'Configured' if deploy_iam else 'Skipped' }}"
          - "Network: {{ 'Configured' if deploy_network else 'Skipped' }}"
          - "Security: {{ 'Configured' if deploy_security else 'Skipped' }}"
          - "Storage: {{ 'Configured' if deploy_storage else 'Skipped' }}"
          - "Compute: {{ 'Configured' if deploy_compute else 'Skipped' }}"
          - "EKS: {{ 'Configured' if deploy_eks else 'Skipped' }}"
          - "Database: {{ 'Configured' if deploy_database else 'Skipped' }}"
          - "Monitoring: {{ 'Configured' if deploy_monitoring else 'Skipped' }}"
          - "Compliance: {{ 'Validated' if deploy_compliance else 'Skipped' }}"
      tags: ['always']
