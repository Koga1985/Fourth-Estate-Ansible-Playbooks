---
# defaults file for postgresql_install
# Production-ready defaults for Fourth Estate PostgreSQL deployments

# PostgreSQL version
postgresql_version: 15
postgresql_major_version: "{{ postgresql_version }}"

# Installation paths
postgresql_bin_path: "/usr/pgsql-{{ postgresql_version }}/bin"
postgresql_home_directory: "/var/lib/pgsql"
postgresql_data_directory: "/var/lib/pgsql/{{ postgresql_version }}/data"
postgresql_config_directory: "{{ postgresql_data_directory }}"
postgresql_log_directory: "/var/log/postgresql"
postgresql_backup_directory: "/var/lib/pgsql/backups"
postgresql_wal_archive_directory: "/var/lib/pgsql/wal_archive"

# Optional tablespace directories
postgresql_tablespace_directories: []

# PostgreSQL packages (OS-specific, can be overridden in vars/)
postgresql_packages:
  - "postgresql{{ postgresql_version }}-server"
  - "postgresql{{ postgresql_version }}"
  - "postgresql{{ postgresql_version }}-libs"

postgresql_contrib_packages:
  - "postgresql{{ postgresql_version }}-contrib"
  - "postgresql{{ postgresql_version }}-devel"

postgresql_pgaudit_package: "pgaudit{{ postgresql_version }}_{{ postgresql_version }}"
postgresql_python_package: "python3-psycopg2"

# Database initialization parameters
postgresql_encoding: UTF8
postgresql_locale: en_US.UTF-8
postgresql_initial_password: "{{ vault_postgresql_superuser_password | default('ChangeMe123!') }}"

# Network configuration
postgresql_port: 5432
postgresql_listen_addresses: "localhost"
postgresql_max_connections: 200

# Service configuration
postgresql_service_enabled: true
postgresql_configure_firewall: true
postgresql_configure_kernel_parameters: true

# Kernel and system tuning
postgresql_shared_buffers_mb: "{{ (ansible_memtotal_mb * 0.25) | int }}"
postgresql_effective_cache_size_mb: "{{ (ansible_memtotal_mb * 0.75) | int }}"
postgresql_maintenance_work_mem_mb: "{{ [2048, (ansible_memtotal_mb * 0.05) | int] | min }}"
postgresql_work_mem_mb: "{{ ((ansible_memtotal_mb * 0.25) / postgresql_max_connections) | int }}"

# Security settings
postgresql_ssl_enabled: true
postgresql_ssl_cert_file: "/etc/pki/tls/certs/postgresql.crt"
postgresql_ssl_key_file: "/etc/pki/tls/private/postgresql.key"
postgresql_ssl_ca_file: "/etc/pki/tls/certs/ca-bundle.crt"
postgresql_auth_method: scram-sha-256

# WAL and replication settings
postgresql_wal_level: replica
postgresql_max_wal_senders: 10
postgresql_wal_keep_size_mb: 1024

# Logging configuration
postgresql_log_destination: stderr
postgresql_logging_collector: "on"
postgresql_log_filename: "postgresql-%Y-%m-%d_%H%M%S.log"
postgresql_log_rotation_age: 1d
postgresql_log_rotation_size: 100MB
postgresql_log_min_duration_statement: 1000
postgresql_log_line_prefix: "%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h "
postgresql_log_connections: "on"
postgresql_log_disconnections: "on"
postgresql_log_lock_waits: "on"
postgresql_log_checkpoints: "on"

# Performance and optimization
postgresql_checkpoint_completion_target: 0.9
postgresql_max_wal_size_gb: 4
postgresql_min_wal_size_gb: 1
postgresql_random_page_cost: 1.1
postgresql_effective_io_concurrency: 200

# Autovacuum settings
postgresql_autovacuum: "on"
postgresql_autovacuum_max_workers: 3
postgresql_autovacuum_naptime: 60

# Query planner
postgresql_default_statistics_target: 100

# Compliance and auditing
postgresql_pgaudit_enabled: true
postgresql_pgaudit_log: "ddl, role, read, write"
postgresql_pgaudit_log_catalog: "off"
postgresql_pgaudit_log_parameter: "on"
postgresql_pgaudit_log_relation: "on"
postgresql_pgaudit_log_statement_once: "off"

# DISA STIG compliance settings
postgresql_stig_mode: true
postgresql_fips_mode: false

# Monitoring and health checks
postgresql_health_check_enabled: true
postgresql_health_check_interval: 60

# Backup integration
postgresql_archive_mode: "on"
postgresql_archive_command: "test ! -f {{ postgresql_wal_archive_directory }}/%f && cp %p {{ postgresql_wal_archive_directory }}/%f"

# Extensions to preload
postgresql_shared_preload_libraries:
  - pgaudit
  - pg_stat_statements

# Timezone
postgresql_timezone: UTC

# Connection pooling
postgresql_statement_timeout: 0
postgresql_idle_in_transaction_session_timeout: 0

# Custom configuration snippets
postgresql_custom_config: {}
