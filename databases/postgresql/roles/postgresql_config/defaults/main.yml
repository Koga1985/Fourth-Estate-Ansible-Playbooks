---
# defaults file for postgresql_config
# Production-ready PostgreSQL configuration defaults

# PostgreSQL version and paths
postgresql_version: 15
postgresql_bin_path: "/usr/pgsql-{{ postgresql_version }}/bin"
postgresql_data_directory: "/var/lib/pgsql/{{ postgresql_version }}/data"
postgresql_config_directory: "{{ postgresql_data_directory }}"
postgresql_log_directory: "/var/log/postgresql"

# Network settings
postgresql_port: 5432
postgresql_listen_addresses: "*"
postgresql_max_connections: 200
postgresql_superuser_reserved_connections: 3

# Memory settings (calculated from system RAM)
postgresql_shared_buffers: "{{ (ansible_memtotal_mb * 0.25) | int }}MB"
postgresql_effective_cache_size: "{{ (ansible_memtotal_mb * 0.75) | int }}MB"
postgresql_maintenance_work_mem: "{{ [2048, (ansible_memtotal_mb * 0.05) | int] | min }}MB"
postgresql_work_mem: "{{ ((ansible_memtotal_mb * 1024 * 0.25) / postgresql_max_connections / 1024) | int }}MB"
postgresql_shared_preload_libraries: "pgaudit,pg_stat_statements"

# WAL settings
postgresql_wal_level: replica
postgresql_wal_buffers: 16MB
postgresql_min_wal_size: 1GB
postgresql_max_wal_size: 4GB
postgresql_wal_keep_size: 1GB
postgresql_archive_mode: "on"
postgresql_archive_command: "/bin/true"
postgresql_max_wal_senders: 10
postgresql_wal_sender_timeout: 60s

# Checkpoints
postgresql_checkpoint_timeout: 15min
postgresql_checkpoint_completion_target: 0.9
postgresql_checkpoint_warning: 30s

# Logging
postgresql_log_destination: stderr
postgresql_logging_collector: "on"
postgresql_log_directory: "{{ postgresql_log_directory }}"
postgresql_log_filename: "postgresql-%Y-%m-%d_%H%M%S.log"
postgresql_log_file_mode: "0640"
postgresql_log_rotation_age: 1d
postgresql_log_rotation_size: 100MB
postgresql_log_min_duration_statement: 1000
postgresql_log_checkpoints: "on"
postgresql_log_connections: "on"
postgresql_log_disconnections: "on"
postgresql_log_duration: "off"
postgresql_log_line_prefix: "%m [%p] %q%u@%d "
postgresql_log_lock_waits: "on"
postgresql_log_statement: "ddl"
postgresql_log_temp_files: 0

# Query planner
postgresql_random_page_cost: 1.1
postgresql_effective_io_concurrency: 200
postgresql_default_statistics_target: 100

# SSL/TLS configuration
postgresql_ssl_enabled: true
postgresql_ssl_cert_directory: "{{ postgresql_data_directory }}"
postgresql_ssl_cert_file: "{{ postgresql_ssl_cert_directory }}/server.crt"
postgresql_ssl_key_file: "{{ postgresql_ssl_cert_directory }}/server.key"
postgresql_ssl_ca_file: "{{ postgresql_ssl_cert_directory }}/root.crt"
postgresql_ssl_ciphers: "HIGH:MEDIUM:+3DES:!aNULL"
postgresql_ssl_prefer_server_ciphers: "on"
postgresql_ssl_min_protocol_version: TLSv1.2
postgresql_ssl_generate_self_signed: true

# Authentication and security
postgresql_password_encryption: scram-sha-256
postgresql_db_user_namespace: "off"

# pgAudit configuration
postgresql_pgaudit_enabled: true
postgresql_pgaudit_log: "ddl, role, read, write"
postgresql_pgaudit_log_catalog: "off"
postgresql_pgaudit_log_level: log
postgresql_pgaudit_log_parameter: "on"
postgresql_pgaudit_log_relation: "on"
postgresql_pgaudit_log_statement_once: "off"

# pg_stat_statements configuration
postgresql_pg_stat_statements_enabled: true
postgresql_pg_stat_statements_max: 10000
postgresql_pg_stat_statements_track: all
postgresql_pg_stat_statements_track_utility: "on"

# Autovacuum
postgresql_autovacuum: "on"
postgresql_autovacuum_max_workers: 3
postgresql_autovacuum_naptime: 1min
postgresql_autovacuum_vacuum_threshold: 50
postgresql_autovacuum_analyze_threshold: 50
postgresql_autovacuum_vacuum_scale_factor: 0.2
postgresql_autovacuum_analyze_scale_factor: 0.1

# Client connection defaults
postgresql_timezone: UTC
postgresql_lc_messages: en_US.UTF-8
postgresql_lc_monetary: en_US.UTF-8
postgresql_lc_numeric: en_US.UTF-8
postgresql_lc_time: en_US.UTF-8
postgresql_default_text_search_config: pg_catalog.english

# Lock management
postgresql_deadlock_timeout: 1s
postgresql_max_locks_per_transaction: 64

# Error handling
postgresql_exit_on_error: "off"
postgresql_restart_after_crash: "on"

# Background writer
postgresql_bgwriter_delay: 200ms
postgresql_bgwriter_lru_maxpages: 100
postgresql_bgwriter_lru_multiplier: 2.0

# Async behavior
postgresql_effective_cache_size: "{{ (ansible_memtotal_mb * 0.75) | int }}MB"

# pg_hba.conf rules
postgresql_hba_entries:
  - {type: local, database: all, user: postgres, auth_method: peer}
  - {type: local, database: all, user: all, auth_method: peer}
  - {type: host, database: all, user: all, address: "127.0.0.1/32", auth_method: scram-sha-256}
  - {type: host, database: all, user: all, address: "::1/128", auth_method: scram-sha-256}
  - {type: host, database: replication, user: replicator, address: "0.0.0.0/0", auth_method: scram-sha-256}

# pg_ident.conf mappings
postgresql_ident_mappings: []

# Custom configuration snippets
postgresql_custom_configs: {}

# Database and user management
postgresql_databases: []
postgresql_users: []
postgresql_extensions: []
postgresql_privileges: []

# Encoding
postgresql_encoding: UTF8
postgresql_locale: en_US.UTF-8
