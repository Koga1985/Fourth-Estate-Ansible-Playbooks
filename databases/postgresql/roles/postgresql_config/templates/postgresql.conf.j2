# {{ ansible_managed }}
# PostgreSQL {{ postgresql_version }} Configuration File
# Optimized for Fourth Estate production environments

#------------------------------------------------------------------------------
# FILE LOCATIONS
#------------------------------------------------------------------------------
data_directory = '{{ postgresql_data_directory }}'
hba_file = '{{ postgresql_config_directory }}/pg_hba.conf'
ident_file = '{{ postgresql_config_directory }}/pg_ident.conf'

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------
listen_addresses = '{{ postgresql_listen_addresses }}'
port = {{ postgresql_port }}
max_connections = {{ postgresql_max_connections }}
superuser_reserved_connections = {{ postgresql_superuser_reserved_connections }}
password_encryption = {{ postgresql_password_encryption }}

#------------------------------------------------------------------------------
# RESOURCE USAGE (except WAL)
#------------------------------------------------------------------------------
shared_buffers = {{ postgresql_shared_buffers }}
huge_pages = try
work_mem = {{ postgresql_work_mem }}
maintenance_work_mem = {{ postgresql_maintenance_work_mem }}
effective_cache_size = {{ postgresql_effective_cache_size }}
effective_io_concurrency = {{ postgresql_effective_io_concurrency }}

#------------------------------------------------------------------------------
# WRITE-AHEAD LOG
#------------------------------------------------------------------------------
wal_level = {{ postgresql_wal_level }}
fsync = on
synchronous_commit = on
wal_buffers = {{ postgresql_wal_buffers }}
checkpoint_timeout = {{ postgresql_checkpoint_timeout }}
checkpoint_completion_target = {{ postgresql_checkpoint_completion_target }}
checkpoint_warning = {{ postgresql_checkpoint_warning }}
max_wal_size = {{ postgresql_max_wal_size }}
min_wal_size = {{ postgresql_min_wal_size }}

#------------------------------------------------------------------------------
# REPLICATION
#------------------------------------------------------------------------------
max_wal_senders = {{ postgresql_max_wal_senders }}
{% if postgresql_version | int >= 13 %}
wal_keep_size = {{ postgresql_wal_keep_size }}
{% else %}
wal_keep_segments = 64
{% endif %}
wal_sender_timeout = {{ postgresql_wal_sender_timeout }}
max_replication_slots = {{ postgresql_max_wal_senders }}
hot_standby = on
hot_standby_feedback = on

#------------------------------------------------------------------------------
# WAL ARCHIVING
#------------------------------------------------------------------------------
archive_mode = {{ postgresql_archive_mode }}
archive_command = '{{ postgresql_archive_command }}'
archive_timeout = 0

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------
random_page_cost = {{ postgresql_random_page_cost }}
default_statistics_target = {{ postgresql_default_statistics_target }}

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------
log_destination = '{{ postgresql_log_destination }}'
logging_collector = {{ postgresql_logging_collector }}
log_directory = '{{ postgresql_log_directory }}'
log_filename = '{{ postgresql_log_filename }}'
log_file_mode = {{ postgresql_log_file_mode }}
log_rotation_age = {{ postgresql_log_rotation_age }}
log_rotation_size = {{ postgresql_log_rotation_size }}
log_min_duration_statement = {{ postgresql_log_min_duration_statement }}
log_checkpoints = {{ postgresql_log_checkpoints }}
log_connections = {{ postgresql_log_connections }}
log_disconnections = {{ postgresql_log_disconnections }}
log_duration = {{ postgresql_log_duration }}
log_line_prefix = '{{ postgresql_log_line_prefix }}'
log_lock_waits = {{ postgresql_log_lock_waits }}
log_statement = '{{ postgresql_log_statement }}'
log_temp_files = {{ postgresql_log_temp_files }}
log_timezone = '{{ postgresql_timezone }}'

#------------------------------------------------------------------------------
# AUTOVACUUM
#------------------------------------------------------------------------------
autovacuum = {{ postgresql_autovacuum }}
autovacuum_max_workers = {{ postgresql_autovacuum_max_workers }}
autovacuum_naptime = {{ postgresql_autovacuum_naptime }}
autovacuum_vacuum_threshold = {{ postgresql_autovacuum_vacuum_threshold }}
autovacuum_analyze_threshold = {{ postgresql_autovacuum_analyze_threshold }}
autovacuum_vacuum_scale_factor = {{ postgresql_autovacuum_vacuum_scale_factor }}
autovacuum_analyze_scale_factor = {{ postgresql_autovacuum_analyze_scale_factor }}

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------
timezone = '{{ postgresql_timezone }}'
lc_messages = '{{ postgresql_lc_messages }}'
lc_monetary = '{{ postgresql_lc_monetary }}'
lc_numeric = '{{ postgresql_lc_numeric }}'
lc_time = '{{ postgresql_lc_time }}'
default_text_search_config = '{{ postgresql_default_text_search_config }}'

#------------------------------------------------------------------------------
# LOCK MANAGEMENT
#------------------------------------------------------------------------------
deadlock_timeout = {{ postgresql_deadlock_timeout }}
max_locks_per_transaction = {{ postgresql_max_locks_per_transaction }}

#------------------------------------------------------------------------------
# SSL/TLS CONFIGURATION
#------------------------------------------------------------------------------
{% if postgresql_ssl_enabled %}
ssl = on
ssl_cert_file = '{{ postgresql_ssl_cert_file }}'
ssl_key_file = '{{ postgresql_ssl_key_file }}'
{% if postgresql_ssl_ca_file is defined %}
ssl_ca_file = '{{ postgresql_ssl_ca_file }}'
{% endif %}
ssl_ciphers = '{{ postgresql_ssl_ciphers }}'
ssl_prefer_server_ciphers = {{ postgresql_ssl_prefer_server_ciphers }}
ssl_min_protocol_version = '{{ postgresql_ssl_min_protocol_version }}'
{% else %}
ssl = off
{% endif %}

#------------------------------------------------------------------------------
# SHARED LIBRARY PRELOADING
#------------------------------------------------------------------------------
shared_preload_libraries = '{{ postgresql_shared_preload_libraries | join(",") }}'

#------------------------------------------------------------------------------
# BACKGROUND WRITER
#------------------------------------------------------------------------------
bgwriter_delay = {{ postgresql_bgwriter_delay }}
bgwriter_lru_maxpages = {{ postgresql_bgwriter_lru_maxpages }}
bgwriter_lru_multiplier = {{ postgresql_bgwriter_lru_multiplier }}

#------------------------------------------------------------------------------
# ERROR HANDLING
#------------------------------------------------------------------------------
exit_on_error = {{ postgresql_exit_on_error }}
restart_after_crash = {{ postgresql_restart_after_crash }}

#------------------------------------------------------------------------------
# CUSTOM CONFIGURATION
#------------------------------------------------------------------------------
{% for key, value in postgresql_custom_configs.items() %}
{{ key }} = {{ value }}
{% endfor %}

# Include additional configuration files
include_dir = 'conf.d'
