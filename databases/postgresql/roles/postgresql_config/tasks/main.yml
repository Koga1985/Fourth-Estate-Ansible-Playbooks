---
# tasks file for postgresql_config
# Production-ready PostgreSQL configuration management

- name: Include OS-specific variables
  include_vars: "{{ ansible_os_family }}.yml"
  when: ansible_os_family in ['RedHat', 'Debian']
  failed_when: false

- name: Ensure PostgreSQL data directory exists
  ansible.builtin.stat:
    path: "{{ postgresql_data_directory }}/PG_VERSION"
  register: pg_data_check
  failed_when: not pg_data_check.stat.exists

- name: Backup existing postgresql.conf
  ansible.builtin.copy:
    src: "{{ postgresql_config_directory }}/postgresql.conf"
    dest: "{{ postgresql_config_directory }}/postgresql.conf.{{ ansible_date_time.iso8601_basic_short }}.bak"
    remote_src: true
    owner: postgres
    group: postgres
    mode: '0600'
  when: pg_data_check.stat.exists

- name: Deploy postgresql.conf from template
  ansible.builtin.template:
    src: postgresql.conf.j2
    dest: "{{ postgresql_config_directory }}/postgresql.conf"
    owner: postgres
    group: postgres
    mode: '0600'
    validate: "{{ postgresql_bin_path }}/postgres -D {{ postgresql_data_directory }} -C config_file=%s"
    backup: true
  notify: reload postgresql

- name: Backup existing pg_hba.conf
  ansible.builtin.copy:
    src: "{{ postgresql_config_directory }}/pg_hba.conf"
    dest: "{{ postgresql_config_directory }}/pg_hba.conf.{{ ansible_date_time.iso8601_basic_short }}.bak"
    remote_src: true
    owner: postgres
    group: postgres
    mode: '0600'
  when: pg_data_check.stat.exists

- name: Deploy pg_hba.conf from template
  ansible.builtin.template:
    src: pg_hba.conf.j2
    dest: "{{ postgresql_config_directory }}/pg_hba.conf"
    owner: postgres
    group: postgres
    mode: '0600'
    backup: true
  notify: reload postgresql

- name: Deploy pg_ident.conf from template
  ansible.builtin.template:
    src: pg_ident.conf.j2
    dest: "{{ postgresql_config_directory }}/pg_ident.conf"
    owner: postgres
    group: postgres
    mode: '0600'
    backup: true
  notify: reload postgresql

- name: Create SSL certificate directory
  ansible.builtin.file:
    path: "{{ postgresql_ssl_cert_directory }}"
    state: directory
    owner: postgres
    group: postgres
    mode: '0700'
  when: postgresql_ssl_enabled

- name: Generate self-signed SSL certificate (if not provided)
  when:
    - postgresql_ssl_enabled
    - postgresql_ssl_generate_self_signed
  block:
    - name: Check if SSL certificate exists
      ansible.builtin.stat:
        path: "{{ postgresql_ssl_cert_file }}"
      register: ssl_cert_check

    - name: Generate self-signed certificate
      ansible.builtin.command: >
        openssl req -new -x509 -days 365 -nodes -text
        -out {{ postgresql_ssl_cert_file }}
        -keyout {{ postgresql_ssl_key_file }}
        -subj "/C=US/ST=State/L=City/O=FourthEstate/CN={{ ansible_fqdn }}"
      when: not ssl_cert_check.stat.exists
      notify: reload postgresql

    - name: Set SSL certificate permissions
      ansible.builtin.file:
        path: "{{ item }}"
        owner: postgres
        group: postgres
        mode: '0600'
      loop:
        - "{{ postgresql_ssl_cert_file }}"
        - "{{ postgresql_ssl_key_file }}"

- name: Copy SSL certificates (if provided)
  when:
    - postgresql_ssl_enabled
    - not postgresql_ssl_generate_self_signed
    - postgresql_ssl_cert_content is defined
  block:
    - name: Copy SSL certificate
      ansible.builtin.copy:
        content: "{{ postgresql_ssl_cert_content }}"
        dest: "{{ postgresql_ssl_cert_file }}"
        owner: postgres
        group: postgres
        mode: '0600'
      notify: reload postgresql
      no_log: true

    - name: Copy SSL key
      ansible.builtin.copy:
        content: "{{ postgresql_ssl_key_content }}"
        dest: "{{ postgresql_ssl_key_file }}"
        owner: postgres
        group: postgres
        mode: '0600'
      notify: reload postgresql
      no_log: true

    - name: Copy SSL CA certificate
      ansible.builtin.copy:
        content: "{{ postgresql_ssl_ca_content }}"
        dest: "{{ postgresql_ssl_ca_file }}"
        owner: postgres
        group: postgres
        mode: '0600'
      when: postgresql_ssl_ca_content is defined
      notify: reload postgresql
      no_log: true

- name: Create recovery.conf for PostgreSQL < 12 (if needed)
  ansible.builtin.template:
    src: recovery.conf.j2
    dest: "{{ postgresql_data_directory }}/recovery.conf"
    owner: postgres
    group: postgres
    mode: '0600'
  when:
    - postgresql_version | int < 12
    - postgresql_recovery_mode is defined
    - postgresql_recovery_mode
  notify: restart postgresql

- name: Configure automatic failover with recovery.signal (PostgreSQL 12+)
  ansible.builtin.file:
    path: "{{ postgresql_data_directory }}/recovery.signal"
    state: touch
    owner: postgres
    group: postgres
    mode: '0600'
  when:
    - postgresql_version | int >= 12
    - postgresql_recovery_mode is defined
    - postgresql_recovery_mode
  notify: restart postgresql

- name: Create custom configuration directory
  ansible.builtin.file:
    path: "{{ postgresql_config_directory }}/conf.d"
    state: directory
    owner: postgres
    group: postgres
    mode: '0755'

- name: Deploy custom configuration snippets
  ansible.builtin.template:
    src: custom_config.conf.j2
    dest: "{{ postgresql_config_directory }}/conf.d/{{ item.key }}.conf"
    owner: postgres
    group: postgres
    mode: '0600'
  loop: "{{ postgresql_custom_configs | dict2items }}"
  when: postgresql_custom_configs is defined
  notify: reload postgresql

- name: Configure pgAudit extension
  ansible.builtin.template:
    src: pgaudit.conf.j2
    dest: "{{ postgresql_config_directory }}/conf.d/pgaudit.conf"
    owner: postgres
    group: postgres
    mode: '0600'
  when: postgresql_pgaudit_enabled
  notify: reload postgresql

- name: Configure pg_stat_statements extension
  ansible.builtin.template:
    src: pg_stat_statements.conf.j2
    dest: "{{ postgresql_config_directory }}/conf.d/pg_stat_statements.conf"
    owner: postgres
    group: postgres
    mode: '0600'
  when: postgresql_pg_stat_statements_enabled
  notify: reload postgresql

- name: Create PostgreSQL database users
  community.postgresql.postgresql_user:
    name: "{{ item.name }}"
    password: "{{ item.password | default(omit) }}"
    role_attr_flags: "{{ item.role_attr_flags | default(omit) }}"
    encrypted: true
    state: "{{ item.state | default('present') }}"
    login_host: localhost
    login_user: postgres
    port: "{{ postgresql_port }}"
  loop: "{{ postgresql_users }}"
  when: postgresql_users is defined
  no_log: true
  become: true
  become_user: postgres

- name: Create PostgreSQL databases
  community.postgresql.postgresql_db:
    name: "{{ item.name }}"
    owner: "{{ item.owner | default('postgres') }}"
    encoding: "{{ item.encoding | default(postgresql_encoding) }}"
    lc_collate: "{{ item.lc_collate | default(postgresql_locale) }}"
    lc_ctype: "{{ item.lc_ctype | default(postgresql_locale) }}"
    template: "{{ item.template | default('template0') }}"
    state: "{{ item.state | default('present') }}"
    login_host: localhost
    login_user: postgres
    port: "{{ postgresql_port }}"
  loop: "{{ postgresql_databases }}"
  when: postgresql_databases is defined
  become: true
  become_user: postgres

- name: Enable PostgreSQL extensions
  community.postgresql.postgresql_ext:
    name: "{{ item.name }}"
    db: "{{ item.database }}"
    schema: "{{ item.schema | default('public') }}"
    state: "{{ item.state | default('present') }}"
    login_host: localhost
    login_user: postgres
    port: "{{ postgresql_port }}"
  loop: "{{ postgresql_extensions }}"
  when: postgresql_extensions is defined
  become: true
  become_user: postgres

- name: Grant database privileges
  community.postgresql.postgresql_privs:
    database: "{{ item.database }}"
    roles: "{{ item.roles }}"
    type: "{{ item.type | default('database') }}"
    privs: "{{ item.privs }}"
    objs: "{{ item.objs | default(omit) }}"
    schema: "{{ item.schema | default(omit) }}"
    grant_option: "{{ item.grant_option | default(false) }}"
    state: "{{ item.state | default('present') }}"
    login_host: localhost
    login_user: postgres
    port: "{{ postgresql_port }}"
  loop: "{{ postgresql_privileges }}"
  when: postgresql_privileges is defined
  become: true
  become_user: postgres

- name: Validate PostgreSQL configuration
  ansible.builtin.command: >
    {{ postgresql_bin_path }}/postgres
    -D {{ postgresql_data_directory }}
    -C config_file
  become: true
  become_user: postgres
  changed_when: false
  register: pg_config_validate

- name: Display configuration summary
  ansible.builtin.debug:
    msg:
      - "PostgreSQL {{ postgresql_version }} configuration completed"
      - "SSL Enabled: {{ postgresql_ssl_enabled }}"
      - "Max Connections: {{ postgresql_max_connections }}"
      - "Shared Buffers: {{ postgresql_shared_buffers }}"
      - "pgAudit Enabled: {{ postgresql_pgaudit_enabled }}"
      - "Configuration validated successfully"
