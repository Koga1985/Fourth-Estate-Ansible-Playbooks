---
- name: Create/Update identity-based security rules
  paloaltonetworks.panos.panos_security_rule:
    rule_name: "{{ item.rule_name }}"
    rulebase: "{{ 'pre-rulebase' if pa_use_panorama | bool else omit }}"
    device_group: "{{ device_group if pa_use_panorama | bool else omit }}"
    vsys: "{{ vsys if not (pa_use_panorama | bool) else omit }}"
    source_user: "{{ item.source_user | default(['any']) }}"
    source_zone: "{{ item.from_zones | default(['any']) }}"
    destination_zone: "{{ item.to_zones | default(['any']) }}"
    application: "{{ item.application | default(['any']) }}"
    service: "{{ item.service | default(['application-default']) }}"
    action: "{{ item.action | default('allow') }}"
    log_setting: "{{ item.log_setting | default(omit) }}"
    state: "present"
  loop: "{{ identity_rules | default([]) }}"
  loop_control: { label: "{{ item.rule_name }}" }
