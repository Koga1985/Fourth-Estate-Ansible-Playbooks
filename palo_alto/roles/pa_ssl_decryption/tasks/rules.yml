---
- name: Create/Update Decryption Rules
  vars:
    _act: >-
      {{
        (item.action | default('decrypt')) if (decryption_enforce | default(false)) 
        else 'no-decrypt' if (item.action | default('decrypt')) == 'decrypt' else item.action | default('no-decrypt')
      }}
  paloaltonetworks.panos.panos_decryption_rule:
    name: "{{ item.name }}"
    from_zone: "{{ item.from_zones | default(['any']) }}"
    to_zone: "{{ item.to_zones | default(['any']) }}"
    source_ip: "{{ item.source | default(['any']) }}"
    destination_ip: "{{ item.destination | default(['any']) }}"
    service: "{{ item.services | default(['any']) }}"
    category: "{{ item.categories | default(['any']) }}"
    action: "{{ _act }}"
    decryption_profile: "{{ item.profile | default(omit) }}"
    device_group: "{{ device_group if pa_use_panorama | bool else omit }}"
    vsys: "{{ vsys if not (pa_use_panorama | bool) else omit }}"
    state: "present"
  loop: "{{ decryption_rules | default([]) }}"
  loop_control: { label: "{{ item.name }} ({{ _act }})" }
