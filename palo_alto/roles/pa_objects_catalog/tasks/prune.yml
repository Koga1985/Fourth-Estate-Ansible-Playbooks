---
- name: Gather address objects
  paloaltonetworks.panos.panos_object_facts:
    object_type: "addresses"
    device_group: "{{ device_group if pa_use_panorama | bool else omit }}"
    vsys: "{{ vsys if not (pa_use_panorama | bool) else omit }}"
  register: _addrfacts

- name: Gather service objects
  paloaltonetworks.panos.panos_object_facts:
    object_type: "services"
    device_group: "{{ device_group if pa_use_panorama | bool else omit }}"
    vsys: "{{ vsys if not (pa_use_panorama | bool) else omit }}"
  register: _svcfacts

- name: Compute stale lists
  ansible.builtin.set_fact:
    _desired_addr: "{{ (address_objects | default([])) | map(attribute='name') | list }}"
    _desired_svc: "{{ (service_objects | default([])) | map(attribute='name') | list }}"
    _existing_addr: "{{ (_addrfacts.objects | default([])) | map(attribute='name') | list }}"
    _existing_svc: "{{ (_svcfacts.objects | default([])) | map(attribute='name') | list }}"
    _stale_addr: "{{ _existing_addr | difference(_desired_addr + prune.protected_names) }}"
    _stale_svc: "{{ _existing_svc | difference(_desired_svc + prune.protected_names) }}"

- name: Write previews
  ansible.builtin.copy:
    dest: "{{ artifacts_dir }}/objects_prune_preview.txt"
    mode: "0644"
    content: |
      Stale addresses:
      {% for n in _stale_addr %}- {{ n }}
      {% endfor %}
      Stale services:
      {% for n in _stale_svc %}- {{ n }}
      {% endfor %}

- name: Stop if dry-run or deletions not allowed
  when: prune.dry_run | default(true) | bool or not (prune.allow_delete | default(false) | bool)
  ansible.builtin.debug:
    msg: "Dry-run or deletion not allowed. Preview written to {{ artifacts_dir }}/objects_prune_preview.txt"

- name: Delete stale address objects
  when: not (prune.dry_run | default(true) | bool) and (prune.allow_delete | default(false) | bool)
  paloaltonetworks.panos.panos_address_object:
    name: "{{ item }}"
    state: absent
    device_group: "{{ device_group if pa_use_panorama | bool else omit }}"
    vsys: "{{ vsys if not (pa_use_panorama | bool) else omit }}"
  loop: "{{ _stale_addr }}"

- name: Delete stale service objects
  when: not (prune.dry_run | default(true) | bool) and (prune.allow_delete | default(false) | bool)
  paloaltonetworks.panos.panos_service_object:
    name: "{{ item }}"
    state: absent
    device_group: "{{ device_group if pa_use_panorama | bool else omit }}"
    vsys: "{{ vsys if not (pa_use_panorama | bool) else omit }}"
  loop: "{{ _stale_svc }}"
