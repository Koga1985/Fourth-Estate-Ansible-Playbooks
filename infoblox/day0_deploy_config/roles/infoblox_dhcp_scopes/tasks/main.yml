---
- name: Validate Infoblox connection vars
  ansible.builtin.assert:
    that:
      - nios_host | length > 0
      - nios_username | length > 0
      - nios_password | length > 0
    fail_msg: "Set nios_host / nios_username / nios_password."

- name: Defaults
  ansible.builtin.set_fact:
    nios_validate_certs: "{{ nios_validate_certs | default(false) }}"
    nios_wapi_version: "{{ nios_wapi_version | default('v2.12') }}"
    network_view: "{{ network_view | default('default') }}"
    dhcp_networks: "{{ dhcp_networks | default([]) }}"
    dhcp_ranges: "{{ dhcp_ranges | default([]) }}"
    artifact_dir: "{{ artifact_dir | default('/tmp/infoblox-dhcp-scopes') }}"

- name: Ensure artifact directory
  ansible.builtin.file:
    path: "{{ artifact_dir }}"
    state: directory
    mode: "0755"

- name: Build WAPI base & creds (for lease timers / fallback)
  ansible.builtin.set_fact:
    _wapi_base: "https://{{ nios_host }}/wapi/{{ nios_wapi_version }}"
    _creds:
      http_user: "{{ nios_username }}"
      http_password: "{{ nios_password }}"
      force_basic_auth: true
      validate_certs: "{{ nios_validate_certs }}"

- name: Ensure IPv4 networks exist and set options
  infoblox.nios_modules.nios_network:
    network: "{{ item.cidr }}"
    network_view: "{{ item.network_view | default(network_view) }}"
    comment: "{{ item.comment | default(omit) }}"
    options: >-
      {{
        (item.options | default([])) + (
          item.routers is defined
            | ternary([{'name': 'routers', 'value': (item.routers | join(','))}], [])
        ) + (
          item.domain_name is defined
            | ternary([{'name': 'domain-name', 'value': item.domain_name}], [])
        ) + (
          item.dns_servers is defined
            | ternary([{'name': 'domain-name-servers', 'value': (item.dns_servers | join(','))}], [])
        )
      }}
    extattrs: "{{ item.extattrs | default(omit) }}"
    state: present
  loop: "{{ dhcp_networks }}"
  loop_control: { label: "{{ item.cidr }}" }

- name: Apply network lease_time via WAPI (best-effort)
  when: item.lease_time is defined
  vars:
    _view: "{{ item.network_view | default(network_view) }}"
  block:
    - name: Lookup network ref
      ansible.builtin.uri:
        url: "{{ _wapi_base }}/network"
        method: GET
        return_content: true
        status_code: [200]
        params:
          _return_as_object: 1
          network_view: "{{ _view }}"
          network: "{{ item.cidr }}"
          "_return_fields+": "network,network_view,_ref,lease_time"
        user: "{{ nios_username }}"
        password: "{{ nios_password }}"
        force_basic_auth: true
        validate_certs: "{{ nios_validate_certs }}"
      register: _net_get

    - name: PUT lease_time on network
      when: (_net_get.json.result | default([])) | length > 0
      ansible.builtin.uri:
        url: "{{ _wapi_base }}/{{ _net_get.json.result[0]._ref }}"
        method: PUT
        headers: { Content-Type: "application/json" }
        body_format: json
        body: { lease_time: "{{ item.lease_time }}" }
        status_code: [200,400]
        user: "{{ nios_username }}"
        password: "{{ nios_password }}"
        force_basic_auth: true
        validate_certs: "{{ nios_validate_certs }}"
      register: _net_put
      failed_when: false
  loop: "{{ dhcp_networks }}"
  loop_control: { label: "{{ item.cidr }} (lease_time)" }

- name: Ensure IPv4 ranges exist and set options
  infoblox.nios_modules.nios_range:
    start_addr: "{{ item.start }}"
    end_addr: "{{ item.end }}"
    network_view: "{{ item.network_view | default(network_view) }}"
    comment: "{{ item.comment | default(omit) }}"
    network: "{{ item.network | default(omit) }}"
    options: >-
      {{
        (item.options | default([])) + (
          item.routers is defined
            | ternary([{'name': 'routers', 'value': (item.routers | join(','))}], [])
        ) + (
          item.domain_name is defined
            | ternary([{'name': 'domain-name', 'value': item.domain_name}], [])
        ) + (
          item.dns_servers is defined
            | ternary([{'name': 'domain-name-servers', 'value': (item.dns_servers | join(','))}], [])
        )
      }}
    extattrs: "{{ item.extattrs | default(omit) }}"
    state: present
  loop: "{{ dhcp_ranges }}"
  loop_control: { label: "{{ item.start }}-{{ item.end }}" }

- name: Apply range lease_time via WAPI (best-effort)
  when: item.lease_time is defined
  block:
    - name: Lookup range ref
      ansible.builtin.uri:
        url: "{{ _wapi_base }}/range"
        method: GET
        return_content: true
        status_code: [200]
        params:
          _return_as_object: 1
          start_addr: "{{ item.start }}"
          end_addr: "{{ item.end }}"
          "_return_fields+": "start_addr,end_addr,_ref,lease_time"
        user: "{{ nios_username }}"
        password: "{{ nios_password }}"
        force_basic_auth: true
        validate_certs: "{{ nios_validate_certs }}"
      register: _range_get

    - name: PUT lease_time on range
      when: (_range_get.json.result | default([])) | length > 0
      ansible.builtin.uri:
        url: "{{ _wapi_base }}/{{ _range_get.json.result[0]._ref }}"
        method: PUT
        headers: { Content-Type: "application/json" }
        body_format: json
        body: { lease_time: "{{ item.lease_time }}" }
        status_code: [200,400]
        user: "{{ nios_username }}"
        password: "{{ nios_password }}"
        force_basic_auth: true
        validate_certs: "{{ nios_validate_certs }}"
      register: _range_put
      failed_when: false
  loop: "{{ dhcp_ranges }}"
  loop_control: { label: "{{ item.start }}-{{ item.end }} (lease_time)" }

- name: Save summary artifact
  ansible.builtin.copy:
    dest: "{{ artifact_dir }}/dhcp_scopes_summary.json"
    mode: "0644"
    content: >-
      {{
        {
          "networks_count": (dhcp_networks | length),
          "ranges_count": (dhcp_ranges | length),
          "note": "Options applied via modules; lease_time via WAPI best-effort."
        } | to_nice_json
      }}

- name: Done
  ansible.builtin.debug:
    msg:
      - "Managed {{ dhcp_networks | length }} networks and {{ dhcp_ranges | length }} ranges"
      - "Artifact: {{ artifact_dir }}/dhcp_scopes_summary.json"
