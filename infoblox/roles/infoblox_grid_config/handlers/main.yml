---
# handlers file for infoblox_grid_config

- name: Restart Grid services
  infoblox.nios_modules.nios_restart:
    restart_option: "RESTART_IF_NEEDED"
    provider:
      host: "{{ infoblox_grid_master }}"
      username: "{{ infoblox_username }}"
      password: "{{ infoblox_password }}"
      wapi_version: "{{ infoblox_wapi_version }}"
      validate_certs: "{{ infoblox_validate_certs }}"
  listen: "restart infoblox"

- name: Synchronize Grid database
  infoblox.nios_modules.nios_grid_sync:
    sync_option: "SYNC_ALL"
    provider:
      host: "{{ infoblox_grid_master }}"
      username: "{{ infoblox_username }}"
      password: "{{ infoblox_password }}"
      wapi_version: "{{ infoblox_wapi_version }}"
      validate_certs: "{{ infoblox_validate_certs }}"
  listen: "sync grid"

- name: Backup Grid configuration
  infoblox.nios_modules.nios_backup:
    backup_type: "FORCED"
    provider:
      host: "{{ infoblox_grid_master }}"
      username: "{{ infoblox_username }}"
      password: "{{ infoblox_password }}"
      wapi_version: "{{ infoblox_wapi_version }}"
      validate_certs: "{{ infoblox_validate_certs }}"
  listen: "backup grid"

- name: Send notification email
  community.general.mail:
    host: "{{ infoblox_smtp_server }}"
    port: "{{ infoblox_smtp_port }}"
    username: "{{ infoblox_smtp_username | default(omit) }}"
    password: "{{ infoblox_smtp_password | default(omit) }}"
    from: "{{ infoblox_smtp_from_address }}"
    to: "{{ infoblox_notification_email | default('netops@example.com') }}"
    subject: "Infoblox Grid Configuration Changed"
    body: "Infoblox Grid configuration has been updated on {{ infoblox_grid_name }}"
  listen: "notify grid change"
  when: infoblox_configure_smtp | bool
