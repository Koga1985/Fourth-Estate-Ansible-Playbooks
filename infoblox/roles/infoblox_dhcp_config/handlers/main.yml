---
# handlers file for infoblox_dhcp_config

- name: Restart DHCP service
  infoblox.nios_modules.nios_restart:
    restart_option: "RESTART_DHCP"
    provider:
      host: "{{ infoblox_grid_master }}"
      username: "{{ infoblox_username }}"
      password: "{{ infoblox_password }}"
      wapi_version: "{{ infoblox_wapi_version }}"
      validate_certs: "{{ infoblox_validate_certs }}"
  listen: "restart dhcp"

- name: Synchronize DHCP leases
  infoblox.nios_modules.nios_dhcp_lease_sync:
    sync_option: "SYNC_ALL_MEMBERS"
    provider:
      host: "{{ infoblox_grid_master }}"
      username: "{{ infoblox_username }}"
      password: "{{ infoblox_password }}"
      wapi_version: "{{ infoblox_wapi_version }}"
      validate_certs: "{{ infoblox_validate_certs }}"
  listen: "sync dhcp leases"

- name: Clear DHCP lease cache
  infoblox.nios_modules.nios_dhcp_lease_clear:
    clear_option: "CLEAR_EXPIRED"
    provider:
      host: "{{ infoblox_grid_master }}"
      username: "{{ infoblox_username }}"
      password: "{{ infoblox_password }}"
      wapi_version: "{{ infoblox_wapi_version }}"
      validate_certs: "{{ infoblox_validate_certs }}"
  listen: "clear dhcp leases"

- name: Test DHCP failover
  infoblox.nios_modules.nios_dhcp_failover_test:
    failover_association: "{{ item.name }}"
    provider:
      host: "{{ infoblox_grid_master }}"
      username: "{{ infoblox_username }}"
      password: "{{ infoblox_password }}"
      wapi_version: "{{ infoblox_wapi_version }}"
      validate_certs: "{{ infoblox_validate_certs }}"
  loop: "{{ infoblox_dhcp_failover_pairs }}"
  when: infoblox_dhcp_failover_pairs is defined
  listen: "test dhcp failover"

- name: Backup DHCP configuration
  infoblox.nios_modules.nios_backup:
    backup_type: "DHCP_CONFIG"
    provider:
      host: "{{ infoblox_grid_master }}"
      username: "{{ infoblox_username }}"
      password: "{{ infoblox_password }}"
      wapi_version: "{{ infoblox_wapi_version }}"
      validate_certs: "{{ infoblox_validate_certs }}"
  listen: "backup dhcp"
